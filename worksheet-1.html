<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matrix TSL - Flow Control System Maintenance</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="assets/icons/matrix-icon.ico">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="worksheet-core.js"></script>
  <script src="worksheet-tracking.js"></script>
</head>
<body>
  <!-- Navigation -->
  <nav class="main-navigation">
    <div class="nav-container">
      <div class="nav-logo">
        <img src="assets/matrix-logo.png" alt="Matrix Logo">
      </div>
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item">
          <a href="#" onclick="window.location='index.html'" class="nav-link">
            <i class="fas fa-home"></i> HOME
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='cp0539-worksheets.html'" class="nav-link active">
            <i class="fas fa-cogs"></i> CP0539
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='cp6773-worksheets.html'" class="nav-link">
            <i class="fas fa-exclamation-triangle"></i> CP6773
          </a>
        </li>
        
        <li class="nav-item">
          <a href="#" onclick="window.location='tracking-dashboard.html'" class="nav-link">
            <i class="fas fa-chart-line"></i> PROGRESS
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='about.html'" class="nav-link">
            <i class="fas fa-info-circle"></i> ABOUT
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="worksheet-box">
    <!-- Integrated Worksheet Header -->
    <div class="worksheet-header">
      <div class="worksheet-header-content">
        <div class="worksheet-header-left">
          <button class="worksheet-nav-btn worksheet-back-btn" onclick="window.location.href='cp0539-worksheets.html'">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Worksheets</span>
          </button>
        </div>
        <div class="worksheet-header-center">
          <h1 class="worksheet-title">Worksheet 1 - Flow Control System Maintenance</h1>
        </div>
        <div class="worksheet-header-right">
          <button class="worksheet-nav-btn worksheet-next-btn" onclick="window.location.href='worksheet-2.html'">
            <span>Next Worksheet</span>
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
    <!-- Introduction Section -->
    <div class="worksheet-section introduction-section">
      <h2 class="section-header"><i class="fas fa-info-circle"></i> 1. Introduction</h2>
      <div class="worksheet-content">
        <div class="introduction-content-wrapper">
          <div class="introduction-text">
            <p>The system you have in front of you is a Closed-Loop Flow Control system, meaning it continuously adjusts itself to meet a desired target, called the setpoint. It does this by using feedback from sensors to control devices like pumps and valves, keeping the system accurate and stable even if conditions change.</p>
          </div>
          <div class="introduction-image">
            <div class="system-diagram">
              <img src="assets/cad.png" alt="CAD Model - Flow Control System">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Over To You Section -->
    <div class="worksheet-section over-to-you-section">
      <h2 class="section-header"><i class="fas fa-hands-helping"></i> 2. Over To You</h2>
      <div class="worksheet-content">
        <p><strong>Select Start and observe the system start up. Once the pump is running you should see water flow through the flow gauge. Ensure the hand valve is in the open position (the handle should be in line with the piping).</strong></p>
        
        <div class="steps-container">
          <div class="step-card" data-step="1">
            <div class="step-number">1</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Set a Flow Rate</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Enter a target flow rate on the HMI. You can adjust in increments of 20 using the +/- buttons.</p>
            </div>
          </div>
          
          <div class="step-card" data-step="2">
            <div class="step-number">2</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Observe Feedback</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Watch the flow sensor reading on the HMI and compare it to the setpoint.</p>
            </div>
          </div>
          
          <div class="step-card" data-step="3">
            <div class="step-number">3</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Watch the System Adjust</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Note how the pump speed and valve position change to bring the flow rate to the setpoint.</p>
            </div>
          </div>
          
          <div class="step-card" data-step="4">
            <div class="step-number">4</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Introduce a Disturbance</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Temporarily restrict the flow (e.g., partially close the shut-off valve) and observe how the system reacts to maintain the flow rate.</p>
            </div>
          </div>
        </div>
      </div>
    </div>



    <!-- So What Section -->
    <div class="worksheet-section so-what-section">
      <h2 class="section-header"><i class="fas fa-lightbulb"></i> 3. So What?</h2>
      <div class="so-what-content">
        <p>This is part of a control system, which automates processes in Industry. At the heart of this system is a PLC (Programmable Logic Controller), a computer that makes real-time decisions based on sensor data. The HMI (Human-Machine Interface) allows you to monitor and adjust settings easily.</p>
        
        <p>Restricting the hand valve reduced flow, which the sensor detected and sent to the PLC. The PLC increased pump speed and adjusted the valve to restore flow, showing automatic correction. Rapid valve changes caused oscillations, highlighting the need for gradual adjustments. Fully closing the valve stopped flow; the PLC responded by maxing the pump and opening the valve, but no water moved. This demonstrates risks like pressure buildup and why managing flow restrictions is critical.</p>
        
        <div class="key-point">
          <i class="fas fa-lightbulb"></i>
          <div>
            <strong>Closed-loop systems continuously adjust using sensor feedback to maintain accuracy.</strong>
          </div>
        </div>
        
        <div class="key-point">
          <i class="fas fa-lightbulb"></i>
          <div>
            <strong>PID control ensures stability by fine-tuning pump speed and valve position.</strong>
          </div>
        </div>
        
        <div class="key-point">
          <i class="fas fa-lightbulb"></i>
          <div>
            <strong>The pump and proportional valve work together to match the setpoint, even with disturbances.</strong>
          </div>
        </div>
        
        <div class="key-point">
          <i class="fas fa-lightbulb"></i>
          <div>
            <strong>Understanding this process helps you troubleshoot issues and optimize system performance effectively.</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Questions Section -->
    <div class="worksheet-section questions-section">
      <h2 class="section-header"><i class="fas fa-question-circle"></i> 4. Questions & Answers</h2>
      <div class="questions-content">
        <div class="instructions">
          <strong>Instructions:</strong> Answer each question based on your observations and understanding of the flow control system. Your answers will be saved automatically.
        </div>
        
        <div class="question-item" data-question="1">
          <h4>Question 1: What is the purpose of a closed-loop flow control system?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-1" value="A" class="option-radio">
              <span class="option-text">A) To continuously adjust flow using sensor feedback to meet a setpoint, maintaining accuracy and stability even if conditions change</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="B" class="option-radio">
              <span class="option-text">B) To operate the system manually at all times</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="C" class="option-radio">
              <span class="option-text">C) To increase the system's energy consumption</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="D" class="option-radio">
              <span class="option-text">D) To reduce the need for sensors</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(1)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> A) To continuously adjust flow using sensor feedback to meet a setpoint, maintaining accuracy and stability even if conditions change.
          </div>
        </div>
        <div class="question-item" data-question="2">
          <h4>Question 2: What must you check before starting the system?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-2" value="A" class="option-radio">
              <span class="option-text">A) Ensure the hand valve is in the open position, with the handle in line with the piping</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="B" class="option-radio">
              <span class="option-text">B) Ensure the pump is off</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="C" class="option-radio">
              <span class="option-text">C) Ensure the flow sensor is disconnected</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="D" class="option-radio">
              <span class="option-text">D) Ensure the valve is closed</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(2)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> C) Ensure the flow sensor is disconnected.
          </div>
        </div>
        <div class="question-item" data-question="3">
          <h4>Question 3: What happens when you restrict the flow using the hand valve?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-3" value="A" class="option-radio">
              <span class="option-text">A) The flow drops, the sensor detects this and sends data to the PLC, which increases pump speed and adjusts the valve to restore flow</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="B" class="option-radio">
              <span class="option-text">B) The system shuts down immediately</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="C" class="option-radio">
              <span class="option-text">C) The valve closes further</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="D" class="option-radio">
              <span class="option-text">D) The pump turns off</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(3)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> B) The system shuts down immediately.
          </div>
        </div>
        <div class="question-item" data-question="4">
          <h4>Question 4: What role does the PLC play in the system?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-4" value="A" class="option-radio">
              <span class="option-text">A) The PLC is a computer that makes real-time decisions based on sensor data to control devices like pumps and valves</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-4" value="B" class="option-radio">
              <span class="option-text">B) The PLC only displays data on the HMI</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-4" value="C" class="option-radio">
              <span class="option-text">C) The PLC is used for manual control only</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-4" value="D" class="option-radio">
              <span class="option-text">D) The PLC is not involved in control</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(4)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> D) The PLC is not involved in control.
          </div>
        </div>
        <div class="question-item" data-question="5">
          <h4>Question 5: Why should you avoid making rapid changes to the valve?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-5" value="A" class="option-radio">
              <span class="option-text">A) Rapid changes can cause oscillations in flow, making the system unstable; gradual adjustments help maintain smooth control</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-5" value="B" class="option-radio">
              <span class="option-text">B) Rapid changes save energy</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-5" value="C" class="option-radio">
              <span class="option-text">C) Rapid changes are required for safety</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-5" value="D" class="option-radio">
              <span class="option-text">D) Rapid changes increase system accuracy</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(5)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> B) Rapid changes save energy.
          </div>
        </div>
      </div>
    </div>

    <!-- Interactive PID Simulation -->
    <div class="simulation-section">
      <h2 class="section-header"><i class="fas fa-chart-line"></i> 5. Interactive PID Control System</h2>
      
      <!-- Educational Introduction -->
      <div class="pid-education">
        <div class="education-card">
          <h3><i class="fas fa-lightbulb"></i> Understanding PID Control</h3>
          <p><strong>PID (Proportional-Integral-Derivative)</strong> control is the most common control algorithm used in industrial automation. It continuously calculates an error value and applies a correction based on proportional, integral, and derivative terms.</p>
          <p><strong>ðŸŽ¯ Conservative Tuning:</strong> The default values (P=0.8, I=0.15, D=0.05) are carefully selected to demonstrate stable, well-damped control with minimal overshoot and reliable settling. These very conservative values ensure the system stabilizes properly.</p>
          
          <div class="pid-components">
            <div class="component">
              <h4><i class="fas fa-percentage"></i> Proportional (P = 0.8)</h4>
              <p>Provides gentle immediate response to errors. This very conservative value ensures stable, well-damped control with minimal overshoot.</p>
            </div>
            <div class="component">
              <h4><i class="fas fa-plus-circle"></i> Integral (I = 0.15)</h4>
              <p>Eliminates steady-state error very gradually. This very low value prevents any oscillations while slowly correcting offset.</p>
            </div>
            <div class="component">
              <h4><i class="fas fa-chart-line"></i> Derivative (D = 0.05)</h4>
              <p>Provides minimal damping to reduce overshoot. This very low value improves stability without any risk of noise amplification.</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- PID Tuning Section -->
      <div id="pid-tuning-container">
        <h3><i class="fas fa-sliders-h"></i> PID Tuning Controls</h3>
        
        <!-- Real-time Parameter Display -->
        <div class="parameter-display">
          <div class="parameter-card">
            <div class="parameter-header">
              <i class="fas fa-bullseye"></i>
              <span>Setpoint</span>
            </div>
            <div class="parameter-value" id="setpoint-display">50.0</div>
            <div class="parameter-unit">%</div>
          </div>
          
          <div class="parameter-card">
            <div class="parameter-header">
              <i class="fas fa-percentage"></i>
              <span>Proportional (P)</span>
            </div>
            <div class="parameter-value" id="p-display">0.8</div>
            <div class="parameter-unit">gain</div>
          </div>
          
          <div class="parameter-card">
            <div class="parameter-header">
              <i class="fas fa-plus-circle"></i>
              <span>Integral (I)</span>
            </div>
            <div class="parameter-value" id="i-display">0.15</div>
            <div class="parameter-unit">gain</div>
          </div>
          
          <div class="parameter-card">
            <div class="parameter-header">
              <i class="fas fa-chart-line"></i>
              <span>Derivative (D)</span>
            </div>
            <div class="parameter-value" id="d-display">0.05</div>
            <div class="parameter-unit">gain</div>
          </div>
        </div>
        
        <!-- Control Sliders -->
        <div class="pid-controls">
          <div class="control-group">
            <label><i class="fas fa-bullseye"></i> Setpoint (%)</label>
            <div class="slider-container">
              <input type="range" id="setpoint-slider" min="0" max="100" value="50" class="modern-slider">
              <div class="slider-track">
                <div class="slider-fill" id="setpoint-fill"></div>
              </div>
            </div>
            <span id="setpoint-value">50</span>
          </div>
          
          <div class="control-group">
            <label><i class="fas fa-percentage"></i> Proportional (P)</label>
            <div class="slider-container">
              <input type="range" id="p-gain-slider" min="0" max="5" step="0.1" value="0.8" class="modern-slider">
              <div class="slider-track">
                <div class="slider-fill" id="p-fill"></div>
              </div>
            </div>
            <span id="p-gain-value">0.8</span>
          </div>
          
          <div class="control-group">
            <label><i class="fas fa-plus-circle"></i> Integral (I)</label>
            <div class="slider-container">
              <input type="range" id="i-gain-slider" min="0" max="2" step="0.01" value="0.15" class="modern-slider">
              <div class="slider-track">
                <div class="slider-fill" id="i-fill"></div>
              </div>
            </div>
            <span id="i-gain-value">0.15</span>
          </div>
          
          <div class="control-group">
            <label><i class="fas fa-chart-line"></i> Derivative (D)</label>
            <div class="slider-container">
              <input type="range" id="d-gain-slider" min="0" max="1" step="0.01" value="0.05" class="modern-slider">
              <div class="slider-track">
                <div class="slider-fill" id="d-fill"></div>
              </div>
            </div>
            <span id="d-gain-value">0.05</span>
          </div>
        </div>
        
        <!-- Control Buttons -->
        <div class="control-buttons">
          <button id="start-simulation-btn" class="btn-primary">
            <i class="fas fa-play"></i> Start Simulation
          </button>
          <button id="reset-pid-btn" class="btn-secondary">
            <i class="fas fa-undo"></i> Reset to Defaults
          </button>
          <button id="add-disturbance-btn" class="btn-warning">
            <i class="fas fa-bolt"></i> Add Disturbance
          </button>
        </div>
        
        <!-- Enhanced Chart Container -->
        <div class="pid-chart-container">
          <div class="chart-header">
            <h4><i class="fas fa-chart-line"></i> System Response</h4>
            <div class="chart-legend">
              <div class="legend-item">
                <div class="legend-color setpoint-color"></div>
                <span>Setpoint</span>
              </div>
              <div class="legend-item">
                <div class="legend-color process-color"></div>
                <span>Process Variable</span>
              </div>
              <div class="legend-item">
                <div class="legend-color error-color"></div>
                <span>Error</span>
              </div>
            </div>
          </div>
          <canvas id="pid-chart" width="800" height="400"></canvas>
        </div>
        
        <!-- Educational Note about Error Values -->
        <div class="educational-note">
          <div class="error-info-header" onclick="toggleErrorInfo()">
            <h5><i class="fas fa-info-circle"></i> Understanding Error Values</h5>
            <i class="fas fa-chevron-down" id="error-info-icon"></i>
          </div>
          <div class="error-info-content" id="error-info-content">
            <p><strong>Error = Setpoint - Process Variable</strong></p>
            <ul>
              <li><strong>Positive Error:</strong> Process Variable is below Setpoint (system needs to increase)</li>
              <li><strong>Negative Error:</strong> Process Variable is above Setpoint (overshoot - system needs to decrease)</li>
              <li><strong>Zero Error:</strong> Process Variable matches Setpoint (perfect control)</li>
            </ul>
            <p><em>Note: Negative error values are normal in PID control and indicate overshoot, which the controller will correct.</em></p>
          </div>
        </div>
      </div>
      
      <!-- System Response Analysis Section -->
      <div id="response-analysis-container">
        <h3><i class="fas fa-analytics"></i> System Response Analysis</h3>
        
        <!-- Real-time Performance Metrics -->
        <div class="response-metrics">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-arrow-up"></i>
            </div>
            <div class="metric-content">
              <h4>Rise Time</h4>
              <p id="rise-time">--</p>
              <small>Time to reach 90% of setpoint</small>
            </div>
          </div>
          
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="metric-content">
              <h4>Settling Time</h4>
              <p id="settling-time">--</p>
              <small>Time to stay within Â±2% of setpoint</small>
            </div>
          </div>
          
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-chart-area"></i>
            </div>
            <div class="metric-content">
              <h4>Overshoot</h4>
              <p id="overshoot">--</p>
              <small>Maximum deviation above setpoint</small>
            </div>
          </div>
          
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-bullseye"></i>
            </div>
            <div class="metric-content">
              <h4>Steady State Error</h4>
              <p id="steady-state-error">--</p>
              <small>Final offset from setpoint</small>
            </div>
          </div>
        </div>
        
        <!-- Educational Tips -->
        <div class="response-tips">
          <h4><i class="fas fa-lightbulb"></i> Tuning Guidelines:</h4>
          <div class="tips-grid">
            <div class="tip-item">
              <div class="tip-icon">
                <i class="fas fa-percentage"></i>
              </div>
              <div class="tip-content">
                <h5>Proportional (P)</h5>
                <ul>
                  <li><strong>Too Low:</strong> Slow response, steady-state error</li>
                  <li><strong>Too High:</strong> Oscillations, overshoot</li>
                  <li><strong>Optimal (0.8):</strong> Stable response with minimal overshoot</li>
                </ul>
              </div>
            </div>
            
            <div class="tip-item">
              <div class="tip-icon">
                <i class="fas fa-plus-circle"></i>
              </div>
              <div class="tip-content">
                <h5>Integral (I)</h5>
                <ul>
                  <li><strong>Too Low:</strong> Persistent steady-state error</li>
                  <li><strong>Too High:</strong> Slow response, oscillations</li>
                  <li><strong>Optimal (0.15):</strong> Eliminates offset without instability</li>
                </ul>
              </div>
            </div>
            
            <div class="tip-item">
              <div class="tip-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="tip-content">
                <h5>Derivative (D)</h5>
                <ul>
                  <li><strong>Too Low:</strong> Overshoot, slow settling</li>
                  <li><strong>Too High:</strong> Noise amplification, instability</li>
                  <li><strong>Optimal (0.05):</strong> Reduces overshoot, improves stability</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- PID Tuning Challenges Section -->
      <div id="challenges-container">
        <h3><i class="fas fa-trophy"></i> Industrial PID Tuning Challenges</h3>
        <div class="challenge-list">
          <div class="challenge-item">
            <div class="challenge-header">
              <div class="challenge-icon">
                <i class="fas fa-rocket"></i>
              </div>
              <div class="challenge-info">
                <h4>Challenge 1: Temperature Control System</h4>
                <p class="challenge-description">Industrial heating system needs fast response to temperature changes. Tune for quick recovery with minimal overshoot.</p>
              </div>
            </div>
            <div class="challenge-details">
              <div class="challenge-params">
                <span><strong>Setpoint:</strong> 75Â°C</span>
                <span><strong>Target:</strong> Rise time < 30s, Overshoot < 3%</span>
              </div>
              <button class="challenge-btn" onclick="loadChallenge(1)">
                <i class="fas fa-play"></i> Load Challenge
              </button>
            </div>
          </div>
          
          <div class="challenge-item">
            <div class="challenge-header">
              <div class="challenge-icon">
                <i class="fas fa-shield-alt"></i>
              </div>
              <div class="challenge-info">
                <h4>Challenge 2: Flow Control with Disturbances</h4>
                <p class="challenge-description">Chemical process flow control system. Must maintain setpoint despite pump variations and valve wear.</p>
              </div>
            </div>
            <div class="challenge-details">
              <div class="challenge-params">
                <span><strong>Setpoint:</strong> 60 L/min</span>
                <span><strong>Target:</strong> Disturbance rejection, stable operation</span>
              </div>
              <button class="challenge-btn" onclick="loadChallenge(2)">
                <i class="fas fa-play"></i> Load Challenge
              </button>
            </div>
          </div>
          
          <div class="challenge-item">
            <div class="challenge-header">
              <div class="challenge-icon">
                <i class="fas fa-balance-scale"></i>
              </div>
              <div class="challenge-info">
                <h4>Challenge 3: Pressure Control (No Overshoot)</h4>
                <p class="challenge-description">Safety-critical pressure control system. Cannot tolerate any overshoot due to safety requirements.</p>
              </div>
            </div>
            <div class="challenge-details">
              <div class="challenge-params">
                <span><strong>Setpoint:</strong> 2.5 bar</span>
                <span><strong>Target:</strong> Zero overshoot, stable operation</span>
              </div>
              <button class="challenge-btn" onclick="loadChallenge(3)">
                <i class="fas fa-play"></i> Load Challenge
              </button>
            </div>
          </div>
          
          <div class="challenge-item">
            <div class="challenge-header">
              <div class="challenge-icon">
                <i class="fas fa-cogs"></i>
              </div>
              <div class="challenge-info">
                <h4>Challenge 4: Level Control System</h4>
                <p class="challenge-description">Tank level control with varying inlet flow rates. Must handle both fast and slow disturbances.</p>
              </div>
            </div>
            <div class="challenge-details">
              <div class="challenge-params">
                <span><strong>Setpoint:</strong> 80% level</span>
                <span><strong>Target:</strong> Adaptive response, minimal oscillation</span>
              </div>
              <button class="challenge-btn" onclick="loadChallenge(4)">
                <i class="fas fa-play"></i> Load Challenge
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



    


  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    // Initialize PID simulation
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Worksheet 1 loaded, initializing PID controls...');
      
      // Check if Chart.js is loaded
      if (typeof Chart === 'undefined') {
        console.error('ERROR: Chart.js is not loaded!');
        alert('Chart.js library failed to load. Please refresh the page.');
        return;
      } else {
        console.log('SUCCESS: Chart.js is loaded');
      }
      
      try {
        initializePIDControls();
        initializeStepTracking();
        loadSavedAnswers();
        console.log('SUCCESS: All initialization completed');
      } catch (error) {
        console.error('ERROR during initialization:', error);
        alert('Error initializing PID controls: ' + error.message);
      }
    });
    
    // PID simulation variables
    let pidChart = null;
    let simulationRunning = false;
    let simulationData = [];
    

    
    // Initialize PID controls
    function initializePIDControls() {
      console.log('Initializing PID controls...');
      
      // Check if all required elements exist
      const requiredElements = [
        'setpoint-slider', 'setpoint-value',
        'p-gain-slider', 'p-gain-value',
        'i-gain-slider', 'i-gain-value',
        'd-gain-slider', 'd-gain-value',
        'start-simulation-btn', 'reset-pid-btn',
        'pid-chart'
      ];
      
      for (const elementId of requiredElements) {
        const element = document.getElementById(elementId);
        if (!element) {
          console.error('ERROR: Required element not found:', elementId);
          alert('Required element not found: ' + elementId);
          return;
        }
      }
      
      console.log('SUCCESS: All required elements found');
      
      // Update slider values and parameter displays
      document.getElementById('setpoint-slider').addEventListener('input', function() {
        const value = this.value;
        document.getElementById('setpoint-value').textContent = value;
        document.getElementById('setpoint-display').textContent = parseFloat(value).toFixed(1);
        updateSliderFill('setpoint-fill', value, 100);
      });
      
      document.getElementById('p-gain-slider').addEventListener('input', function() {
        const value = this.value;
        document.getElementById('p-gain-value').textContent = value;
        document.getElementById('p-display').textContent = parseFloat(value).toFixed(1);
        updateSliderFill('p-fill', value, 5);
      });
      
      document.getElementById('i-gain-slider').addEventListener('input', function() {
        const value = this.value;
        document.getElementById('i-gain-value').textContent = value;
        document.getElementById('i-display').textContent = parseFloat(value).toFixed(2);
        updateSliderFill('i-fill', value, 2);
      });
      
      document.getElementById('d-gain-slider').addEventListener('input', function() {
        const value = this.value;
        document.getElementById('d-gain-value').textContent = value;
        document.getElementById('d-display').textContent = parseFloat(value).toFixed(2);
        updateSliderFill('d-fill', value, 1);
      });
      
      // Start simulation button
      document.getElementById('start-simulation-btn').addEventListener('click', function() {
        if (!simulationRunning) {
          startPIDSimulation();
        } else {
          stopPIDSimulation();
        }
      });
      
      // Reset button
      document.getElementById('reset-pid-btn').addEventListener('click', function() {
        resetPIDDefaults();
      });
      
      // Add disturbance button
      document.getElementById('add-disturbance-btn').addEventListener('click', function() {
        addDisturbance();
      });
      
      // Initialize chart
      initializePIDChart();
      
      // Initialize slider fills
      updateSliderFill('setpoint-fill', 50, 100);
      updateSliderFill('p-fill', 0.8, 5);
      updateSliderFill('i-fill', 0.15, 2);
      updateSliderFill('d-fill', 0.05, 1);
      
      // Initialize error info dropdown as collapsed
      document.getElementById('error-info-content').style.display = 'none';
    }
    
    // Update slider fill visualization
    function updateSliderFill(fillId, value, max) {
      const fillElement = document.getElementById(fillId);
      if (fillElement) {
        const percentage = (value / max) * 100;
        fillElement.style.width = percentage + '%';
      }
    }
    
        // Initialize PID chart
    function initializePIDChart() {
      console.log('Initializing PID chart...');
      try {
        const ctx = document.getElementById('pid-chart').getContext('2d');
        console.log('SUCCESS: Got chart context');
        
        pidChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'Setpoint',
              data: [],
              borderColor: '#FF5722',
              backgroundColor: 'rgba(255, 87, 34, 0.1)',
              borderWidth: 3,
              fill: false,
              tension: 0.2,
              pointRadius: 0,
              pointHoverRadius: 6,
              pointHoverBackgroundColor: '#FF5722',
              pointHoverBorderColor: '#FFFFFF',
              pointHoverBorderWidth: 2
            }, {
              label: 'Process Variable',
              data: [],
              borderColor: '#4CAF50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              borderWidth: 3,
              fill: false,
              tension: 0.2,
              pointRadius: 0,
              pointHoverRadius: 6,
              pointHoverBackgroundColor: '#4CAF50',
              pointHoverBorderColor: '#FFFFFF',
              pointHoverBorderWidth: 2
            }, {
              label: 'Error',
              data: [],
              borderColor: '#FFC107',
              backgroundColor: 'rgba(255, 193, 7, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.2,
              pointRadius: 0,
              pointHoverRadius: 4,
              pointHoverBackgroundColor: '#FFC107',
              pointHoverBorderColor: '#FFFFFF',
              pointHoverBorderWidth: 2
            }]
          },
                  options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            animation: {
              duration: 0
            },
            plugins: {
              legend: {
                display: false // We have our own legend in the header
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                titleColor: '#FFFFFF',
                bodyColor: '#FFFFFF',
                borderColor: '#555',
                borderWidth: 1,
                cornerRadius: 8,
                displayColors: true,
                titleFont: {
                  size: 14,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 13
                },
                padding: 12,
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      label += context.parsed.y.toFixed(2) + '%';
                    }
                    return label;
                  }
                }
              }
            },
                      scales: {
              x: {
                title: {
                  display: true,
                  text: 'Time (seconds)',
                  color: '#CCCCCC',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                ticks: {
                  color: '#CCCCCC',
                  font: {
                    size: 12
                  },
                  maxTicksLimit: 10
                },
                grid: {
                  color: 'rgba(255, 255, 255, 0.05)',
                  drawBorder: false,
                  lineWidth: 1
                },
                border: {
                  color: 'rgba(255, 255, 255, 0.1)'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Value (%)',
                  color: '#CCCCCC',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                min: -25,
                max: 125,
                ticks: {
                  color: '#CCCCCC',
                  font: {
                    size: 12
                  },
                  stepSize: 25,
                  callback: function(value) {
                    return value + '%';
                  }
                },
                grid: {
                  color: 'rgba(255, 255, 255, 0.05)',
                  drawBorder: false,
                  lineWidth: 1,
                  zeroLineColor: 'rgba(255, 255, 255, 0.2)',
                  zeroLineWidth: 2
                },
                border: {
                  color: 'rgba(255, 255, 255, 0.1)'
                }
              }
            },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
      console.log('SUCCESS: PID chart initialized');
    } catch (error) {
      console.error('ERROR: Failed to initialize PID chart:', error);
      alert('Failed to initialize PID chart: ' + error.message);
    }
    }
    
    // Start PID simulation
    function startPIDSimulation() {
      simulationRunning = true;
      document.getElementById('start-simulation-btn').textContent = 'Stop Simulation';
      
      // Clear previous data
      simulationData = [];
      pidChart.data.labels = [];
      pidChart.data.datasets[0].data = [];
      pidChart.data.datasets[1].data = [];
      
      // Reset PID simulation state
      if (simulatePIDResponse.integral) simulatePIDResponse.integral = 0;
      if (simulatePIDResponse.previousError) simulatePIDResponse.previousError = 0;
      if (simulatePIDResponse.previousOutput) simulatePIDResponse.previousOutput = 0;
      
      // Start simulation loop
      let time = 0;
      const interval = setInterval(() => {
        if (!simulationRunning) {
          clearInterval(interval);
          return;
        }
        
        // Get PID parameters
        const setpoint = parseFloat(document.getElementById('setpoint-slider').value);
        const kp = parseFloat(document.getElementById('p-gain-slider').value);
        const ki = parseFloat(document.getElementById('i-gain-slider').value);
        const kd = parseFloat(document.getElementById('d-gain-slider').value);
        
        // Simple PID simulation
        const processVariable = simulatePIDResponse(setpoint, kp, ki, kd, time);
        
        // Calculate error
        const error = setpoint - processVariable;
        
        // Add data to chart
        pidChart.data.labels.push(time);
        pidChart.data.datasets[0].data.push(setpoint);
        pidChart.data.datasets[1].data.push(processVariable);
        pidChart.data.datasets[2].data.push(error);
        
        // Limit data points
        if (pidChart.data.labels.length > 100) {
          pidChart.data.labels.shift();
          pidChart.data.datasets[0].data.shift();
          pidChart.data.datasets[1].data.shift();
          pidChart.data.datasets[2].data.shift();
        }
        
        pidChart.update('none');
        time++;
        
        // Update metrics every 10 time steps
        if (time % 10 === 0) {
          calculateResponseMetrics();
        }
      }, 100);
    }
    
    // Stop PID simulation
    function stopPIDSimulation() {
      simulationRunning = false;
      document.getElementById('start-simulation-btn').textContent = 'Start Simulation';
    }
    
    // Enhanced PID response simulation
    function simulatePIDResponse(setpoint, kp, ki, kd, time) {
      // Initialize static variables for integral and previous error
      if (!simulatePIDResponse.integral) simulatePIDResponse.integral = 0;
      if (!simulatePIDResponse.previousError) simulatePIDResponse.previousError = 0;
      if (!simulatePIDResponse.previousOutput) simulatePIDResponse.previousOutput = 0;
      
      // Calculate error
      const error = setpoint - simulatePIDResponse.previousOutput;
      
      // PID calculations
      const proportional = kp * error;
      simulatePIDResponse.integral += ki * error * 0.1; // 0.1 is time step
      const derivative = kd * (error - simulatePIDResponse.previousError) / 0.1;
      
      // Calculate output
      let output = proportional + simulatePIDResponse.integral + derivative;
      
      // Add realistic system dynamics (first-order system)
      const tau = 5; // Time constant
      const dt = 0.1; // Time step
      output = simulatePIDResponse.previousOutput + (output - simulatePIDResponse.previousOutput) * (1 - Math.exp(-dt / tau));
      
      // Add some realistic noise and disturbance
      const noise = (Math.random() - 0.5) * 1;
      const slowDisturbance = Math.sin(time * 0.05) * 2; // Slow disturbance
      const stepDisturbance = simulatePIDResponse.disturbance || 0; // Step disturbance
      
      output += noise + slowDisturbance + stepDisturbance;
      
      // Update previous values
      simulatePIDResponse.previousError = error;
      simulatePIDResponse.previousOutput = output;
      
      // Ensure output stays within 0-100 range
      return Math.max(0, Math.min(100, output));
    }
    
    // Reset PID to defaults
    function resetPIDDefaults() {
      document.getElementById('setpoint-slider').value = 50;
      document.getElementById('setpoint-value').textContent = '50';
      document.getElementById('setpoint-display').textContent = '50.0';
      updateSliderFill('setpoint-fill', 50, 100);
      
      document.getElementById('p-gain-slider').value = 0.8;
      document.getElementById('p-gain-value').textContent = '0.8';
      document.getElementById('p-display').textContent = '0.8';
      updateSliderFill('p-fill', 0.8, 5);
      
      document.getElementById('i-gain-slider').value = 0.15;
      document.getElementById('i-gain-value').textContent = '0.15';
      document.getElementById('i-display').textContent = '0.15';
      updateSliderFill('i-fill', 0.15, 2);
      
      document.getElementById('d-gain-slider').value = 0.05;
      document.getElementById('d-gain-value').textContent = '0.05';
      document.getElementById('d-display').textContent = '0.05';
      updateSliderFill('d-fill', 0.05, 1);
      
      // Reset PID simulation state
      if (simulatePIDResponse.integral) simulatePIDResponse.integral = 0;
      if (simulatePIDResponse.previousError) simulatePIDResponse.previousError = 0;
      if (simulatePIDResponse.previousOutput) simulatePIDResponse.previousOutput = 0;
      if (simulatePIDResponse.disturbance) simulatePIDResponse.disturbance = 0;
      
      stopPIDSimulation();
    }
    
    // Toggle error info dropdown
    function toggleErrorInfo() {
      const content = document.getElementById('error-info-content');
      const icon = document.getElementById('error-info-icon');
      
      if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
        content.style.maxHeight = content.scrollHeight + 'px';
      } else {
        content.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
        content.style.maxHeight = '0';
      }
    }
    
    // Initialize step tracking
    function initializeStepTracking() {
      const checkboxes = document.querySelectorAll('.step-complete-checkbox');
      checkboxes.forEach((checkbox, index) => {
        checkbox.addEventListener('change', function() {
          const stepCard = this.closest('.step-card');
          if (this.checked) {
            stepCard.style.borderLeftColor = '#4CAF50';
            stepCard.style.opacity = '0.8';
          } else {
            stepCard.style.borderLeftColor = '#4CAF50';
            stepCard.style.opacity = '1';
          }
          
          // Save step completion
          localStorage.setItem(`worksheet1_step${index + 1}`, this.checked);
        });
        
        // Load saved step completion
        const saved = localStorage.getItem(`worksheet1_step${index + 1}`);
        if (saved === 'true') {
          checkbox.checked = true;
          checkbox.dispatchEvent(new Event('change'));
        }
      });
    }
    
    // Submit answer
    function submitAnswer(questionNumber) {
      const answerInput = document.querySelector(`[data-question="${questionNumber}"]`);
      if (!answerInput) return;
      
      const selectedOption = document.querySelector(`input[name="question-${questionNumber}"]:checked`);
      if (!selectedOption) {
        alert('Please select an answer before submitting.');
        return;
      }
      
      const answer = selectedOption.value;
      
      // Save with enhanced tracking
      worksheetTracker.saveAnswer(1, questionNumber, answer, 'maintenance');
      
      // Define correct answers for worksheet 1
      const correctAnswers = {
        "1": "A",
        "2": "C",
        "3": "B",
        "4": "D",
        "5": "B"
      };
      
      // Apply visual feedback
      const allOptions = answerInput.querySelectorAll('.option-label');
      const correctAnswer = correctAnswers[questionNumber];
      
      allOptions.forEach(option => {
        const radio = option.querySelector('.option-radio');
        const optionValue = radio.value;
        
        if (optionValue === correctAnswer) {
          option.classList.add('correct');
        } else if (optionValue === answer && answer !== correctAnswer) {
          option.classList.add('incorrect');
        }
      });
      
      // Mark question as submitted to disable further interaction
      answerInput.classList.add('submitted');
      
      // Show feedback on button
      const submitBtn = answerInput.querySelector('.submit-question-btn');
      if (submitBtn) {
        const originalText = submitBtn.textContent;
        submitBtn.textContent = answer === correctAnswer ? 'Correct!' : 'Incorrect!';
        submitBtn.style.background = answer === correctAnswer ? '#4CAF50' : '#f44336';
        
        // Add incorrect class for enhanced styling
        if (answer !== correctAnswer) {
          submitBtn.classList.add('incorrect');
        }
        
        setTimeout(() => {
          submitBtn.textContent = originalText;
          submitBtn.style.background = '#4CAF50';
          submitBtn.classList.remove('incorrect');
        }, 2000);
      }
      
      // Show correct answer if available
      const correctAnswerDiv = answerInput.querySelector('.correct-answer');
      if (correctAnswerDiv) {
        correctAnswerDiv.style.display = 'block';
      }
    }

function loadSavedAnswers() {
  // This function is now handled by the tracking system
}
    
    // Add disturbance to simulation
    function addDisturbance() {
      if (!simulationRunning) {
        alert('Please start the simulation first!');
        return;
      }
      
      // Add a step disturbance
      simulatePIDResponse.disturbance = 15;
      setTimeout(() => {
        simulatePIDResponse.disturbance = 0;
      }, 2000);
      
      console.log('Disturbance added to simulation');
    }
    
    // Load PID tuning challenges
    function loadChallenge(challengeNumber) {
      const challenges = {
        1: { 
          setpoint: 75, 
          p: 2.5, 
          i: 0.08, 
          d: 0.15, 
          description: 'Temperature Control System',
          target: 'Rise time < 30s, Overshoot < 3%'
        },
        2: { 
          setpoint: 60, 
          p: 1.8, 
          i: 0.25, 
          d: 0.08, 
          description: 'Flow Control with Disturbances',
          target: 'Disturbance rejection, stable operation'
        },
        3: { 
          setpoint: 50, 
          p: 0.6, 
          i: 0.12, 
          d: 0.25, 
          description: 'Pressure Control (No Overshoot)',
          target: 'Zero overshoot, stable operation'
        },
        4: { 
          setpoint: 80, 
          p: 1.2, 
          i: 0.15, 
          d: 0.18, 
          description: 'Level Control System',
          target: 'Adaptive response, minimal oscillation'
        }
      };
      
      const challenge = challenges[challengeNumber];
      if (challenge) {
        // Set the parameters
        document.getElementById('setpoint-slider').value = challenge.setpoint;
        document.getElementById('setpoint-value').textContent = challenge.setpoint;
        document.getElementById('setpoint-display').textContent = challenge.setpoint.toFixed(1);
        updateSliderFill('setpoint-fill', challenge.setpoint, 100);
        
        document.getElementById('p-gain-slider').value = challenge.p;
        document.getElementById('p-gain-value').textContent = challenge.p;
        document.getElementById('p-display').textContent = challenge.p.toFixed(1);
        updateSliderFill('p-fill', challenge.p, 5);
        
        document.getElementById('i-gain-slider').value = challenge.i;
        document.getElementById('i-gain-value').textContent = challenge.i;
        document.getElementById('i-display').textContent = challenge.i.toFixed(2);
        updateSliderFill('i-fill', challenge.i, 2);
        
        document.getElementById('d-gain-slider').value = challenge.d;
        document.getElementById('d-gain-value').textContent = challenge.d;
        document.getElementById('d-display').textContent = challenge.d.toFixed(2);
        updateSliderFill('d-fill', challenge.d, 1);
        
        // Show challenge info
        const challengeInfo = `${challenge.description}\n\nTarget: ${challenge.target}\n\nTry to improve the response by adjusting the PID parameters!`;
        alert(challengeInfo);
      }
    }
    
    // Calculate response metrics
    function calculateResponseMetrics() {
      if (!pidChart || pidChart.data.datasets[1].data.length === 0) return;
      
      const setpointData = pidChart.data.datasets[0].data;
      const processData = pidChart.data.datasets[1].data;
      const setpoint = setpointData[setpointData.length - 1];
      
      // Calculate rise time (time to reach 90% of setpoint)
      const target90 = setpoint * 0.9;
      let riseTime = 0;
      for (let i = 0; i < processData.length; i++) {
        if (processData[i] >= target90) {
          riseTime = i;
          break;
        }
      }
      
      // Calculate overshoot
      const maxValue = Math.max(...processData);
      const overshoot = maxValue > setpoint ? ((maxValue - setpoint) / setpoint) * 100 : 0;
      
      // Calculate settling time (time to stay within 2% of setpoint)
      const targetRange = setpoint * 0.02;
      let settlingTime = 0;
      for (let i = processData.length - 1; i >= 0; i--) {
        if (Math.abs(processData[i] - setpoint) > targetRange) {
          settlingTime = i;
          break;
        }
      }
      
      // Calculate steady state error
      const finalValue = processData[processData.length - 1];
      const steadyStateError = Math.abs(finalValue - setpoint);
      
      // Update display
      document.getElementById('rise-time').textContent = riseTime + ' s';
      document.getElementById('settling-time').textContent = settlingTime + ' s';
      document.getElementById('overshoot').textContent = overshoot.toFixed(1) + '%';
      document.getElementById('steady-state-error').textContent = steadyStateError.toFixed(2);
    }
  </script>
  
  <!-- Bottom Navigation -->
  <div class="worksheet-bottom-nav">
    <div class="worksheet-header-content">
      <div class="worksheet-header-left">
        <button class="worksheet-nav-btn worksheet-back-btn" onclick="window.location.href='cp0539-worksheets.html'">
          <i class="fas fa-arrow-left"></i>
          <span>Back to Worksheets</span>
        </button>
      </div>
      <div class="worksheet-header-center">
        <h1 class="worksheet-title">Worksheet 1 - Flow Control System Maintenance</h1>
      </div>
      <div class="worksheet-header-right">
        <button class="worksheet-nav-btn worksheet-next-btn" onclick="window.location.href='worksheet-2.html'">
          <span>Next Worksheet</span>
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
  
</body>
</html> 