<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matrix Training Platform - Worksheet</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="assets/icons/matrix-icon.ico">
  
  <style>
    /* Worksheet Box Styling */
    .worksheet-box {
      max-width: 1200px;
      margin: 20px auto;
      background: #2d2d2d;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid #444;
    }

    /* Navigation Buttons */
    .worksheet-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid #444;
      gap: 15px;
      flex-wrap: wrap;
    }

    .nav-btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 160px;
      justify-content: center;
    }

    .nav-btn:hover {
      background: linear-gradient(135deg, #45a049, #4CAF50);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }

    .nav-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .back-to-list-btn {
      background: linear-gradient(135deg, #2196F3, #1976D2);
    }

    .back-to-list-btn:hover {
      background: linear-gradient(135deg, #1976D2, #2196F3);
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .worksheet-box {
        margin: 10px;
        padding: 20px;
      }
      
      .worksheet-navigation {
        flex-direction: column;
        gap: 10px;
      }
      
      .nav-btn {
        width: 100%;
        max-width: 300px;
      }
    }

    /* Improve content spacing within the box */
    .worksheet-box .page-title {
      margin-top: 0;
      margin-bottom: 30px;
    }

    .worksheet-box .worksheet-section {
      margin-bottom: 30px;
    }

    .worksheet-box .so-what-section {
      margin-top: 30px;
      margin-bottom: 30px;
    }

    /* Hidden class for tab system */
    .hidden {
      display: none !important;
    }

    /* Fallback styling for basic worksheets */
    .worksheet-section {
      margin-bottom: 30px;
    }

    .section-header {
      color: #4CAF50;
      margin-bottom: 20px;
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .scenario-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* Enhanced button styling */
    .submit-question-btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .submit-question-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #45a049, #4CAF50);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }

    .submit-question-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Step card styling */
    .step-card {
      transition: all 0.3s ease;
    }

    .step-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .step-card.step-completed {
      opacity: 0.7;
      background: #2a2a2a;
    }

    /* Checkbox styling */
    .step-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #4CAF50;
      cursor: pointer;
    }

    /* Question item styling */
    .question-item {
      transition: all 0.3s ease;
    }

    .question-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    /* Text styling improvements */
    .worksheet-content p {
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .key-point {
      transition: all 0.3s ease;
    }

    .key-point:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="main-navigation">
    <div class="nav-container">
      <div class="nav-logo">
        <img src="assets/matrix-logo.png" alt="Matrix Logo">
      </div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" onclick="window.electron.navigate('index.html')" class="nav-link">
            <i class="fas fa-home"></i> HOME
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.electron.navigate('worksheets.html')" class="nav-link active">
            <i class="fas fa-book-open"></i> WORKSHEETS
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.electron.navigate('plc-controls.html')" class="nav-link">
            <i class="fas fa-cogs"></i> PLC CONTROLS
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.electron.navigate('settings.html')" class="nav-link">
            <i class="fas fa-gear"></i> SETTINGS
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Loading State -->
  <div id="loading-container" class="loading-container">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Loading worksheet...</p>
    </div>
  </div>

  <!-- Error State -->
  <div id="error-container" class="error-container" style="display: none;">
    <h3><i class="fas fa-exclamation-triangle"></i> Worksheet Not Found</h3>
    <p>The requested worksheet could not be loaded.</p>
    <button class="back-btn" onclick="window.electron.navigate('worksheets.html')">
      <i class="fas fa-arrow-left"></i> Back to Worksheets
    </button>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="worksheet-container" style="display: none;">
    <!-- Back Navigation -->
    <div class="back-nav">
      <button class="back-btn" onclick="window.electron.navigate('worksheets.html')">
        <i class="fas fa-arrow-left"></i> Back to Worksheets
      </button>
    </div>

    <!-- Boxed Worksheet Content -->
    <div class="worksheet-box">
      <!-- Dynamic Content Will Be Loaded Here -->
      <div id="worksheet-content"></div>
      
      <!-- Navigation Buttons -->
      <div class="worksheet-navigation">
        <button class="nav-btn prev-btn" onclick="navigateWorksheet('prev')">
          <i class="fas fa-chevron-left"></i> Previous Worksheet
        </button>
        <button class="nav-btn next-btn" onclick="navigateWorksheet('next')">
          Next Worksheet <i class="fas fa-chevron-right"></i>
        </button>
        <button class="nav-btn back-to-list-btn" onclick="window.electron.navigate('worksheets.html')">
          <i class="fas fa-list"></i> All Worksheets
        </button>
      </div>
    </div>
  </div>

  <!-- Load dependencies -->
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="scenario-popup.js"></script>
  
  <script>
    console.log('Scripts loaded, checking for functions...');
    console.log('showInteractiveWorksheet1 available:', typeof showInteractiveWorksheet1);
    console.log('window.showInteractiveWorksheet1 available:', typeof window.showInteractiveWorksheet1);
  </script>
  
  <script>
    // Get URL parameters
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Load worksheet data
    async function loadWorksheet() {
      try {
        const worksheetId = getUrlParameter('id');
        const type = getUrlParameter('type') || 'maintenance';
        
        if (!worksheetId) {
          showError('No worksheet ID specified');
          return;
        }

        // Load data for worksheets
        const filename = type === 'fault' ? 'dbFaultScenarios.json' : 'dbMaintenanceScenarios.json';
        const response = await fetch(filename);
        const data = await response.json();
        
        const scenario = data.scenarios.find(s => s.id === parseInt(worksheetId));
        if (!scenario) {
          showError('Worksheet not found');
          return;
        }

        // Log worksheet structure for debugging
        console.log('Loading worksheet:', scenario.title);
        console.log('Worksheet structure analysis:', analyzeWorksheetStructure(scenario));

        // Check worksheet type and render accordingly
        if (type === 'maintenance') {
          // All maintenance worksheets use enhanced format
          console.log(`Rendering enhanced maintenance worksheet: ${scenario.title}`);
          renderEnhancedMaintenanceWorksheet(scenario);
        } else if (type === 'fault') {
          // Fault scenarios use basic format (to be enhanced later)
          console.log(`Rendering fault scenario: ${scenario.title}`);
          renderFaultScenario(scenario);
        } else {
          // Fallback for any other types
          renderWorksheet(scenario, type);
        }
        
      } catch (error) {
        console.error('Error loading worksheet:', error);
        showError('Failed to load worksheet');
      } finally {
        // Update navigation buttons for all worksheets
        setTimeout(updateNavigationButtons, 100);
      }
    }
    
    // Analyze worksheet structure for debugging
    function analyzeWorksheetStructure(scenario) {
      const analysis = {
        hasTitle: !!scenario.title,
        hasParagraphs: !!(scenario.paragraphs && scenario.paragraphs.length > 0),
        hasImage: !!scenario.image,
        hasSteps: !!(scenario.steps && scenario.steps.length > 0),
        hasEducationalContent: !!(scenario.soWhat && (scenario.soWhat.content || scenario.soWhat.keyPoints)),
        hasQuestions: !!(scenario.questions && scenario.questions.length > 0),
        hasSimulation: !!scenario.simulation,
        hasFunctionCall: !!scenario.functionCall,
        sectionsToShow: []
      };
      
      // Determine which sections will be shown
      if (analysis.hasTitle) analysis.sectionsToShow.push('Title');
      if (analysis.hasParagraphs) analysis.sectionsToShow.push('Introduction');
      if (analysis.hasImage) analysis.sectionsToShow.push('System Diagram');
      if (analysis.hasSteps) analysis.sectionsToShow.push('Steps');
      if (analysis.hasEducationalContent) analysis.sectionsToShow.push('Educational Content');
      if (analysis.hasQuestions) analysis.sectionsToShow.push('Questions');
      if (analysis.hasSimulation) analysis.sectionsToShow.push('Simulation');
      
      return analysis;
    }

    // Generate enhanced content based on worksheet topic
    function generateEnhancedContent(scenario) {
      const worksheetId = scenario.id;
      const title = scenario.title;
      
      // Define content templates for each worksheet
      const contentTemplates = {
        1: {
          instructions: "Select Start and observe the system start up. Once the pump is running you should see water flow through the flow gauge. Ensure the hand valve is in the open position, (the handle should be in line with the piping).",
          steps: [
            { title: "Set a Flow Rate", description: "Enter a target flow rate on the HMI. You can adjust in increments of 20 using the +/- buttons." },
            { title: "Observe Feedback", description: "Watch the flow sensor reading on the HMI and compare it to the setpoint." },
            { title: "Watch the System Adjust", description: "Note how the pump speed and valve position change to bring the flow rate to the setpoint." },
            { title: "Introduce a Disturbance", description: "Temporarily restrict the flow (e.g., partially close the shut-off valve) and observe how the system reacts to maintain the flow rate." }
          ],
          soWhat: {
            intro: "This is part of a control system, which automates processes in Industry. At the heart of this system is a PLC (Programmable Logic Controller), a computer that makes real-time decisions based on sensor data. The HMI (Human-Machine Interface) allows you to monitor and adjust settings easily.",
            keyPoints: [
              { title: "Feedback Control", description: "The system continuously measures the actual flow rate and compares it to the desired setpoint. If there's a difference, it automatically adjusts the pump speed or valve position to correct it." },
              { title: "Real-Time Automation", description: "The PLC processes sensor data and makes control decisions in milliseconds, far faster than any human could react. This ensures consistent, accurate control even when conditions change." },
              { title: "Stability & Reliability", description: "Closed-loop systems are self-correcting. If something tries to disturb the process (like partially closing a valve), the system automatically compensates to maintain the desired flow rate." },
              { title: "Industrial Applications", description: "These principles are used everywhere in industry - from temperature control in manufacturing to pressure regulation in chemical plants. Understanding this system gives you insight into how modern automation works." }
            ]
          }
        },
        2: {
          instructions: "Examine the emergency stop systems located throughout the facility. These critical safety devices must be tested regularly to ensure they function properly when needed.",
          steps: [
            { title: "Visual Inspection", description: "Check each E-stop button for physical damage, proper mounting, and clear labeling. Ensure the button is not stuck or damaged." },
            { title: "Mechanical Test", description: "Press each E-stop button to verify it latches properly and requires intentional rotation to reset." },
            { title: "Circuit Verification", description: "Use a multimeter to verify the E-stop contacts open properly when activated and close when reset." },
            { title: "System Response Test", description: "Test that the system properly shuts down when E-stop is activated and requires proper reset sequence to restart." }
          ],
          soWhat: {
            intro: "Emergency stop systems are the last line of defense in industrial safety. They must be 100% reliable because lives depend on them. Understanding how they work and how to maintain them is crucial for any maintenance technician.",
            keyPoints: [
              { title: "Safety First", description: "E-stop systems are designed to fail safe - if anything goes wrong with the system, it defaults to the stopped state to protect people and equipment." },
              { title: "Redundancy", description: "Critical systems often have multiple E-stop buttons and redundant safety circuits to ensure the system can always be stopped, even if one component fails." },
              { title: "Compliance", description: "E-stop systems must meet strict safety standards (like ISO 13850) and require regular testing and documentation to maintain safety certification." },
              { title: "Maintenance Responsibility", description: "As a maintenance technician, you're responsible for ensuring these systems work when needed. Regular testing and proper documentation can save lives." }
            ]
          }
        },
        3: {
          instructions: "Observe the various LED indicators on the control panel. These visual signals provide instant feedback about system status and are essential for quick diagnosis.",
          steps: [
            { title: "Identify LED Functions", description: "Document what each LED indicates - power, run status, alarms, communication, etc. Check the system documentation if needed." },
            { title: "Test LED Operation", description: "Verify each LED illuminates properly by changing system conditions or using test functions if available." },
            { title: "Check Visibility", description: "Ensure all LEDs are clearly visible from the operator position and not obscured by dirt, labels, or other equipment." },
            { title: "Verify Color Coding", description: "Confirm LEDs follow standard color conventions (green=normal, red=alarm, yellow=warning, blue=information)." }
          ],
          soWhat: {
            intro: "Status LEDs are the simplest form of human-machine interface, providing instant visual feedback about system conditions. They're often the first indication of problems and are crucial for quick troubleshooting.",
            keyPoints: [
              { title: "Instant Feedback", description: "LEDs provide immediate visual indication of system status without needing to navigate through screens or menus - critical for emergency situations." },
              { title: "Standard Color Coding", description: "Industrial LEDs follow international standards for colors, making it easier for technicians to quickly understand system status regardless of the specific equipment." },
              { title: "Diagnostic Tool", description: "LED patterns can indicate specific fault conditions, helping technicians quickly identify problems without needing complex diagnostic equipment." },
              { title: "Maintenance Indicator", description: "Many systems use LEDs to indicate when maintenance is due, helping prevent unexpected failures through predictive maintenance." }
            ]
          }
        },
        4: {
          instructions: "Examine the PLC (Programmable Logic Controller) that controls the automation system. This is the 'brain' of the operation and requires careful maintenance.",
          steps: [
            { title: "Physical Inspection", description: "Check the PLC cabinet for proper ventilation, clean filters, secure mounting, and no signs of overheating or corrosion." },
            { title: "Power Supply Check", description: "Verify input voltage is within specifications and check backup battery status if equipped." },
            { title: "I/O Module Status", description: "Check all input/output modules for proper LED indication and verify no loose connections." },
            { title: "Program Backup", description: "Ensure the PLC program is backed up and verify the backup is current and complete." }
          ],
          soWhat: {
            intro: "The PLC is the central nervous system of modern industrial automation. It makes thousands of decisions per second, controlling everything from simple on/off functions to complex process control algorithms.",
            keyPoints: [
              { title: "Central Control", description: "The PLC coordinates all system functions, reading sensors, making control decisions, and operating actuators - all in real-time with precise timing." },
              { title: "Programmable Logic", description: "Unlike hardwired control systems, PLCs can be reprogrammed to change system behavior without rewiring, making them incredibly flexible for different applications." },
              { title: "Reliability", description: "Industrial PLCs are designed to operate 24/7 in harsh environments for years without failure, but they require proper maintenance to achieve this reliability." },
              { title: "Diagnostic Capabilities", description: "Modern PLCs provide extensive diagnostic information, helping technicians quickly identify and resolve problems before they cause system failures." }
            ]
          }
        },
        5: {
          instructions: "Interact with the HMI (Human-Machine Interface) touchscreen. This is how operators monitor and control the system, so it must be properly maintained.",
          steps: [
            { title: "Screen Calibration", description: "Test touchscreen accuracy by pressing various buttons and verify the system responds to the correct touch points." },
            { title: "Display Quality", description: "Check for dead pixels, scratches, or areas of poor visibility that could affect operator ability to read information." },
            { title: "Navigation Test", description: "Navigate through all available screens to ensure proper operation and verify all functions are accessible." },
            { title: "Alarm Testing", description: "Test alarm acknowledgment and verify that critical alarms are properly displayed and cannot be missed." }
          ],
          soWhat: {
            intro: "The HMI is the primary interface between humans and the automated system. It must be intuitive, reliable, and always available because operators depend on it to monitor and control critical processes.",
            keyPoints: [
              { title: "Human Factors", description: "HMI design follows human factors engineering principles to reduce operator error and improve response time during normal and emergency conditions." },
              { title: "Process Visualization", description: "Good HMI design provides clear, intuitive visualization of complex processes, helping operators understand system status at a glance." },
              { title: "Alarm Management", description: "The HMI manages alarms and alerts, prioritizing critical information and guiding operators through proper response procedures." },
              { title: "Data Logging", description: "HMIs often log operator actions and system events, providing valuable data for troubleshooting and process improvement." }
            ]
          }
        },
        6: {
          instructions: "Examine the pump system that circulates fluid through the process. Pumps are critical components that require regular maintenance to prevent costly failures.",
          steps: [
            { title: "Performance Monitoring", description: "Record pump flow rate, pressure, and power consumption. Compare to baseline values to identify performance degradation." },
            { title: "Vibration Analysis", description: "Check for excessive vibration that could indicate bearing wear, impeller damage, or misalignment." },
            { title: "Seal Inspection", description: "Examine mechanical seals for leakage and check seal flush systems if equipped." },
            { title: "Cavitation Check", description: "Listen for cavitation noise and check suction pressure to ensure adequate NPSH (Net Positive Suction Head)." }
          ],
          soWhat: {
            intro: "Pumps are the workhorses of industrial processes, moving fluids where they need to go. Understanding pump operation and maintenance is essential because pump failures can shut down entire processes.",
            keyPoints: [
              { title: "Energy Efficiency", description: "Properly maintained pumps operate more efficiently, reducing energy costs. A worn pump can consume significantly more power while delivering less flow." },
              { title: "Predictive Maintenance", description: "Monitoring pump performance parameters allows you to predict failures before they occur, scheduling maintenance during planned downtime rather than emergency shutdowns." },
              { title: "System Impact", description: "Pump performance affects the entire process. Understanding pump curves and system curves helps optimize performance and identify problems early." },
              { title: "Cost of Failure", description: "Unexpected pump failures can cost thousands in lost production, emergency repairs, and potential safety hazards. Proper maintenance prevents these costly surprises." }
            ]
          }
        },
        7: {
          instructions: "Examine the control valve that regulates flow in the system. Valves are precision instruments that require careful maintenance to maintain accuracy.",
          steps: [
            { title: "Position Accuracy", description: "Test valve positioning by commanding different positions and verifying actual position matches commanded position." },
            { title: "Response Time", description: "Time how quickly the valve responds to position changes and compare to specifications." },
            { title: "Seal Integrity", description: "Check for internal and external leakage, paying special attention to packing glands and seat sealing." },
            { title: "Actuator Function", description: "Test actuator operation, check air pressure (pneumatic) or electrical connections (electric), and verify proper calibration." }
          ],
          soWhat: {
            intro: "Control valves are the 'muscles' of process control systems, actually doing the work of controlling flow, pressure, or temperature. They must be precise and reliable because they directly affect product quality and safety.",
            keyPoints: [
              { title: "Process Control", description: "Control valves are the final control elements in most process control loops, directly manipulating the process variable to maintain desired setpoints." },
              { title: "Precision Required", description: "Many processes require very precise control, and valve performance directly affects product quality, energy efficiency, and safety." },
              { title: "Wear and Tear", description: "Valves experience constant wear from fluid flow, pressure changes, and cycling, making regular maintenance essential for continued accuracy." },
              { title: "Safety Critical", description: "In many applications, control valves are safety-critical components that must fail to a safe position and respond quickly to emergency shutdown commands." }
            ]
          }
        },
        8: {
          instructions: "Examine the float switch used for level detection. These simple but critical devices must be properly maintained to ensure reliable level control.",
          steps: [
            { title: "Float Movement", description: "Manually lift and lower the float to verify smooth movement without binding or sticking." },
            { title: "Switch Operation", description: "Test the electrical switch by moving the float through its operating range and verifying proper switching action." },
            { title: "Mounting Security", description: "Check that the float switch is securely mounted and properly positioned for accurate level detection." },
            { title: "Electrical Connections", description: "Inspect wiring and connections for corrosion, looseness, or damage that could cause intermittent operation." }
          ],
          soWhat: {
            intro: "Float switches are simple but essential safety devices that prevent tank overflows and pump dry-running. Despite their simplicity, they must be properly maintained because failures can cause expensive damage or safety hazards.",
            keyPoints: [
              { title: "Simple but Critical", description: "Float switches have few moving parts but perform critical safety functions like preventing tank overflows or protecting pumps from running dry." },
              { title: "Environmental Challenges", description: "Float switches often operate in harsh environments with corrosive fluids, extreme temperatures, or debris that can affect operation." },
              { title: "Fail-Safe Design", description: "Properly designed float switch systems fail in a safe condition - if the switch fails, the system shuts down safely rather than causing damage." },
              { title: "Regular Testing", description: "Because float switches are often in remote or difficult-to-access locations, regular testing ensures they'll work when needed." }
            ]
          }
        },
        9: {
          instructions: "Examine the proximity switch used for position detection. These non-contact sensors are essential for automation but require proper setup and maintenance.",
          steps: [
            { title: "Sensing Distance", description: "Test the sensing distance by moving a target object toward the sensor and noting the exact switching point." },
            { title: "Target Material Effect", description: "Test with different target materials (steel, aluminum, brass) to understand how material affects sensing distance." },
            { title: "Environmental Factors", description: "Check for interference from nearby metal objects, electrical noise, or environmental conditions that could affect operation." },
            { title: "Wiring Integrity", description: "Inspect cables for damage and verify proper electrical connections, especially in areas subject to vibration or movement." }
          ],
          soWhat: {
            intro: "Proximity switches are the eyes and ears of automation systems, detecting position and presence without physical contact. They enable precise control and safety functions that would be impossible with mechanical switches.",
            keyPoints: [
              { title: "Non-Contact Operation", description: "Proximity switches detect objects without physical contact, eliminating wear and enabling detection of fragile objects or in harsh environments." },
              { title: "Precision Positioning", description: "Modern proximity switches can detect position changes as small as 0.1mm, enabling precise control of automated equipment." },
              { title: "Speed Capability", description: "Proximity switches can detect objects moving at high speeds, making them ideal for counting, sorting, and high-speed automation applications." },
              { title: "Reliability", description: "With no moving parts, proximity switches are extremely reliable when properly applied, but they require understanding of their limitations and proper installation." }
            ]
          }
        },
        10: {
          instructions: "Examine the flow sensor that measures fluid flow rate. Accurate flow measurement is critical for process control and must be properly maintained.",
          steps: [
            { title: "Calibration Check", description: "Compare sensor reading to a known flow rate using a calibrated reference or by timing a known volume." },
            { title: "Installation Verification", description: "Verify proper installation with correct upstream and downstream straight pipe lengths and proper orientation." },
            { title: "Signal Quality", description: "Check the electrical signal output for proper voltage/current levels and verify signal stability." },
            { title: "Physical Condition", description: "Inspect the sensor for damage, corrosion, or fouling that could affect accuracy." }
          ],
          soWhat: {
            intro: "Flow measurement is fundamental to process control - you can't control what you can't measure. Flow sensors provide the feedback necessary for precise control of chemical processes, energy systems, and manufacturing operations.",
            keyPoints: [
              { title: "Process Control", description: "Flow measurement is essential for material balance, quality control, and safety in chemical processes. Inaccurate flow measurement can result in off-spec products or dangerous conditions." },
              { title: "Energy Management", description: "Flow sensors help optimize energy consumption by measuring fuel, steam, and cooling water flows, enabling efficient operation and cost control." },
              { title: "Custody Transfer", description: "In many applications, flow sensors are used for custody transfer - buying and selling fluids based on measured quantities, requiring high accuracy and legal traceability." },
              { title: "Maintenance Indicators", description: "Changes in flow sensor readings can indicate developing problems like pipe blockages, pump wear, or valve problems, enabling predictive maintenance." }
            ]
          }
        },
        11: {
          instructions: "Examine the temperature sensor that monitors process temperature. Temperature measurement is critical for quality, safety, and efficiency.",
          steps: [
            { title: "Calibration Verification", description: "Compare sensor reading to a calibrated reference thermometer at known temperature points." },
            { title: "Response Time Test", description: "Test sensor response time by subjecting it to a rapid temperature change and measuring how quickly it responds." },
            { title: "Installation Check", description: "Verify proper installation depth, thermal contact, and insulation to ensure accurate measurement." },
            { title: "Signal Integrity", description: "Check electrical connections and verify proper signal conditioning for the type of sensor (RTD, thermocouple, etc.)." }
          ],
          soWhat: {
            intro: "Temperature control is fundamental to most industrial processes. Whether it's maintaining product quality, ensuring safety, or optimizing energy efficiency, accurate temperature measurement is essential.",
            keyPoints: [
              { title: "Product Quality", description: "Many manufacturing processes require precise temperature control to produce consistent, high-quality products. Temperature variations can result in defects, waste, or off-spec products." },
              { title: "Safety Critical", description: "Temperature monitoring prevents dangerous conditions like overheating, thermal runaway, or exposure to extreme temperatures that could harm personnel or equipment." },
              { title: "Energy Efficiency", description: "Accurate temperature control minimizes energy waste by maintaining optimal operating conditions without excessive heating or cooling." },
              { title: "Process Optimization", description: "Temperature data helps optimize reaction rates, cure times, and other process parameters to maximize efficiency and minimize costs." }
            ]
          }
        },
        12: {
          instructions: "Examine the digital sensors that provide on/off status information. These binary sensors are the foundation of industrial automation logic.",
          steps: [
            { title: "Switch Point Testing", description: "Test each digital sensor by activating it and verifying clean switching between on and off states." },
            { title: "Signal Quality", description: "Use a multimeter or oscilloscope to verify clean digital signals without noise or intermittent switching." },
            { title: "Wiring Verification", description: "Check all connections for proper voltage levels, secure connections, and proper grounding." },
            { title: "Response Time", description: "Test sensor response time to ensure it's fast enough for the application requirements." }
          ],
          soWhat: {
            intro: "Digital sensors are the building blocks of automation logic, providing the binary (on/off) information that PLCs use to make control decisions. They must be absolutely reliable because automation depends on them.",
            keyPoints: [
              { title: "Logic Foundation", description: "Digital sensors provide the binary inputs that form the foundation of all automation logic - every decision starts with digital sensor information." },
              { title: "Safety Systems", description: "Many safety systems rely on digital sensors for emergency stops, safety interlocks, and protective functions that must work reliably every time." },
              { title: "Sequence Control", description: "Digital sensors enable precise sequence control, ensuring operations happen in the correct order and at the right time." },
              { title: "Diagnostic Capability", description: "Digital sensors often provide diagnostic information about system status, helping technicians quickly identify and resolve problems." }
            ]
          }
        },
        13: {
          instructions: "Examine the analog sensors that provide continuous measurement values. These sensors provide the precise measurements needed for process control.",
          steps: [
            { title: "Calibration Check", description: "Verify sensor accuracy by comparing readings to known reference values across the full measurement range." },
            { title: "Signal Conditioning", description: "Check signal conditioning circuits, amplifiers, and converters to ensure proper signal processing." },
            { title: "Noise Analysis", description: "Look for electrical noise, interference, or signal drift that could affect measurement accuracy." },
            { title: "Loop Testing", description: "Test the complete measurement loop including sensor, wiring, and receiving instrument." }
          ],
          soWhat: {
            intro: "Analog sensors provide the continuous measurements that enable precise process control. Unlike digital sensors that are simply on or off, analog sensors provide the exact values needed for accurate control.",
            keyPoints: [
              { title: "Precise Control", description: "Analog sensors enable precise control by providing exact measurements rather than just on/off information, allowing for fine-tuning of process parameters." },
              { title: "Trend Analysis", description: "Continuous analog measurements allow for trend analysis, helping predict problems before they occur and optimize process performance." },
              { title: "Quality Control", description: "Analog measurements are essential for quality control, ensuring products meet specifications and detecting variations that could indicate problems." },
              { title: "Process Optimization", description: "Analog sensor data enables advanced control strategies like PID control, feedforward control, and model predictive control for optimal process performance." }
            ]
          }
        },
        14: {
          instructions: "Learn systematic approaches to fault diagnosis and troubleshooting. Effective troubleshooting requires a methodical approach and understanding of system interactions.",
          steps: [
            { title: "Gather Information", description: "Collect all available information about the fault - when it occurred, what symptoms are present, and what was happening when it started." },
            { title: "Analyze Symptoms", description: "Systematically analyze symptoms to develop theories about possible causes, starting with the most likely based on experience." },
            { title: "Test Theories", description: "Test each theory systematically, starting with the easiest and most likely causes before moving to more complex possibilities." },
            { title: "Implement Solution", description: "Once the root cause is identified, implement a permanent solution and verify that the problem is completely resolved." }
          ],
          soWhat: {
            intro: "Effective troubleshooting is both an art and a science. It requires systematic thinking, technical knowledge, and experience to quickly identify and resolve problems that can cost thousands of dollars per hour in lost production.",
            keyPoints: [
              { title: "Systematic Approach", description: "Random troubleshooting wastes time and can make problems worse. A systematic approach ensures you find the real cause quickly and efficiently." },
              { title: "Root Cause Analysis", description: "Fixing symptoms without addressing root causes leads to recurring problems. Effective troubleshooting identifies and eliminates the underlying cause." },
              { title: "Documentation", description: "Proper documentation of faults and solutions builds organizational knowledge and helps prevent similar problems in the future." },
              { title: "Continuous Learning", description: "Every fault is a learning opportunity. Understanding why problems occur helps prevent them and makes you a more effective troubleshooter." }
            ]
          }
        }
      };
      
      // Return the content for the specific worksheet, or default content if not found
      return contentTemplates[worksheetId] || {
        instructions: `Follow the maintenance procedures for ${title.toLowerCase()} as outlined in the system documentation.`,
        steps: [
          { title: "Initial Inspection", description: "Perform a visual inspection of the system components." },
          { title: "Functional Testing", description: "Test the system operation according to procedures." },
          { title: "Documentation", description: "Record all observations and measurements." },
          { title: "Corrective Actions", description: "Implement any necessary corrective actions." }
        ],
        soWhat: {
          intro: `Understanding ${title.toLowerCase()} is important for maintaining reliable industrial systems.`,
          keyPoints: [
            { title: "System Reliability", description: "Proper maintenance ensures reliable operation and prevents unexpected failures." },
            { title: "Safety", description: "Well-maintained systems operate safely and protect personnel and equipment." },
            { title: "Efficiency", description: "Regular maintenance maintains system efficiency and reduces operating costs." },
            { title: "Compliance", description: "Proper maintenance ensures compliance with safety and regulatory requirements." }
          ]
        }
      };
    }

    // Render enhanced maintenance worksheet with interactive sections
    function renderEnhancedMaintenanceWorksheet(scenario) {
      const container = document.getElementById('worksheet-content');
      
      // Generate enhanced content based on worksheet topic
      const enhancedContent = generateEnhancedContent(scenario);
      
      container.innerHTML = `
        <h1 class="page-title">${scenario.title}</h1>

        <div class="worksheet-section introduction-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);">
          <h2 class="section-header" style="color: #2196F3; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-info-circle"></i> 1. Introduction</h2>
          <div class="worksheet-content">
            ${scenario.paragraphs.map(p => `<p style="color: #FFFFFF; margin-bottom: 15px;">${p}</p>`).join('')}
            
            ${scenario.image ? `
            <div class="system-diagram" style="text-align: center; margin: 20px 0;">
              <figure>
                <img src="assets/maintenance/${scenario.image}" alt="${scenario.title}" style="max-width: 400px; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                <figcaption style="color: #FFFFFF; margin-top: 10px; font-style: italic;">${scenario.title} System Diagram</figcaption>
              </figure>
            </div>
            ` : ''}
          </div>
        </div>

        <div class="worksheet-section over-to-you-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FF9800; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.2);">
          <h2 class="section-header" style="color: #FF9800; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-hands-helping"></i> 2. Over To You</h2>
          <div class="worksheet-content">
            <p style="color: #FFFFFF; margin-bottom: 20px; font-weight: bold;">${enhancedContent.instructions}</p>
            
            <div class="steps-container">
              ${enhancedContent.steps.map((step, index) => `
                <div class="step-card" data-step="${index + 1}" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">${index + 1}</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">${step.title}</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">${step.description}</p>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>

        <div class="so-what-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; margin-bottom: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);">
          <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-lightbulb"></i> 3. So What?</h2>
          <div class="so-what-content">
            <p style="color: #FFFFFF; margin-bottom: 20px;">${enhancedContent.soWhat.intro}</p>
            
            ${enhancedContent.soWhat.keyPoints.map(point => `
              <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                <i class="fas fa-lightbulb" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                <div>
                  <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">${point.title}</strong>
                  <p style="color: #FFFFFF; margin: 0;">${point.description}</p>
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="questions-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #4CAF50; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);">
          <h2 class="section-header" style="color: #4CAF50; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-question-circle"></i> 4. Questions & Answers</h2>
          <div class="questions-content">
            <div class="instructions" style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #FFFFFF;">
              <strong>Instructions:</strong> Answer each question based on your observations and understanding of the ${scenario.title.toLowerCase()} system. Your answers will be saved automatically.
            </div>
            
            ${scenario.questions.map((q, index) => `
              <div class="question-item" data-question="${index + 1}" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question ${index + 1}: ${q.text}</h4>
                <textarea class="answer-input" data-question="${index + 1}" placeholder="${q.placeholder}" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitAnswer(${index + 1})" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                  <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be saved automatically.</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      // Initialize interactive features
      setTimeout(() => {
        initializeStepTracking();
        loadSavedAnswers();
      }, 100);
      
      // Show the content
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
    }

    // Render fault scenario (basic format for now)
    function renderFaultScenario(scenario) {
      const container = document.getElementById('worksheet-content');
      
      container.innerHTML = `
        <h1 class="page-title">Fault Scenario ${scenario.id}: ${scenario.title}</h1>

        <div class="worksheet-section introduction-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #f44336; box-shadow: 0 8px 20px rgba(244, 67, 54, 0.2);">
          <h2 class="section-header" style="color: #f44336; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-exclamation-triangle"></i> Fault Scenario</h2>
          <div class="worksheet-content">
            ${scenario.paragraphs.map(p => `<p style="color: #FFFFFF; margin-bottom: 15px;">${p}</p>`).join('')}
            
            ${scenario.image ? `
            <div class="system-diagram" style="text-align: center; margin: 20px 0;">
              <figure>
                <img src="assets/scenarios/${scenario.image}" alt="${scenario.title}" style="max-width: 400px; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                <figcaption style="color: #FFFFFF; margin-top: 10px; font-style: italic;">${scenario.title} Fault Scenario</figcaption>
              </figure>
            </div>
            ` : ''}
          </div>
        </div>

        <div class="questions-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #4CAF50; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.2);">
          <h2 class="section-header" style="color: #4CAF50; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-question-circle"></i> Troubleshooting Questions</h2>
          <div class="worksheet-content">
            ${scenario.questions.map((q, index) => `
              <div class="question-item" data-question="${index + 1}" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">${index + 1}. ${q.text}</h4>
                <textarea class="answer-input" data-question="${index + 1}" 
                         placeholder="${q.placeholder || 'Enter your answer here...'}" 
                         style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitAnswer(${index + 1})" 
                          style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    Submit Answer
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      // Load saved answers
      setTimeout(loadSavedAnswers, 100);
      
      // Show the content
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
    }

    // Render the interactive Worksheet 1 content directly to the container
    function renderInteractiveWorksheet1() {
      const container = document.getElementById('worksheet-content');
      
      try {
        // Create the worksheet content directly (without popup)
        container.innerHTML = `
          <h1 class="page-title">Closed-Loop Control Systems</h1>

          <div class="worksheet-section introduction-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);">
            <h2 class="section-header" style="color: #2196F3; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-info-circle"></i> 1. Introduction</h2>
            <div class="worksheet-content">
              <p>The system you have in front of you is a Closed-Loop Flow Control system, meaning it continuously adjusts itself to meet a desired target, called the setpoint. It does this by using feedback from sensors to control devices like pumps and valves, keeping the system accurate and stable even if conditions change.</p>
              
              <div class="cad-images" style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
                <figure style="text-align: center;">
                  <img src="assets/cad.png" alt="CAD Diagram 1" style="max-width: 300px; height: auto; border-radius: 4px;">
                  <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Front View</figcaption>
                </figure>
                <figure style="text-align: center;">
                  <img src="assets/cad2.png" alt="CAD Diagram 2" style="max-width: 300px; height: auto; border-radius: 4px;">
                  <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Side View</figcaption>
                </figure>
              </div>
            </div>
          </div>

          <div class="worksheet-section over-to-you-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FF9800; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.2);">
            <h2 class="section-header" style="color: #FF9800; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-hands-helping"></i> 2. Over To You</h2>
            <div class="worksheet-content">
              <p style="color: #FFFFFF; margin-bottom: 20px; font-weight: bold;">Select Start and observe the system start up. Once the pump is running you should see water flow through the flow gauge. Ensure the hand valve is in the open position, (the handle should be in line with the piping).</p>
              
              <div class="steps-container">
                <div class="step-card" data-step="1" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">Set a Flow Rate</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">Enter a target flow rate on the HMI. You can adjust in increments of 20 using the +/- buttons.</p>
                  </div>
                </div>

                <div class="step-card" data-step="2" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">Observe Feedback</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">Watch the flow sensor reading on the HMI and compare it to the setpoint.</p>
                  </div>
                </div>

                <div class="step-card" data-step="3" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">Watch the System Adjust</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">Note how the pump speed and valve position change to bring the flow rate to the setpoint.</p>
                  </div>
                </div>

                <div class="step-card" data-step="4" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">Introduce a Disturbance</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">Temporarily restrict the flow (e.g., partially close the shut-off valve) and observe how the system reacts to maintain the flow rate.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="so-what-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; margin-bottom: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);">
            <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-lightbulb"></i> 3. So What?</h2>
            <div class="so-what-content">
              <p style="color: #FFFFFF; margin-bottom: 20px;">This is part of a control system, which automates processes in Industry. At the heart of this system is a PLC (Programmable Logic Controller), a computer that makes real-time decisions based on sensor data. The HMI (Human-Machine Interface) allows you to monitor and adjust settings easily.</p>
              
              <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                <i class="fas fa-lightbulb" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                <div>
                  <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Feedback Control</strong>
                  <p style="color: #FFFFFF; margin: 0;">The system continuously measures the actual flow rate and compares it to the desired setpoint. If there's a difference, it automatically adjusts the pump speed or valve position to correct it.</p>
                </div>
              </div>
              
              <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                <i class="fas fa-cogs" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                <div>
                  <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Real-Time Automation</strong>
                  <p style="color: #FFFFFF; margin: 0;">The PLC processes sensor data and makes control decisions in milliseconds, far faster than any human could react. This ensures consistent, accurate control even when conditions change.</p>
                </div>
              </div>
              
              <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                <i class="fas fa-shield-alt" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                <div>
                  <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Stability & Reliability</strong>
                  <p style="color: #FFFFFF; margin: 0;">Closed-loop systems are self-correcting. If something tries to disturb the process (like partially closing a valve), the system automatically compensates to maintain the desired flow rate.</p>
                </div>
              </div>
              
              <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                <i class="fas fa-industry" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                <div>
                  <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Industrial Applications</strong>
                  <p style="color: #FFFFFF; margin: 0;">These principles are used everywhere in industry - from temperature control in manufacturing to pressure regulation in chemical plants. Understanding this system gives you insight into how modern automation works.</p>
                </div>
              </div>
            </div>
          </div>

                     <div class="questions-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #4CAF50; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);">
            <h2 class="section-header" style="color: #4CAF50; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-question-circle"></i> 4. Questions & Answers</h2>
            <div class="questions-content">
              <div class="instructions" style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #FFFFFF;">
                <strong>Instructions:</strong> Answer each question based on your observations and understanding of the closed-loop control system. Click "Submit Answer" for each question to see how your response compares to the correct answer.
              </div>
              
              <div class="question-item" data-question="1" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question 1: What is the main purpose of a closed-loop control system?</h4>
                <p style="color: #FFFFFF; margin-bottom: 15px;">Think about what you observed when you set the flow rate and how the system responded.</p>
                <textarea class="answer-input" data-question="1" placeholder="Enter your answer here..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitQuestion(1)" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                  <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be saved and compared to the correct answer.</span>
                </div>
                <div class="individual-comparison hidden"></div>
              </div>
              
              <div class="question-item" data-question="2" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question 2: Before starting the system, what important check should you perform with the hand valve?</h4>
                <p style="color: #FFFFFF; margin-bottom: 15px;">Refer to the initial instructions in the "Over To You" section.</p>
                <textarea class="answer-input" data-question="2" placeholder="Enter your answer here..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitQuestion(2)" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                  <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be saved and compared to the correct answer.</span>
                </div>
                <div class="individual-comparison hidden"></div>
              </div>
              
              <div class="question-item" data-question="3" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question 3: What happens when you introduce a disturbance (like partially closing the shut-off valve)?</h4>
                <p style="color: #FFFFFF; margin-bottom: 15px;">Describe the sequence of events you observed when you restricted the flow.</p>
                <textarea class="answer-input" data-question="3" placeholder="Enter your answer here..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitQuestion(3)" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                  <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be saved and compared to the correct answer.</span>
                </div>
                <div class="individual-comparison hidden"></div>
              </div>
              
              <div class="question-item" data-question="4" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question 4: Why is it important to understand closed-loop control systems in industrial maintenance?</h4>
                <p style="color: #FFFFFF; margin-bottom: 15px;">Consider the practical applications and benefits you learned about in the "So What?" section.</p>
                <textarea class="answer-input" data-question="4" placeholder="Enter your answer here..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitQuestion(4)" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                  <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be saved and compared to the correct answer.</span>
                </div>
                <div class="individual-comparison hidden"></div>
              </div>
            </div>
          </div>

          <div class="simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);">
            <h2 class="section-header" style="color: #E91E63; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-line"></i> 5. PID Control Simulation</h2>
            
            <!-- Tab navigation for different simulation features -->
            <div class="simulation-tabs" style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                <button class="tab-button active" data-tab="tuning" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">PID Tuning</button>
                <button class="tab-button" data-tab="response" style="background: #555; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">System Response</button>
                <button class="tab-button" data-tab="challenges" style="background: #555; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Challenges</button>
            </div>

            <!-- PID Tuning Interface -->
            <div class="tab-content" id="tuning-tab">
                <!-- Main control panel for setpoint and process variable -->
                <div class="control-panel" style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; background: #333; padding: 20px; border-radius: 8px;">
                    <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="color: #FFFFFF; min-width: 80px; font-weight: bold;">Setpoint:</label>
                        <input type="range" id="setpoint-slider" min="0" max="100" value="50" style="width: 150px;">
                        <span id="setpoint-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 60px;">50.0C</span>
                    </div>
                    <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="color: #FFFFFF; min-width: 80px; font-weight: bold;">Process Variable:</label>
                        <span id="pv-value" class="value-display" style="color: #2196F3; font-weight: bold; min-width: 60px;">25.0C</span>
                    </div>
                </div>

                <!-- PID Parameter Tuning Panel -->
                <div class="pid-tuning-panel" style="background: #333; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                    <h4 style="color: #FFFFFF; margin-bottom: 20px; font-size: 18px;">PID Parameters</h4>
                    <div class="tuning-controls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        <!-- Proportional control -->
                        <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Proportional (Kp):</label>
                            <input type="range" id="kp-slider" min="0" max="2" step="0.1" value="0.5" style="flex: 1;">
                            <span id="kp-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.5</span>
                        </div>
                        <!-- Integral control -->
                        <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Integral (Ki):</label>
                            <input type="range" id="ki-slider" min="0" max="1" step="0.05" value="0.1" style="flex: 1;">
                            <span id="ki-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.1</span>
                        </div>
                        <!-- Derivative control -->
                        <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Derivative (Kd):</label>
                            <input type="range" id="kd-slider" min="0" max="1" step="0.05" value="0.2" style="flex: 1;">
                            <span id="kd-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.2</span>
                        </div>
                    </div>
                    <!-- Real-time performance metrics display -->
                    <div class="performance-metrics" style="display: flex; gap: 30px; flex-wrap: wrap; background: #222; padding: 20px; border-radius: 8px;">
                        <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; font-weight: bold;">Rise Time:</label>
                            <span id="rise-time" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0s</span>
                        </div>
                        <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; font-weight: bold;">Overshoot:</label>
                            <span id="overshoot" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0%</span>
                        </div>
                        <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; font-weight: bold;">Settling Time:</label>
                            <span id="settling-time" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0s</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Response Testing Interface -->
            <div class="tab-content hidden" id="response-tab">
                <div class="response-controls" style="display: flex; gap: 20px; align-items: center; margin-bottom: 25px; background: #333; padding: 20px; border-radius: 8px;">
                    <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="color: #FFFFFF; font-weight: bold;">Input Type:</label>
                        <select id="input-type" style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #222; color: #FFFFFF; font-weight: bold;">
                            <option value="step">Step</option>
                            <option value="ramp">Ramp</option>
                            <option value="sine">Sinusoidal</option>
                        </select>
                    </div>
                    <button id="start-response" class="action-button" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                        Start Test
                    </button>
                </div>
                <div class="response-graphs">
                    <canvas id="response-canvas" class="simulation-canvas" width="800" height="300" style="background: #222; border-radius: 8px; width: 100%; max-width: 800px; height: 300px; border: 2px solid #555;"></canvas>
                </div>
            </div>

            <!-- Interactive Challenges Interface -->
            <div class="tab-content hidden" id="challenges-tab">
                <div class="challenge-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px;">
                    <!-- Challenge 1: Minimal Overshoot -->
                    <div class="challenge-card" data-challenge="1" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                        <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-target"></i> Challenge 1: Minimal Overshoot</h4>
                        <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Tune the system to achieve less than 5% overshoot</p>
                        <button class="start-challenge" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Start Challenge</button>
                    </div>
                    <!-- Challenge 2: Fast Response -->
                    <div class="challenge-card" data-challenge="2" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                        <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-tachometer-alt"></i> Challenge 2: Fast Response</h4>
                        <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Achieve settling time under 3 seconds</p>
                        <button class="start-challenge" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Start Challenge</button>
                    </div>
                    <!-- Challenge 3: Disturbance Rejection -->
                    <div class="challenge-card" data-challenge="3" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                        <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-shield-alt"></i> Challenge 3: Disturbance Rejection</h4>
                        <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Maintain stable control with random disturbances</p>
                        <button class="start-challenge" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Start Challenge</button>
                    </div>
                </div>
            </div>

            <!-- Main simulation canvas for real-time visualization -->
            <canvas id="simulation-canvas" class="simulation-canvas" width="800" height="200" style="background: #222; border-radius: 8px; width: 100%; max-width: 800px; height: 200px; margin: 25px 0; border: 2px solid #555;"></canvas>
          </div>
        `;
        
        // Initialize the interactive features
        initializeInteractiveFeatures();
        
        // Initialize PID simulation
        setTimeout(() => {
          if (typeof initEnhancedPIDSimulation === 'function') {
            initEnhancedPIDSimulation();
          }
        }, 100);
        
        // Show the content
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        
        // Update navigation buttons
        setTimeout(updateNavigationButtons, 100);
        
      } catch (error) {
        console.error('Error rendering interactive worksheet:', error);
        renderWorksheet1Fallback();
      }
    }

    // Fallback function to render Worksheet 1 with basic content
    function renderWorksheet1Fallback() {
      const container = document.getElementById('worksheet-content');
      
      container.innerHTML = `
        <h1 class="page-title">
          Worksheet 1: Closed-Loop Control Systems
        </h1>

        <div class="worksheet-section introduction-section">
          <h2 class="section-header">1. Introduction</h2>
          <div class="worksheet-content">
            <p>The system you have in front of you is a Closed-Loop Flow Control system, meaning it continuously adjusts itself to meet a desired target, called the setpoint. It does this by using feedback from sensors to control devices like pumps and valves, keeping the system accurate and stable even if conditions change.</p>
            
            <div class="cad-images" style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
              <figure style="text-align: center;">
                <img src="assets/cad.png" alt="CAD Diagram 1" style="max-width: 300px; height: auto; border-radius: 4px;">
                <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Front View</figcaption>
              </figure>
              <figure style="text-align: center;">
                <img src="assets/cad2.png" alt="CAD Diagram 2" style="max-width: 300px; height: auto; border-radius: 4px;">
                <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Side View</figcaption>
              </figure>
            </div>
          </div>
        </div>

        <div class="worksheet-section over-to-you-section">
          <h2 class="section-header">2. Over To You</h2>
          <div class="worksheet-content">
            <p style="color: #FFFFFF; margin-bottom: 20px; font-weight: bold;">Select Start and observe the system start up. Once the pump is running you should see water flow through the flow gauge. Ensure the hand valve is in the open position, (the handle should be in line with the piping).</p>
            
            <div class="steps-container">
              <div class="step-card" data-step="1" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Set a Flow Rate</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Enter a target flow rate on the HMI. You can adjust in increments of 20 using the +/- buttons.</p>
                </div>
              </div>

              <div class="step-card" data-step="2" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Observe Feedback</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Watch the flow sensor reading on the HMI and compare it to the setpoint.</p>
                </div>
              </div>

              <div class="step-card" data-step="3" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Watch the System Adjust</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Note how the pump speed and valve position change to bring the flow rate to the setpoint.</p>
                </div>
              </div>

              <div class="step-card" data-step="4" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Introduce a Disturbance</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Temporarily restrict the flow (e.g., partially close the shut-off valve) and observe how the system reacts to maintain the flow rate.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="so-what-section" style="background: #2d2d2d; border-radius: 8px; padding: 20px; margin-top: 30px; border-left: 4px solid #4CAF50;">
          <h2 class="section-header" style="color: #FFFFFF; margin-bottom: 20px;">So What?</h2>
          <div class="so-what-content">
            <p style="color: #FFFFFF; margin-bottom: 20px;">This is part of a control system, which automates processes in Industry. At the heart of this system is a PLC (Programmable Logic Controller), a computer that makes real-time decisions based on sensor data. The HMI (Human-Machine Interface) allows you to monitor and adjust settings easily.</p>
            
            <div class="key-point" style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
              <i class="fas fa-lightbulb" style="font-size: 24px; color: #4CAF50; margin-top: 4px;"></i>
              <div>
                <strong style="display: block; color: #4CAF50; margin-bottom: 8px; font-size: 18px;">Control Loop in Action:</strong>
                <p style="margin: 0; color: #FFFFFF;">Restricting the hand valve reduced flow, which the sensor detected and sent to the PLC. The PLC increased pump speed and adjusted the valve to restore flow, showing automatic correction.</p>
              </div>
            </div>

            <div class="key-point" style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
              <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #4CAF50; margin-top: 4px;"></i>
              <div>
                <strong style="display: block; color: #4CAF50; margin-bottom: 8px; font-size: 18px;">System Behavior:</strong>
                <p style="margin: 0; color: #FFFFFF;">Rapid valve changes caused oscillations, highlighting the need for gradual adjustments. Fully closing the valve stopped flow; the PLC responded by maxing the pump and opening the valve, but no water moved.</p>
              </div>
            </div>

            <div class="key-point" style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
              <i class="fas fa-info-circle" style="font-size: 24px; color: #4CAF50; margin-top: 4px;"></i>
              <div>
                <strong style="display: block; color: #4CAF50; margin-bottom: 8px; font-size: 18px;">Important Takeaway:</strong>
                <p style="margin: 0; color: #FFFFFF;">This demonstrates risks like pressure buildup and why managing flow restrictions is critical.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="worksheet-section">
          <h2 class="section-header">Questions and Answers</h2>
          <div class="questions-section">
            <div class="question-item" data-question="1" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">1. What is the purpose of a closed-loop control system?</div>
              <textarea class="answer-input" data-question="1" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(1)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> To continuously adjust flow using sensor feedback to meet a setpoint, maintaining accuracy and stability even if conditions change.
              </div>
            </div>

            <div class="question-item" data-question="2" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">2. What should you ensure about the hand valve before starting the system?</div>
              <textarea class="answer-input" data-question="2" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(2)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> Ensure the hand valve is in the open position, with the handle in line with the piping.
              </div>
            </div>

            <div class="question-item" data-question="3" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">3. What happens when you restrict the flow by partially closing the shut-off valve?</div>
              <textarea class="answer-input" data-question="3" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(3)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> The flow drops, the sensor detects this and sends data to the PLC, which increases pump speed and adjusts the valve to restore flow.
              </div>
            </div>

            <div class="question-item" data-question="4" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">4. What is the role of the PLC in this system?</div>
              <textarea class="answer-input" data-question="4" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(4)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> The PLC is a computer that makes real-time decisions based on sensor data to control devices like pumps and valves.
              </div>
            </div>

            <div class="question-item" data-question="5" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">5. Why can rapid valve changes cause problems?</div>
              <textarea class="answer-input" data-question="5" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(5)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> Rapid changes can cause oscillations in flow, making the system unstable; gradual adjustments help maintain smooth control.
              </div>
            </div>
          </div>
        </div>

        <div class="note" style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #FFC107; padding: 15px; margin-top: 20px; border-radius: 4px;">
          <p style="color: #FFC107; margin: 0; font-style: italic;"><strong>Note:</strong> This is a simplified version of Worksheet 1. The full interactive version with PID simulation is temporarily unavailable.</p>
        </div>
      `;

      // Initialize basic step completion functionality
      initializeBasicWorksheet1Features();
      
      // Show the content
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      
      // Update navigation buttons
      setTimeout(updateNavigationButtons, 100);
    }

    // Initialize the original Worksheet 1 features
    function initializeOriginalWorksheet1Features() {
      // Initialize step completion functionality
      const stepCards = document.querySelectorAll('.step-card');
      stepCards.forEach(card => {
        const checkbox = card.querySelector('.step-complete-checkbox');
        const stepNumber = card.dataset.step;
        
        // Load saved state
        const savedState = localStorage.getItem(`worksheet1_step${stepNumber}_complete`);
        if (savedState === 'true') {
          checkbox.checked = true;
          card.classList.add('step-completed');
        }

        // Function to toggle step completion
        const toggleStep = (e) => {
          // Don't toggle if clicking the checkbox itself
          if (e.target.type === 'checkbox') return;
          
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            card.classList.add('step-completed');
          } else {
            card.classList.remove('step-completed');
          }
          
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, checkbox.checked);
        };

        card.addEventListener('click', toggleStep);
        
        // Also handle checkbox changes
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            card.classList.add('step-completed');
          } else {
            card.classList.remove('step-completed');
          }
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, e.target.checked);
        });
      });

      // Initialize tab system if present
      if (typeof initTabSystem === 'function') {
        initTabSystem();
      }
      
      // Initialize PID simulation if present
      if (typeof initEnhancedPIDSimulation === 'function') {
        initEnhancedPIDSimulation();
      }
    }

    // Render regular worksheet from JSON data
    function renderWorksheet(scenario, type) {
      const container = document.getElementById('worksheet-content');
      
      // Build content sections based on available data
      let contentSections = [];
      
      // Always include title
      contentSections.push(`<h1 class="page-title">${type === 'fault' ? 'Fault Scenario' : 'Worksheet'} ${scenario.id}: ${scenario.title}</h1>`);
      
      // Introduction/Description section (always present if paragraphs exist)
      if (scenario.paragraphs && scenario.paragraphs.length > 0) {
        contentSections.push(`
          <div class="worksheet-section introduction-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);">
            <h2 class="section-header" style="color: #2196F3; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-info-circle"></i> Introduction
            </h2>
            <div class="worksheet-content">
              ${scenario.paragraphs.map(p => `<p style="color: #FFFFFF; margin-bottom: 15px;">${p}</p>`).join('')}
            </div>
          </div>
        `);
      }
      
      // System Diagram section (only if image exists)
      if (scenario.image) {
        contentSections.push(`
          <div class="worksheet-section diagram-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FF9800; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.2);">
            <h2 class="section-header" style="color: #FF9800; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-image"></i> System Diagram
            </h2>
            <div class="worksheet-content" style="text-align: center;">
              <img src="assets/${type === 'fault' ? 'scenarios' : 'maintenance'}/${scenario.image}" 
                   alt="${scenario.title}" class="scenario-image" style="max-width: 100%; height: auto; border-radius: 8px;">
            </div>
          </div>
        `);
      }
      
      // Steps section (only if steps exist)
      if (scenario.steps && scenario.steps.length > 0) {
        contentSections.push(`
          <div class="worksheet-section steps-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);">
            <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-list-ol"></i> Steps to Complete
            </h2>
            <div class="worksheet-content">
              ${scenario.steps.map((step, index) => `
                <div class="step-card" data-step="${index + 1}" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">${index + 1}</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">${step.title || `Step ${index + 1}`}</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">${step.description || step}</p>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `);
      }
      
      // Educational content section (only if soWhat exists)
      if (scenario.soWhat && (scenario.soWhat.content || scenario.soWhat.keyPoints)) {
        contentSections.push(`
          <div class="worksheet-section educational-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);">
            <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-lightbulb"></i> So What?
            </h2>
            <div class="worksheet-content">
              ${scenario.soWhat.content ? `<p style="color: #FFFFFF; margin-bottom: 20px;">${scenario.soWhat.content}</p>` : ''}
              ${scenario.soWhat.keyPoints ? scenario.soWhat.keyPoints.map(point => `
                <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                  <i class="fas fa-lightbulb" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                  <div>
                    <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">${point.title}</strong>
                    <p style="color: #FFFFFF; margin: 0;">${point.description}</p>
                  </div>
                </div>
              `).join('') : ''}
            </div>
          </div>
        `);
      }
      
      // Questions section (only if questions exist)
      if (scenario.questions && scenario.questions.length > 0) {
        contentSections.push(`
          <div class="worksheet-section questions-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #4CAF50; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.2);">
            <h2 class="section-header" style="color: #4CAF50; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-question-circle"></i> Questions
            </h2>
            <div class="worksheet-content">
              ${scenario.questions.map((q, index) => `
                <div class="question-item" data-question="${index + 1}" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                  <h4 style="color: #FFFFFF; margin-bottom: 10px;">${index + 1}. ${q.text}</h4>
                  <textarea class="answer-input" data-question="${index + 1}" 
                           placeholder="${q.placeholder || 'Enter your answer here...'}" 
                           style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                  <div class="question-actions" style="margin-top: 15px;">
                    <button class="submit-question-btn" onclick="submitAnswer(${index + 1})" 
                            style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                      Submit Answer
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `);
      }
      
      // Simulation section (only if simulation exists)
      if (scenario.simulation) {
        contentSections.push(`
          <div class="worksheet-section simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.2);">
            <h2 class="section-header" style="color: #E91E63; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-chart-line"></i> ${scenario.simulation.title || 'Interactive Simulation'}
            </h2>
            <div class="worksheet-content">
              <p style="color: #FFFFFF; margin-bottom: 20px;">${scenario.simulation.description || 'Interactive simulation content will be loaded here.'}</p>
              <div id="simulation-container" style="background: #333; padding: 20px; border-radius: 8px;">
                <p style="color: #FFFFFF; text-align: center;">Simulation functionality available for enhanced worksheets.</p>
              </div>
            </div>
          </div>
        `);
      }
      
      // Combine all sections
      container.innerHTML = contentSections.join('');
      
      // Initialize interactive features if steps exist
      if (scenario.steps && scenario.steps.length > 0) {
        initializeStepTracking();
      }
      
      // Load saved answers
      setTimeout(loadSavedAnswers, 100);
      
      // Show the content
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
    }
    
    // Initialize step tracking for regular worksheets
    function initializeStepTracking() {
      const stepCards = document.querySelectorAll('.step-card');
      stepCards.forEach(card => {
        const checkbox = card.querySelector('.step-complete-checkbox');
        const stepNumber = card.dataset.step;
        
        if (!checkbox) return;
        
        // Load saved state
        const worksheetId = getUrlParameter('id');
        const type = getUrlParameter('type') || 'maintenance';
        const savedState = localStorage.getItem(`${type}_worksheet_${worksheetId}_step${stepNumber}_complete`);
        
        if (savedState === 'true') {
          checkbox.checked = true;
          card.style.opacity = '0.7';
        }

        // Function to toggle step completion
        const toggleStep = (e) => {
          // Don't toggle if clicking the checkbox itself
          if (e.target.type === 'checkbox') return;
          
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          
          localStorage.setItem(`${type}_worksheet_${worksheetId}_step${stepNumber}_complete`, checkbox.checked);
        };

        card.addEventListener('click', toggleStep);
        
        // Also handle checkbox changes
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          localStorage.setItem(`${type}_worksheet_${worksheetId}_step${stepNumber}_complete`, e.target.checked);
        });
      });
    }

    // Submit answer function for regular worksheets
    function submitAnswer(questionNum) {
      const textarea = document.querySelector(`textarea[data-question="${questionNum}"]`);
      const button = document.querySelector(`button[onclick="submitAnswer(${questionNum})"]`);
      
      if (textarea && button) {
        const userAnswer = textarea.value.trim();
        
        if (userAnswer === '') {
          alert('Please provide an answer before submitting.');
          return;
        }
        
        // Disable textarea and button
        textarea.disabled = true;
        button.textContent = 'Submitted';
        button.disabled = true;
        button.style.backgroundColor = '#4CAF50';
        button.style.cursor = 'not-allowed';
        
        // Save answer
        const worksheetId = getUrlParameter('id');
        const type = getUrlParameter('type') || 'maintenance';
        const key = `${type}_worksheet_${worksheetId}_answer_${questionNum}`;
        localStorage.setItem(key, userAnswer);
        
        // Load saved answers on page load
        loadSavedAnswers();
        
        console.log('Answer submitted for question', questionNum, ':', userAnswer);
      }
    }
    
    // Load saved answers when page loads
    function loadSavedAnswers() {
      const worksheetId = getUrlParameter('id');
      const type = getUrlParameter('type') || 'maintenance';
      
      // Find all question textareas
      const textareas = document.querySelectorAll('textarea[data-question]');
      textareas.forEach(textarea => {
        const questionNum = textarea.dataset.question;
        const key = `${type}_worksheet_${worksheetId}_answer_${questionNum}`;
        const savedAnswer = localStorage.getItem(key);
        
        if (savedAnswer) {
          textarea.value = savedAnswer;
          textarea.disabled = true;
          
          // Also disable the corresponding button
          const button = document.querySelector(`button[onclick="submitAnswer(${questionNum})"]`);
          if (button) {
            button.textContent = 'Submitted';
            button.disabled = true;
            button.style.backgroundColor = '#4CAF50';
            button.style.cursor = 'not-allowed';
          }
        }
      });
    }

    // Show error message
    function showError(message) {
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('error-container').style.display = 'block';
      const errorText = document.querySelector('#error-container p');
      if (errorText) {
        errorText.textContent = message;
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Small delay to allow URL parameters to be set by main process
      setTimeout(loadWorksheet, 100);
    });

    // Initialize basic Worksheet 1 features for fallback
    function initializeBasicWorksheet1Features() {
      // Initialize step completion functionality
      const stepCards = document.querySelectorAll('.step-card');
      stepCards.forEach(card => {
        const checkbox = card.querySelector('.step-complete-checkbox');
        const stepNumber = card.dataset.step;
        
        // Load saved state
        const savedState = localStorage.getItem(`worksheet1_step${stepNumber}_complete`);
        if (savedState === 'true') {
          checkbox.checked = true;
          card.style.opacity = '0.7';
        }

        // Function to toggle step completion
        const toggleStep = (e) => {
          // Don't toggle if clicking the checkbox itself
          if (e.target.type === 'checkbox') return;
          
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, checkbox.checked);
        };

        card.addEventListener('click', toggleStep);
        
        // Also handle checkbox changes
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, e.target.checked);
        });
      });
    }

    // Submit answer function for Worksheet 1 questions
    window.submitWorksheet1Question = function(questionNum) {
      const textarea = document.querySelector(`textarea[data-question="${questionNum}"]`);
      const button = document.querySelector(`button[onclick="submitWorksheet1Question(${questionNum})"]`);
      const correctAnswerDiv = document.querySelector(`.question-item[data-question="${questionNum}"] .correct-answer`);
      
      if (textarea && button && correctAnswerDiv) {
        const userAnswer = textarea.value.trim();
        
        if (userAnswer === '') {
          alert('Please provide an answer before submitting.');
          return;
        }
        
        // Disable textarea and button
        textarea.disabled = true;
        button.textContent = 'Submitted';
        button.disabled = true;
        button.style.backgroundColor = '#4CAF50';
        
        // Show correct answer
        correctAnswerDiv.style.display = 'block';
        
        // Save answer
        const key = `worksheet1_answer_${questionNum}`;
        localStorage.setItem(key, userAnswer);
        
        console.log('Question', questionNum, 'submitted:', userAnswer);
      }
    };

    // Navigation function for worksheet buttons
    function navigateWorksheet(direction) {
      const currentId = parseInt(getUrlParameter('id'));
      const currentType = getUrlParameter('type') || 'maintenance';
      
      let nextId;
      if (direction === 'next') {
        nextId = currentType === 'maintenance' ? Math.min(currentId + 1, 14) : Math.min(currentId + 1, 8);
      } else if (direction === 'prev') {
        nextId = Math.max(currentId - 1, 1);
      }
      
      if (nextId && nextId !== currentId) {
        window.electron.navigate(`worksheet.html?id=${nextId}&type=${currentType}`);
      }
    }

    // Update navigation button states
    function updateNavigationButtons() {
      const currentId = parseInt(getUrlParameter('id'));
      const currentType = getUrlParameter('type') || 'maintenance';
      const maxId = currentType === 'maintenance' ? 14 : 8;
      
      const prevBtn = document.querySelector('.prev-btn');
      const nextBtn = document.querySelector('.next-btn');
      
      if (prevBtn) {
        prevBtn.disabled = currentId <= 1;
      }
      
      if (nextBtn) {
        nextBtn.disabled = currentId >= maxId;
      }
    }

    // Initialize interactive features for the enhanced worksheet
    function initializeInteractiveFeatures() {
      // Initialize step completion functionality
      const stepCards = document.querySelectorAll('.step-card');
      stepCards.forEach(card => {
        const checkbox = card.querySelector('.step-complete-checkbox');
        const stepNumber = card.dataset.step;
        
        // Load saved state
        const savedState = localStorage.getItem(`worksheet1_step${stepNumber}_complete`);
        if (savedState === 'true') {
          checkbox.checked = true;
          card.style.opacity = '0.7';
        }

        // Function to toggle step completion
        const toggleStep = (e) => {
          // Don't toggle if clicking the checkbox itself
          if (e.target.type === 'checkbox') return;
          
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, checkbox.checked);
        };

        card.addEventListener('click', toggleStep);
        
        // Also handle checkbox changes
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, e.target.checked);
        });
      });

      // Initialize Q&A functionality
      const submitBtns = document.querySelectorAll('.submit-question-btn');
      submitBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const questionNum = this.getAttribute('onclick').match(/\d+/)[0];
          submitInteractiveQuestion(parseInt(questionNum));
        });
      });

      // Initialize tab system
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          const tabName = e.target.dataset.tab;
          switchTab(tabName);
        });
      });
    }

    // Tab switching function for PID simulation
    function switchTab(tabName) {
      // Hide all tab contents
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(content => {
        content.classList.add('hidden');
      });

      // Remove active class from all buttons
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => {
        button.classList.remove('active');
        button.style.background = '#555';
      });

      // Show selected tab content
      const selectedTab = document.getElementById(`${tabName}-tab`);
      if (selectedTab) {
        selectedTab.classList.remove('hidden');
      }

      // Add active class to selected button
      const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
      if (selectedButton) {
        selectedButton.classList.add('active');
        selectedButton.style.background = '#E91E63';
      }
    }

    // Submit question function for interactive worksheet
    function submitInteractiveQuestion(questionNum) {
      const textarea = document.querySelector(`textarea[data-question="${questionNum}"]`);
      const button = document.querySelector(`button[onclick*="${questionNum}"]`);
      const questionItem = document.querySelector(`.question-item[data-question="${questionNum}"]`);
      
      if (textarea && button && questionItem) {
        const userAnswer = textarea.value.trim();
        
        if (userAnswer === '') {
          alert('Please provide an answer before submitting.');
          return;
        }
        
        // Disable textarea and button
        textarea.disabled = true;
        button.textContent = 'Submitted';
        button.disabled = true;
        button.style.backgroundColor = '#4CAF50';
        
        // Show a simple confirmation
        const comparison = questionItem.querySelector('.individual-comparison');
        if (comparison) {
          comparison.innerHTML = `
            <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 4px; margin-top: 15px; border-left: 3px solid #4CAF50;">
              <strong style="color: #4CAF50;">Answer Submitted!</strong>
              <p style="color: #FFFFFF; margin: 5px 0 0 0;">Your answer has been saved. Great job working through this question!</p>
            </div>
          `;
          comparison.classList.remove('hidden');
        }
        
        // Save answer
        const key = `worksheet1_interactive_answer_${questionNum}`;
        localStorage.setItem(key, userAnswer);
        
        console.log('Interactive question', questionNum, 'submitted:', userAnswer);
      }
    }

    // Global function for Worksheet 1 questions (called from original popup code)
    window.submitQuestion = function(questionNum) {
      // This will be handled by the original popup code
      console.log('Question submitted:', questionNum);
    };
  </script>
</body>
</html> 