<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matrix TSL - Worksheet</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="assets/icons/matrix-icon.ico">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* Multiple Choice Question Styles */
    .option-label {
      transition: all 0.3s ease !important;
    }
    
    .option-label:hover {
      background: #444 !important;
      border-color: var(--accent-color) !important;
    }
    
    .option-label input[type="radio"]:checked + span {
      color: var(--accent-color) !important;
      font-weight: bold;
    }
    
    .option-label input[type="radio"]:checked {
      accent-color: var(--accent-color);
    }
    
    .answer-feedback {
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Navigation Styles */
    .main-navigation {
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      border-bottom: 3px solid #FFFFFF;
      padding: 0;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .nav-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .nav-logo {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 0;
    }
    
    .nav-logo img {
      height: 40px;
      width: auto;
    }
    
    .nav-logo h1 {
      color: #FFFFFF;
      font-size: 18px;
      font-weight: bold;
      margin: 0;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }
    
    .nav-menu {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
      gap: 5px;
    }
    
    .nav-item {
      position: relative;
    }
    
    .nav-link {
      display: block;
      padding: 15px 25px;
      color: #ffffff;
      text-decoration: none;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      border-radius: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: linear-gradient(135deg, #333333, #555555);
      border: 2px solid transparent;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }
    
    .nav-link:hover {
      background: linear-gradient(135deg, #FFFFFF, #F5F5F5);
      color: #000;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(255, 255, 255, 0.4);
      border: 2px solid #FFFFFF;
    }
    
    .nav-link.active {
      background: linear-gradient(135deg, #FFFFFF, #F5F5F5);
      color: #000;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.5);
      border: 2px solid #FFFFFF;
    }

    /* Keep the standard app background with Matrix logo scrolling */
    body {
      background: linear-gradient(135deg, #2c3033 0%, #1a1d20 100%) !important;
    }

    /* Ensure the Matrix logo pattern is visible */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      z-index: 0;
      background-image: url('./assets/matrix-logo.png');
      background-size: 150px;
      background-repeat: repeat;
      opacity: 0.03;
      transform: rotate(-45deg);
      pointer-events: none;
      animation: slideBackground 120s linear infinite;
    }

    /* Worksheet Box Styling - Force solid background */
    .worksheet-box {
      max-width: 1200px;
      margin: 20px auto;
      background: #1a1a1a !important;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      border: 2px solid #333;
      position: relative;
      z-index: 10;
    }

    /* Additional solid background overrides */
    .worksheet-container {
      background: transparent !important;
      position: relative;
      z-index: 1;
    }

    .loading-container {
      background: #2c3033 !important;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .loading-content {
      background: #1a1a1a !important;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid #333;
    }

    .error-container {
      background: #2c3033 !important;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    /* Ensure all content areas have solid backgrounds */
    .worksheet-content,
    #worksheet-content {
      background: transparent !important;
    }

    /* Override any remaining transparent backgrounds */
    .scenario-info,
    .scenario-introduction,
    .scenario-content {
      background: #1a1a1a !important;
    }

    /* Make sure step cards are solid */
    .step-card {
      background: #222 !important;
    }

    .step-card.step-completed {
      background: #1a2f1a !important;
    }

    /* Ensure question items are solid */
    .question-item {
      background: #333 !important;
    }

    /* Navigation Buttons */
    .worksheet-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid #444;
      gap: 15px;
      flex-wrap: wrap;
    }

    .nav-btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 160px;
      justify-content: center;
    }

    .nav-btn:hover {
      background: linear-gradient(135deg, #45a049, #4CAF50);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }

    .nav-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .back-to-list-btn {
      background: linear-gradient(135deg, #2196F3, #1976D2);
    }

    .back-to-list-btn:hover {
      background: linear-gradient(135deg, #1976D2, #2196F3);
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
    }

    /* Back to Worksheets Button Styling */
    .back-btn {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }

    .back-btn:hover {
      background: linear-gradient(135deg, #1976D2, #2196F3);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
    }

    .back-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
    }

    .back-btn i {
      font-size: 16px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .worksheet-box {
        margin: 10px;
        padding: 20px;
      }
      
      .worksheet-navigation {
        flex-direction: column;
        gap: 10px;
      }
      
      .nav-btn {
        width: 100%;
        max-width: 300px;
      }
    }

    /* Improve content spacing within the box */
    .worksheet-box .page-title {
      margin-top: 0;
      margin-bottom: 30px;
    }

    .worksheet-box .worksheet-section {
      margin-bottom: 30px;
    }

    .worksheet-box .so-what-section {
      margin-top: 30px;
      margin-bottom: 30px;
    }

    /* Hidden class for tab system */
    .hidden {
      display: none !important;
    }

    /* Fallback styling for basic worksheets */
    .worksheet-section {
      margin-bottom: 30px;
      background: #1a1a1a !important;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #333;
    }

    .section-header {
      color: #4CAF50;
      margin-bottom: 20px;
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

        .scenario-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }

    /* Force all dynamically created sections to have solid backgrounds */
    .worksheet-box .introduction-section,
    .worksheet-box .diagram-section,
    .worksheet-box .steps-section,
    .worksheet-box .educational-section,
    .worksheet-box .questions-section,
    .worksheet-box .simulation-section,
    .worksheet-box .worksheet-section {
      background: #1a1a1a !important;
      position: relative;
      z-index: 11;
    }

    /* Force all inner elements to have solid backgrounds */
    .worksheet-box .key-point,
    .worksheet-box .step-card,
    .worksheet-box .question-item,
    .worksheet-box #simulation-container {
      background: #333 !important;
      position: relative;
      z-index: 12;
    }

    .worksheet-box .answer-input,
    .worksheet-box textarea {
      background: #222 !important;
      position: relative;
      z-index: 12;
    }

    /* Make sure the worksheet content area itself is solid */
    .worksheet-box #worksheet-content {
      background: transparent !important;
      position: relative;
      z-index: 11;
    }

    /* Animation for the Matrix logo background */
    @keyframes slideBackground {
      0% {
        transform: rotate(-45deg) translate(0, 0);
      }
      100% {
        transform: rotate(-45deg) translate(-100px, -100px);
      }
    }

    /* Enhanced button styling */
    .submit-question-btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .submit-question-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #45a049, #4CAF50);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }

    .submit-question-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Step card styling */
    .step-card {
      transition: all 0.3s ease;
    }

    .step-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .step-card.step-completed {
      opacity: 0.7;
      background: #2a2a2a;
    }

    /* Checkbox styling */
    .step-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #4CAF50;
      cursor: pointer;
    }

    /* Question item styling */
    .question-item {
      transition: all 0.3s ease;
    }

    .question-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    /* Text styling improvements */
    .worksheet-content p {
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .key-point {
      transition: all 0.3s ease;
    }

    .key-point:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
    }

    /* New CSS styles for .simulator-grid, .sim-card, and responsive layout */
    .simulator-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 900px) {
      .simulator-grid {
        grid-template-columns: 1fr;
      }
    }
    .sim-card {
      background: #222;
      border-radius: 10px;
      padding: 18px 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 0;
    }
    .sim-card label {
      color: #fff;
      font-weight: bold;
      margin-bottom: 8px;
      text-align: center;
    }
    .sim-card span {
      color: #4CAF50;
      font-size: 1.2em;
      font-weight: bold;
    }
    .sim-card input[type=range] {
      width: 100%;
      margin: 8px 0 0 0;
    }
    .sim-status {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    #system-chart {
      width: 100% !important;
      height: 220px !important;
      max-width: 100%;
      display: block;
      margin: 0 auto;
      background: #181818;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="main-navigation">
    <div class="nav-container">
      <div class="nav-logo">
        <img src="assets/matrix-logo.png" alt="Matrix Logo">
        <h1>Inspiring the Next Generation of Engineers</h1>
      </div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" onclick="window.location='index.html'" class="nav-link">
            <i class="fas fa-home"></i> HOME
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='CP2388-worksheets.html'" class="nav-link">
            <i class="fas fa-cogs"></i> CP2388
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='cp6773-worksheets.html'" class="nav-link">
            <i class="fas fa-exclamation-triangle"></i> CP6773
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='settings.html'" class="nav-link">
            <i class="fas fa-gear"></i> SETTINGS
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Loading State -->
  <div id="loading-container" class="loading-container">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Loading worksheet...</p>
    </div>
  </div>

  <!-- Error State -->
  <div id="error-container" class="error-container" style="display: none;">
    <h3><i class="fas fa-exclamation-triangle"></i> Worksheet Not Found</h3>
    <p>The requested worksheet could not be loaded.</p>
    <button class="back-btn">
      <i class="fas fa-arrow-left"></i> Back to Worksheets
    </button>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    
    <div id="main-content" class="worksheet-container" style="display: none;">
      <!-- Back Navigation -->
      <div class="back-nav">
        <button class="back-btn">
          <i class="fas fa-arrow-left"></i> Back to Worksheets
        </button>
      </div>

      <!-- Boxed Worksheet Content -->
      <div class="worksheet-box">
        <!-- Dynamic Content Will Be Loaded Here -->
        <div id="worksheet-content"></div>
        
        <!-- Navigation Buttons -->
        <div class="worksheet-navigation">
          <button class="nav-btn prev-btn" onclick="navigateWorksheet('prev')">
            <i class="fas fa-chevron-left"></i> Previous Worksheet
          </button>
          <button class="nav-btn next-btn" onclick="navigateWorksheet('next')">
            Next Worksheet <i class="fas fa-chevron-right"></i>
          </button>
          <button class="nav-btn back-to-list-btn">
            <i class="fas fa-list"></i> All Worksheets
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="scenario-popup.js"></script>
  
  <script>
    console.log('Scripts loaded, checking for functions...');
    console.log('showInteractiveWorksheet1 available:', typeof showInteractiveWorksheet1);
    console.log('window.showInteractiveWorksheet1 available:', typeof window.showInteractiveWorksheet1);
  </script>
  
  <script>
    // Get URL parameters
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Get the correct worksheets page URL based on worksheet type
    function getWorksheetsPageUrl() {
      const type = getUrlParameter('type') || 'maintenance';
      return type === 'fault' ? 'cp6773-worksheets.html' : 'CP2388-worksheets.html';
    }

    // Update back button destinations
    function updateBackButtons() {
      const worksheetsUrl = getWorksheetsPageUrl();
      const backButtons = document.querySelectorAll('.back-btn, .back-to-list-btn');
      
      backButtons.forEach(button => {
        button.onclick = function() {
          window.location.href = worksheetsUrl;
        };
      });
    }

    // Load worksheet data
    async function loadWorksheet() {
      try {
        // Debug: Log the current URL and search parameters
        console.log('Current URL:', window.location.href);
        console.log('Search params:', window.location.search);
        
        const worksheetId = getUrlParameter('id');
        const type = getUrlParameter('type') || 'maintenance';
        
        console.log('Worksheet ID:', worksheetId);
        console.log('Type:', type);
        
        if (!worksheetId) {
          showError('No worksheet ID specified');
          return;
        }

        // Load data for worksheets
        const filename = type === 'fault' ? 'dbFaultScenarios.json' : 'dbMaintenanceScenarios.json';
        const response = await fetch(filename);
        const data = await response.json();
        
        const scenario = data.scenarios.find(s => s.id === parseInt(worksheetId));
        if (!scenario) {
          showError('Worksheet not found');
          return;
        }

        // Log worksheet structure for debugging
        console.log('Loading worksheet:', scenario.title);
        console.log('Worksheet structure analysis:', analyzeWorksheetStructure(scenario));

        // Check worksheet type and render accordingly
        if (type === 'maintenance') {
          // All maintenance worksheets use the enhanced format with all sections
          console.log(`Rendering enhanced maintenance worksheet: ${scenario.title}`);
          renderEnhancedMaintenanceWorksheet(scenario);
              } else if (type === 'fault') {
        // Check if this is the enhanced fault scenario 1
        if (scenario.id === 1) {
          console.log(`Rendering interactive fault scenario: ${scenario.title}`);
          renderInteractiveFaultScenario1(scenario);
        } else {
          // Other fault scenarios use basic format (to be enhanced later)
          console.log(`Rendering fault scenario: ${scenario.title}`);
          renderFaultScenario(scenario);
        }
      } else {
        // Fallback for any other types
        renderWorksheet(scenario, type);
      }
        
      } catch (error) {
        console.error('Error loading worksheet:', error);
        showError('Failed to load worksheet');
      } finally {
        // Update navigation buttons for all worksheets
        setTimeout(updateNavigationButtons, 100);
      }
    }
    
    // Analyze worksheet structure for debugging
    function analyzeWorksheetStructure(scenario) {
      const analysis = {
        hasTitle: !!scenario.title,
        hasParagraphs: !!((scenario.introduction || scenario.paragraphs) && (scenario.introduction || scenario.paragraphs).length > 0),
        hasImage: !!scenario.image,
        hasSteps: !!(scenario.steps && scenario.steps.length > 0),
        hasEducationalContent: !!(scenario.soWhat && (scenario.soWhat.content || scenario.soWhat.keyPoints)),
        hasQuestions: !!(scenario.questions && scenario.questions.length > 0),
        hasSimulation: !!scenario.simulation,
        hasFunctionCall: !!scenario.functionCall,
        sectionsToShow: []
      };
      
      // Determine which sections will be shown
      if (analysis.hasTitle) analysis.sectionsToShow.push('Title');
      if (analysis.hasParagraphs) analysis.sectionsToShow.push('Introduction');
      if (analysis.hasImage) analysis.sectionsToShow.push('System Diagram');
      if (analysis.hasSteps) analysis.sectionsToShow.push('Steps');
      if (analysis.hasEducationalContent) analysis.sectionsToShow.push('Educational Content');
      if (analysis.hasQuestions) analysis.sectionsToShow.push('Questions');
      if (analysis.hasSimulation) analysis.sectionsToShow.push('Simulation');
      
      return analysis;
    }

    // Generate enhanced content based on worksheet topic
    function generateEnhancedContent(scenario) {
      const worksheetId = scenario.id;
      const title = scenario.title;
      
      // Define content templates for each worksheet
      const contentTemplates = {
        1: {
          instructions: "Select Start and observe the system start up. Once the pump is running you should see water flow through the flow gauge. Ensure the hand valve is in the open position, (the handle should be in line with the piping).",
          steps: [
            { title: "Set a Flow Rate", description: "Enter a target flow rate on the HMI. You can adjust in increments of 20 using the +/- buttons." },
            { title: "Observe Feedback", description: "Watch the flow sensor reading on the HMI and compare it to the setpoint." },
            { title: "Watch the System Adjust", description: "Note how the pump speed and valve position change to bring the flow rate to the setpoint." },
            { title: "Introduce a Disturbance", description: "Temporarily restrict the flow (e.g., partially close the shut-off valve) and observe how the system reacts to maintain the flow rate." }
          ],
          soWhat: {
            intro: "This is part of a control system, which automates processes in Industry. At the heart of this system is a PLC (Programmable Logic Controller), a computer that makes real-time decisions based on sensor data. The HMI (Human-Machine Interface) allows you to monitor and adjust settings easily.",
            keyPoints: [
              { title: "Feedback Control", description: "The system continuously measures the actual flow rate and compares it to the desired setpoint. If there's a difference, it automatically adjusts the pump speed or valve position to correct it." },
              { title: "Real-Time Automation", description: "The PLC processes sensor data and makes control decisions in milliseconds, far faster than any human could react. This ensures consistent, accurate control even when conditions change." },
              { title: "Stability & Reliability", description: "Closed-loop systems are self-correcting. If something tries to disturb the process (like partially closing a valve), the system automatically compensates to maintain the desired flow rate." },
              { title: "Industrial Applications", description: "These principles are used everywhere in industry - from temperature control in manufacturing to pressure regulation in chemical plants. Understanding this system gives you insight into how modern automation works." }
            ]
          }
        },
        2: {
          instructions: "Examine the emergency stop systems located throughout the facility. These critical safety devices must be tested regularly to ensure they function properly when needed.",
          steps: [
            { title: "Visual Inspection", description: "Check each E-stop button for physical damage, proper mounting, and clear labeling. Ensure the button is not stuck or damaged." },
            { title: "Mechanical Test", description: "Press each E-stop button to verify it latches properly and requires intentional rotation to reset." },
            { title: "Circuit Verification", description: "Use a multimeter to verify the E-stop contacts open properly when activated and close when reset." },
            { title: "System Response Test", description: "Test that the system properly shuts down when E-stop is activated and requires proper reset sequence to restart." }
          ],
          soWhat: {
            intro: "Emergency stop systems are the last line of defense in industrial safety. They must be 100% reliable because lives depend on them. Understanding how they work and how to maintain them is crucial for any maintenance technician.",
            keyPoints: [
              { title: "Safety First", description: "E-stop systems are designed to fail safe - if anything goes wrong with the system, it defaults to the stopped state to protect people and equipment." },
              { title: "Redundancy", description: "Critical systems often have multiple E-stop buttons and redundant safety circuits to ensure the system can always be stopped, even if one component fails." },
              { title: "Compliance", description: "E-stop systems must meet strict safety standards (like ISO 13850) and require regular testing and documentation to maintain safety certification." },
              { title: "Maintenance Responsibility", description: "As a maintenance technician, you're responsible for ensuring these systems work when needed. Regular testing and proper documentation can save lives." }
            ]
          }
        },
        3: {
          instructions: "Observe the various LED indicators on the control panel. These visual signals provide instant feedback about system status and are essential for quick diagnosis.",
          steps: [
            { title: "Identify LED Functions", description: "Document what each LED indicates - power, run status, alarms, communication, etc. Check the system documentation if needed." },
            { title: "Test LED Operation", description: "Verify each LED illuminates properly by changing system conditions or using test functions if available." },
            { title: "Check Visibility", description: "Ensure all LEDs are clearly visible from the operator position and not obscured by dirt, labels, or other equipment." },
            { title: "Verify Color Coding", description: "Confirm LEDs follow standard color conventions (green=normal, red=alarm, yellow=warning, blue=information)." }
          ],
          soWhat: {
            intro: "Status LEDs are the simplest form of human-machine interface, providing instant visual feedback about system conditions. They're often the first indication of problems and are crucial for quick troubleshooting.",
            keyPoints: [
              { title: "Instant Feedback", description: "LEDs provide immediate visual indication of system status without needing to navigate through screens or menus - critical for emergency situations." },
              { title: "Standard Color Coding", description: "Industrial LEDs follow international standards for colors, making it easier for technicians to quickly understand system status regardless of the specific equipment." },
              { title: "Diagnostic Tool", description: "LED patterns can indicate specific fault conditions, helping technicians quickly identify problems without needing complex diagnostic equipment." },
              { title: "Maintenance Indicator", description: "Many systems use LEDs to indicate when maintenance is due, helping prevent unexpected failures through predictive maintenance." }
            ]
          }
        },
        4: {
          instructions: "Examine the PLC (Programmable Logic Controller) that controls the automation system. This is the 'brain' of the operation and requires careful maintenance.",
          steps: [
            { title: "Physical Inspection", description: "Check the PLC cabinet for proper ventilation, clean filters, secure mounting, and no signs of overheating or corrosion." },
            { title: "Power Supply Check", description: "Verify input voltage is within specifications and check backup battery status if equipped." },
            { title: "I/O Module Status", description: "Check all input/output modules for proper LED indication and verify no loose connections." },
            { title: "Program Backup", description: "Ensure the PLC program is backed up and verify the backup is current and complete." }
          ],
          soWhat: {
            intro: "The PLC is the central nervous system of modern industrial automation. It makes thousands of decisions per second, controlling everything from simple on/off functions to complex process control algorithms.",
            keyPoints: [
              { title: "Central Control", description: "The PLC coordinates all system functions, reading sensors, making control decisions, and operating actuators - all in real-time with precise timing." },
              { title: "Programmable Logic", description: "Unlike hardwired control systems, PLCs can be reprogrammed to change system behavior without rewiring, making them incredibly flexible for different applications." },
              { title: "Reliability", description: "Industrial PLCs are designed to operate 24/7 in harsh environments for years without failure, but they require proper maintenance to achieve this reliability." },
              { title: "Diagnostic Capabilities", description: "Modern PLCs provide extensive diagnostic information, helping technicians quickly identify and resolve problems before they cause system failures." }
            ]
          }
        },
        5: {
          instructions: "Interact with the HMI (Human-Machine Interface) touchscreen. This is how operators monitor and control the system, so it must be properly maintained.",
          steps: [
            { title: "Screen Calibration", description: "Test touchscreen accuracy by pressing various buttons and verify the system responds to the correct touch points." },
            { title: "Display Quality", description: "Check for dead pixels, scratches, or areas of poor visibility that could affect operator ability to read information." },
            { title: "Navigation Test", description: "Navigate through all available screens to ensure proper operation and verify all functions are accessible." },
            { title: "Alarm Testing", description: "Test alarm acknowledgment and verify that critical alarms are properly displayed and cannot be missed." }
          ],
          soWhat: {
            intro: "The HMI is the primary interface between humans and the automated system. It must be intuitive, reliable, and always available because operators depend on it to monitor and control critical processes.",
            keyPoints: [
              { title: "Human Factors", description: "HMI design follows human factors engineering principles to reduce operator error and improve response time during normal and emergency conditions." },
              { title: "Process Visualization", description: "Good HMI design provides clear, intuitive visualization of complex processes, helping operators understand system status at a glance." },
              { title: "Alarm Management", description: "The HMI manages alarms and alerts, prioritizing critical information and guiding operators through proper response procedures." },
              { title: "Data Logging", description: "HMIs often log operator actions and system events, providing valuable data for troubleshooting and process improvement." }
            ]
          }
        },
        6: {
          instructions: "Examine the pump system that circulates fluid through the process. Pumps are critical components that require regular maintenance to prevent costly failures.",
          steps: [
            { title: "Performance Monitoring", description: "Record pump flow rate, pressure, and power consumption. Compare to baseline values to identify performance degradation." },
            { title: "Vibration Analysis", description: "Check for excessive vibration that could indicate bearing wear, impeller damage, or misalignment." },
            { title: "Seal Inspection", description: "Examine mechanical seals for leakage and check seal flush systems if equipped." },
            { title: "Cavitation Check", description: "Listen for cavitation noise and check suction pressure to ensure adequate NPSH (Net Positive Suction Head)." }
          ],
          soWhat: {
            intro: "Pumps are the workhorses of industrial processes, moving fluids where they need to go. Understanding pump operation and maintenance is essential because pump failures can shut down entire processes.",
            keyPoints: [
              { title: "Energy Efficiency", description: "Properly maintained pumps operate more efficiently, reducing energy costs. A worn pump can consume significantly more power while delivering less flow." },
              { title: "Predictive Maintenance", description: "Monitoring pump performance parameters allows you to predict failures before they occur, scheduling maintenance during planned downtime rather than emergency shutdowns." },
              { title: "System Impact", description: "Pump performance affects the entire process. Understanding pump curves and system curves helps optimize performance and identify problems early." },
              { title: "Cost of Failure", description: "Unexpected pump failures can cost thousands in lost production, emergency repairs, and potential safety hazards. Proper maintenance prevents these costly surprises." }
            ]
          }
        },
        7: {
          instructions: "Examine the control valve that regulates flow in the system. Valves are precision instruments that require careful maintenance to maintain accuracy.",
          steps: [
            { title: "Position Accuracy", description: "Test valve positioning by commanding different positions and verifying actual position matches commanded position." },
            { title: "Response Time", description: "Time how quickly the valve responds to position changes and compare to specifications." },
            { title: "Seal Integrity", description: "Check for internal and external leakage, paying special attention to packing glands and seat sealing." },
            { title: "Actuator Function", description: "Test actuator operation, check air pressure (pneumatic) or electrical connections (electric), and verify proper calibration." }
          ],
          soWhat: {
            intro: "Control valves are the 'muscles' of process control systems, actually doing the work of controlling flow, pressure, or temperature. They must be precise and reliable because they directly affect product quality and safety.",
            keyPoints: [
              { title: "Process Control", description: "Control valves are the final control elements in most process control loops, directly manipulating the process variable to maintain desired setpoints." },
              { title: "Precision Required", description: "Many processes require very precise control, and valve performance directly affects product quality, energy efficiency, and safety." },
              { title: "Wear and Tear", description: "Valves experience constant wear from fluid flow, pressure changes, and cycling, making regular maintenance essential for continued accuracy." },
              { title: "Safety Critical", description: "In many applications, control valves are safety-critical components that must fail to a safe position and respond quickly to emergency shutdown commands." }
            ]
          }
        },
        8: {
          instructions: "Examine the float switch used for level detection. These simple but critical devices must be properly maintained to ensure reliable level control.",
          steps: [
            { title: "Float Movement", description: "Manually lift and lower the float to verify smooth movement without binding or sticking." },
            { title: "Switch Operation", description: "Test the electrical switch by moving the float through its operating range and verifying proper switching action." },
            { title: "Mounting Security", description: "Check that the float switch is securely mounted and properly positioned for accurate level detection." },
            { title: "Electrical Connections", description: "Inspect wiring and connections for corrosion, looseness, or damage that could cause intermittent operation." }
          ],
          soWhat: {
            intro: "Float switches are simple but essential safety devices that prevent tank overflows and pump dry-running. Despite their simplicity, they must be properly maintained because failures can cause expensive damage or safety hazards.",
            keyPoints: [
              { title: "Simple but Critical", description: "Float switches have few moving parts but perform critical safety functions like preventing tank overflows or protecting pumps from running dry." },
              { title: "Environmental Challenges", description: "Float switches often operate in harsh environments with corrosive fluids, extreme temperatures, or debris that can affect operation." },
              { title: "Fail-Safe Design", description: "Properly designed float switch systems fail in a safe condition - if the switch fails, the system shuts down safely rather than causing damage." },
              { title: "Regular Testing", description: "Because float switches are often in remote or difficult-to-access locations, regular testing ensures they'll work when needed." }
            ]
          }
        },
        9: {
          instructions: "Examine the proximity switch used for position detection. These non-contact sensors are essential for automation but require proper setup and maintenance.",
          steps: [
            { title: "Sensing Distance", description: "Test the sensing distance by moving a target object toward the sensor and noting the exact switching point." },
            { title: "Target Material Effect", description: "Test with different target materials (steel, aluminum, brass) to understand how material affects sensing distance." },
            { title: "Environmental Factors", description: "Check for interference from nearby metal objects, electrical noise, or environmental conditions that could affect operation." },
            { title: "Wiring Integrity", description: "Inspect cables for damage and verify proper electrical connections, especially in areas subject to vibration or movement." }
          ],
          soWhat: {
            intro: "Proximity switches are the eyes and ears of automation systems, detecting position and presence without physical contact. They enable precise control and safety functions that would be impossible with mechanical switches.",
            keyPoints: [
              { title: "Non-Contact Operation", description: "Proximity switches detect objects without physical contact, eliminating wear and enabling detection of fragile objects or in harsh environments." },
              { title: "Precision Positioning", description: "Modern proximity switches can detect position changes as small as 0.1mm, enabling precise control of automated equipment." },
              { title: "Speed Capability", description: "Proximity switches can detect objects moving at high speeds, making them ideal for counting, sorting, and high-speed automation applications." },
              { title: "Reliability", description: "With no moving parts, proximity switches are extremely reliable when properly applied, but they require understanding of their limitations and proper installation." }
            ]
          }
        },
        10: {
          instructions: "Examine the flow sensor that measures fluid flow rate. Accurate flow measurement is critical for process control and must be properly maintained.",
          steps: [
            { title: "Calibration Check", description: "Compare sensor reading to a known flow rate using a calibrated reference or by timing a known volume." },
            { title: "Installation Verification", description: "Verify proper installation with correct upstream and downstream straight pipe lengths and proper orientation." },
            { title: "Signal Quality", description: "Check the electrical signal output for proper voltage/current levels and verify signal stability." },
            { title: "Physical Condition", description: "Inspect the sensor for damage, corrosion, or fouling that could affect accuracy." }
          ],
          soWhat: {
            intro: "Flow measurement is fundamental to process control - you can't control what you can't measure. Flow sensors provide the feedback necessary for precise control of chemical processes, energy systems, and manufacturing operations.",
            keyPoints: [
              { title: "Process Control", description: "Flow measurement is essential for material balance, quality control, and safety in chemical processes. Inaccurate flow measurement can result in off-spec products or dangerous conditions." },
              { title: "Energy Management", description: "Flow sensors help optimize energy consumption by measuring fuel, steam, and cooling water flows, enabling efficient operation and cost control." },
              { title: "Custody Transfer", description: "In many applications, flow sensors are used for custody transfer - buying and selling fluids based on measured quantities, requiring high accuracy and legal traceability." },
              { title: "Maintenance Indicators", description: "Changes in flow sensor readings can indicate developing problems like pipe blockages, pump wear, or valve problems, enabling predictive maintenance." }
            ]
          }
        },
        11: {
          instructions: "Examine the temperature sensor that monitors process temperature. Temperature measurement is critical for quality, safety, and efficiency.",
          steps: [
            { title: "Calibration Verification", description: "Compare sensor reading to a calibrated reference thermometer at known temperature points." },
            { title: "Response Time Test", description: "Test sensor response time by subjecting it to a rapid temperature change and measuring how quickly it responds." },
            { title: "Installation Check", description: "Verify proper installation depth, thermal contact, and insulation to ensure accurate measurement." },
            { title: "Signal Integrity", description: "Check electrical connections and verify proper signal conditioning for the type of sensor (RTD, thermocouple, etc.)." }
          ],
          soWhat: {
            intro: "Temperature control is fundamental to most industrial processes. Whether it's maintaining product quality, ensuring safety, or optimizing energy efficiency, accurate temperature measurement is essential.",
            keyPoints: [
              { title: "Product Quality", description: "Many manufacturing processes require precise temperature control to produce consistent, high-quality products. Temperature variations can result in defects, waste, or off-spec products." },
              { title: "Safety Critical", description: "Temperature monitoring prevents dangerous conditions like overheating, thermal runaway, or exposure to extreme temperatures that could harm personnel or equipment." },
              { title: "Energy Efficiency", description: "Accurate temperature control minimizes energy waste by maintaining optimal operating conditions without excessive heating or cooling." },
              { title: "Process Optimization", description: "Temperature data helps optimize reaction rates, cure times, and other process parameters to maximize efficiency and minimize costs." }
            ]
          }
        },
        12: {
          instructions: "Examine the digital sensors that provide on/off status information. These binary sensors are the foundation of industrial automation logic.",
          steps: [
            { title: "Switch Point Testing", description: "Test each digital sensor by activating it and verifying clean switching between on and off states." },
            { title: "Signal Quality", description: "Use a multimeter or oscilloscope to verify clean digital signals without noise or intermittent switching." },
            { title: "Wiring Verification", description: "Check all connections for proper voltage levels, secure connections, and proper grounding." },
            { title: "Response Time", description: "Test sensor response time to ensure it's fast enough for the application requirements." }
          ],
          soWhat: {
            intro: "Digital sensors are the building blocks of automation logic, providing the binary (on/off) information that PLCs use to make control decisions. They must be absolutely reliable because automation depends on them.",
            keyPoints: [
              { title: "Logic Foundation", description: "Digital sensors provide the binary inputs that form the foundation of all automation logic - every decision starts with digital sensor information." },
              { title: "Safety Systems", description: "Many safety systems rely on digital sensors for emergency stops, safety interlocks, and protective functions that must work reliably every time." },
              { title: "Sequence Control", description: "Digital sensors enable precise sequence control, ensuring operations happen in the correct order and at the right time." },
              { title: "Diagnostic Capability", description: "Digital sensors often provide diagnostic information about system status, helping technicians quickly identify and resolve problems." }
            ]
          }
        },
        13: {
          instructions: "Examine the analog sensors that provide continuous measurement values. These sensors provide the precise measurements needed for process control.",
          steps: [
            { title: "Calibration Check", description: "Verify sensor accuracy by comparing readings to known reference values across the full measurement range." },
            { title: "Signal Conditioning", description: "Check signal conditioning circuits, amplifiers, and converters to ensure proper signal processing." },
            { title: "Noise Analysis", description: "Look for electrical noise, interference, or signal drift that could affect measurement accuracy." },
            { title: "Loop Testing", description: "Test the complete measurement loop including sensor, wiring, and receiving instrument." }
          ],
          soWhat: {
            intro: "Analog sensors provide the continuous measurements that enable precise process control. Unlike digital sensors that are simply on or off, analog sensors provide the exact values needed for accurate control.",
            keyPoints: [
              { title: "Precise Control", description: "Analog sensors enable precise control by providing exact measurements rather than just on/off information, allowing for fine-tuning of process parameters." },
              { title: "Trend Analysis", description: "Continuous analog measurements allow for trend analysis, helping predict problems before they occur and optimize process performance." },
              { title: "Quality Control", description: "Analog measurements are essential for quality control, ensuring products meet specifications and detecting variations that could indicate problems." },
              { title: "Process Optimization", description: "Analog sensor data enables advanced control strategies like PID control, feedforward control, and model predictive control for optimal process performance." }
            ]
          }
        },
        14: {
          instructions: "Learn systematic approaches to fault diagnosis and troubleshooting. Effective troubleshooting requires a methodical approach and understanding of system interactions.",
          steps: [
            { title: "Gather Information", description: "Collect all available information about the fault - when it occurred, what symptoms are present, and what was happening when it started." },
            { title: "Analyze Symptoms", description: "Systematically analyze symptoms to develop theories about possible causes, starting with the most likely based on experience." },
            { title: "Test Theories", description: "Test each theory systematically, starting with the easiest and most likely causes before moving to more complex possibilities." },
            { title: "Implement Solution", description: "Once the root cause is identified, implement a permanent solution and verify that the problem is completely resolved." }
          ],
          soWhat: {
            intro: "Effective troubleshooting is both an art and a science. It requires systematic thinking, technical knowledge, and experience to quickly identify and resolve problems that can cost thousands of dollars per hour in lost production.",
            keyPoints: [
              { title: "Systematic Approach", description: "Random troubleshooting wastes time and can make problems worse. A systematic approach ensures you find the real cause quickly and efficiently." },
              { title: "Root Cause Analysis", description: "Fixing symptoms without addressing root causes leads to recurring problems. Effective troubleshooting identifies and eliminates the underlying cause." },
              { title: "Documentation", description: "Proper documentation of faults and solutions builds organizational knowledge and helps prevent similar problems in the future." },
              { title: "Continuous Learning", description: "Every fault is a learning opportunity. Understanding why problems occur helps prevent them and makes you a more effective troubleshooter." }
            ]
          }
        }
      };
      
      // Return the content for the specific worksheet, or default content if not found
      return contentTemplates[worksheetId] || {
        instructions: `Follow the maintenance procedures for ${title.toLowerCase()} as outlined in the system documentation.`,
        steps: [
          { title: "Initial Inspection", description: "Perform a visual inspection of the system components." },
          { title: "Functional Testing", description: "Test the system operation according to procedures." },
          { title: "Documentation", description: "Record all observations and measurements." },
          { title: "Corrective Actions", description: "Implement any necessary corrective actions." }
        ],
        soWhat: {
          intro: `Understanding ${title.toLowerCase()} is important for maintaining reliable industrial systems.`,
          keyPoints: [
            { title: "System Reliability", description: "Proper maintenance ensures reliable operation and prevents unexpected failures." },
            { title: "Safety", description: "Well-maintained systems operate safely and protect personnel and equipment." },
            { title: "Efficiency", description: "Regular maintenance maintains system efficiency and reduces operating costs." },
            { title: "Compliance", description: "Proper maintenance ensures compliance with safety and regulatory requirements." }
          ]
        }
      };
    }

    // Render enhanced maintenance worksheet with interactive sections
    function renderEnhancedMaintenanceWorksheet(scenario) {
      const container = document.getElementById('worksheet-content');
      
      // Get worksheet ID from scenario
      const worksheetId = scenario.id;
      console.log('Worksheet ID in renderEnhancedMaintenanceWorksheet:', worksheetId);
      
      // Generate enhanced content based on worksheet topic
      const enhancedContent = generateEnhancedContent(scenario);
      
      container.innerHTML = `
        <h1 class="page-title">${scenario.title}</h1>

        <div class="worksheet-section introduction-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);">
          <h2 class="section-header" style="color: #2196F3; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-info-circle"></i> 1. Introduction</h2>
          <div class="worksheet-content">
            ${worksheetId === 1 ? `
              <p style="color: #FFFFFF; margin-bottom: 15px;">The system you have in front of you is a Closed-Loop Flow Control system, meaning it continuously adjusts itself to meet a desired target, called the setpoint. It does this by using feedback from sensors to control devices like pumps and valves, keeping the system accurate and stable even if conditions change.</p>
              
              <div class="cad-models" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
                <div class="cad-model" style="text-align: center;">
                  <img src="assets/cad.png" alt="CAD Model - Front View" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                  <figcaption style="color: #FFFFFF; margin-top: 10px; font-style: italic;">CAD Model - Front View</figcaption>
                </div>
                <div class="cad-model" style="text-align: center;">
                  <img src="assets/cad2.png" alt="CAD Model - Side View" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                  <figcaption style="color: #FFFFFF; margin-top: 10px; font-style: italic;">CAD Model - Side View</figcaption>
                </div>
              </div>
            ` : `
              ${(scenario.introduction?.paragraphs || scenario.paragraphs || []).map(p => `<p style="color: #FFFFFF; margin-bottom: 15px;">${p}</p>`).join('')}
              
              ${scenario.image ? `
              <div class="system-diagram" style="text-align: center; margin: 20px 0;">
                <figure>
                  <img src="assets/maintenance/${scenario.image}" alt="${scenario.title}" style="max-width: 400px; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                  <figcaption style="color: #FFFFFF; margin-top: 10px; font-style: italic;">${scenario.title} System Diagram</figcaption>
                </figure>
              </div>
              ` : ''}
            `}
          </div>
        </div>

        <div class="worksheet-section over-to-you-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FF9800; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.2);">
          <h2 class="section-header" style="color: #FF9800; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-hands-helping"></i> 2. Over To You</h2>
          <div class="worksheet-content">
            <p style="color: #FFFFFF; margin-bottom: 20px; font-weight: bold;">${enhancedContent.instructions}</p>
            
            <div class="steps-container">
              ${enhancedContent.steps.map((step, index) => `
                <div class="step-card" data-step="${index + 1}" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">${index + 1}</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">${step.title}</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">${step.description}</p>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>

        <div class="so-what-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; margin-bottom: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);">
          <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-lightbulb"></i> 3. So What?</h2>
          <div class="so-what-content">
            <p style="color: #FFFFFF; margin-bottom: 20px;">${enhancedContent.soWhat.intro}</p>
            
            ${enhancedContent.soWhat.keyPoints.map(point => `
              <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                <i class="fas fa-lightbulb" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                <div>
                  <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">${point.title}</strong>
                  <p style="color: #FFFFFF; margin: 0;">${point.description}</p>
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="questions-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #4CAF50; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);">
          <h2 class="section-header" style="color: #4CAF50; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-question-circle"></i> 4. Questions & Answers</h2>
          <div class="questions-content">
            <div class="instructions" style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #FFFFFF;">
              <strong>Instructions:</strong> Answer each question based on your observations and understanding of the ${scenario.title.toLowerCase()} system. Your answers will be saved automatically.
            </div>
            
            ${scenario.questions.map((q, index) => {
              if (q.type === 'multiple_choice') {
                return `
                  <div class="question-item" data-question="${q.id}" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                    <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question ${index + 1}: ${q.text}</h4>
                    <div class="multiple-choice-options" style="margin-bottom: 15px;">
                      ${q.options.map((option, optionIndex) => `
                        <label class="option-label" style="display: block; margin-bottom: 10px; cursor: pointer; padding: 10px; border: 2px solid #555; border-radius: 6px; background: #222; transition: all 0.3s ease;">
                          <input type="radio" name="question-${q.id}" value="${optionIndex}" class="option-radio" style="margin-right: 10px;">
                          <span style="color: #FFFFFF;">${option}</span>
                        </label>
                      `).join('')}
                    </div>
                    <div class="question-actions" style="margin-top: 15px;">
                      <button class="submit-question-btn" onclick="submitMultipleChoiceQuestion('${q.id}')" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                      <span class="submit-note" style="color: #AAA; margin-left: 10px;">Select an option and click submit to see the correct answer.</span>
                    </div>
                    <div class="answer-feedback hidden" style="margin-top: 15px; padding: 15px; border-radius: 4px; display: none;">
                      <div class="feedback-content"></div>
                    </div>
                  </div>
                `;
              } else {
                return `
                  <div class="question-item" data-question="${index + 1}" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                    <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question ${index + 1}: ${q.text}</h4>
                    <textarea class="answer-input" data-question="${index + 1}" placeholder="${q.placeholder}" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                    <div class="question-actions" style="margin-top: 15px;">
                      <button class="submit-question-btn" onclick="submitAnswer(${index + 1})" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                      <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be saved and compared to the correct answer.</span>
                    </div>
                    <div class="answer-comparison hidden" style="margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
                      <!-- Comparison content will be inserted here -->
                    </div>
                  </div>
                `;
              }
            }).join('')}
          </div>
        </div>

        ${worksheetId === 1 ? `
        <!-- PID Control Simulation Section (Worksheet 1 only) -->
        
        <!-- PID Tuning Section -->
        <div class="simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);">
          <h2 class="section-header" style="color: #E91E63; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-line"></i> 5.1 PID Tuning</h2>
          
          <!-- PID Tuning Interface -->
          <div class="tab-content" id="tuning-tab">
              <!-- Main control panel for setpoint and process variable -->
              <div class="control-panel" style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; background: #333; padding: 20px; border-radius: 8px;">
                  <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                      <label style="color: #FFFFFF; min-width: 80px; font-weight: bold;">Setpoint:</label>
                      <input type="range" id="setpoint-slider" min="0" max="100" value="50" style="width: 150px;">
                      <span id="setpoint-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 60px;">50.0C</span>
                  </div>
                  <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                      <label style="color: #FFFFFF; min-width: 80px; font-weight: bold;">Process Variable:</label>
                      <span id="pv-value" class="value-display" style="color: #2196F3; font-weight: bold; min-width: 60px;">25.0C</span>
                  </div>
                  <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                      <label style="color: #FFFFFF; min-width: 80px; font-weight: bold;">Control Output:</label>
                      <span id="control-output-value" class="value-display" style="color: #4CAF50; font-weight: bold; min-width: 60px;">0.0%</span>
                  </div>
              </div>

              <!-- PID Parameter Tuning Panel -->
              <div class="pid-tuning-panel" style="background: #333; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                  <h4 style="color: #FFFFFF; margin-bottom: 20px; font-size: 18px;">PID Parameters</h4>
                  <div class="tuning-controls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                      <!-- Proportional control -->
                      <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                          <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Proportional (Kp):</label>
                          <input type="range" id="kp-slider" min="0" max="2" step="0.1" value="0.5" style="flex: 1;">
                          <span id="kp-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.5</span>
                      </div>
                      <!-- Integral control -->
                      <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                          <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Integral (Ki):</label>
                          <input type="range" id="ki-slider" min="0" max="1" step="0.05" value="0.1" style="flex: 1;">
                          <span id="ki-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.1</span>
                      </div>
                      <!-- Derivative control -->
                      <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                          <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Derivative (Kd):</label>
                          <input type="range" id="kd-slider" min="0" max="1" step="0.05" value="0.2" style="flex: 1;">
                          <span id="kd-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.2</span>
                      </div>
                  </div>
                  <!-- Real-time performance metrics display -->
                  <div class="performance-metrics" style="display: flex; gap: 30px; flex-wrap: wrap; background: #222; padding: 20px; border-radius: 8px;">
                      <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                          <label style="color: #FFFFFF; font-weight: bold;">Rise Time:</label>
                          <span id="rise-time" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0s</span>
                      </div>
                      <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                          <label style="color: #FFFFFF; font-weight: bold;">Overshoot:</label>
                          <span id="overshoot" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0%</span>
                      </div>
                      <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                          <label style="color: #FFFFFF; font-weight: bold;">Settling Time:</label>
                          <span id="settling-time" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0s</span>
                      </div>
                  </div>
                  
                  <!-- Reset Button -->
                  <div class="reset-controls" style="display: flex; justify-content: center; margin-top: 20px;">
                      <button id="reset-pid" class="reset-button" style="background: linear-gradient(135deg, #FF9800, #F57C00); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                          <i class="fas fa-redo"></i> Reset to Defaults
                      </button>
                  </div>
              </div>
              
              <!-- Real-time PID Tuning Graph -->
              <div class="pid-tuning-graph" style="background: #333; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                  <h4 style="color: #FFFFFF; margin-bottom: 20px; font-size: 18px;">Real-time System Response</h4>
                  <div class="graph-container" style="position: relative;">
                      <canvas id="pid-tuning-chart" style="background: #222; border-radius: 8px; width: 100%; height: 300px; border: 2px solid #555;"></canvas>
                  </div>
              </div>
          </div>
        </div>

        <!-- System Response Section -->
        <div class="simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);">
          <h2 class="section-header" style="color: #E91E63; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-line"></i> 5.2 System Response</h2>
          
          <!-- System Response Testing Interface -->
          <div class="tab-content" id="response-tab">
              <!-- Response Type Selection -->
              <div class="response-control-panel" style="background: linear-gradient(135deg, #2a2a2a, #3a3a3a); border-radius: 12px; padding: 30px; margin-bottom: 30px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.2);">
                  <h4 style="color: #E91E63; margin-bottom: 25px; font-size: 20px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-sliders-h"></i> Response Type Selection</h4>
                  
                  <div class="control-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 25px;">
                      <!-- Input Type Selection -->
                      <div class="control-section" style="background: #333; padding: 20px; border-radius: 8px;">
                          <h5 style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;"><i class="fas fa-wave-square"></i> Input Signal Type</h5>
                          <div class="input-type-options" style="display: flex; flex-direction: column; gap: 12px;">
                              <label class="radio-option" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border-radius: 6px; transition: all 0.3s ease;">
                                  <input type="radio" name="input-type" value="step" checked style="accent-color: #E91E63;">
                                  <span style="color: #FFFFFF; font-weight: 500;">Step Response</span>
                                  <span style="color: #AAA; font-size: 12px; margin-left: auto;">Instant change</span>
                              </label>
                              <label class="radio-option" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border-radius: 6px; transition: all 0.3s ease;">
                                  <input type="radio" name="input-type" value="ramp" style="accent-color: #E91E63;">
                                  <span style="color: #FFFFFF; font-weight: 500;">Ramp Response</span>
                                  <span style="color: #AAA; font-size: 12px; margin-left: auto;">Linear increase</span>
                              </label>
                              <label class="radio-option" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border-radius: 6px; transition: all 0.3s ease;">
                                  <input type="radio" name="input-type" value="sine" style="accent-color: #E91E63;">
                                  <span style="color: #FFFFFF; font-weight: 500;">Sinusoidal Response</span>
                                  <span style="color: #AAA; font-size: 12px; margin-left: auto;">Oscillating input</span>
                              </label>
                          </div>
                      </div>
                      
                      <!-- Response PID Controls -->
                      <div class="control-section" style="background: #333; padding: 20px; border-radius: 8px;">
                          <h5 style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;"><i class="fas fa-tachometer-alt"></i> Response PID Settings</h5>
                          <div class="response-pid-controls" style="display: flex; flex-direction: column; gap: 15px;">
                              <!-- Proportional control -->
                              <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                                  <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Proportional (Kp):</label>
                                  <input type="range" id="response-kp-slider" min="0" max="2" step="0.1" value="0.5" style="flex: 1;">
                                  <span id="response-kp-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.5</span>
                              </div>
                              <!-- Integral control -->
                              <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                                  <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Integral (Ki):</label>
                                  <input type="range" id="response-ki-slider" min="0" max="1" step="0.05" value="0.1" style="flex: 1;">
                                  <span id="response-ki-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.1</span>
                              </div>
                              <!-- Derivative control -->
                              <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                                  <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Derivative (Kd):</label>
                                  <input type="range" id="response-kd-slider" min="0" max="1" step="0.05" value="0.2" style="flex: 1;">
                                  <span id="response-kd-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.2</span>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Action Buttons -->
                  <div class="action-buttons" style="display: flex; gap: 15px; justify-content: center;">
                      <button id="start-response" class="action-button primary" style="background: linear-gradient(135deg, #E91E63, #C2185B); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px;">
                          <i class="fas fa-play"></i> Start Test
                      </button>
                      <button id="stop-response" class="action-button secondary" style="background: #555; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px;">
                          <i class="fas fa-stop"></i> Stop Test
                      </button>
                      <button id="reset-response" class="action-button secondary" style="background: #555; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px;">
                          <i class="fas fa-redo"></i> Reset
                      </button>
                  </div>
              </div>
              
              <!-- Response Graph -->
              <div class="response-graph-container" style="background: linear-gradient(135deg, #2a2a2a, #3a3a3a); border-radius: 12px; padding: 30px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.2);">
                  <h4 style="color: #E91E63; margin-bottom: 25px; font-size: 20px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-line"></i> System Response Analysis</h4>
                  
                  <div class="graph-wrapper" style="position: relative;">
                      <canvas id="response-chart" style="background: #222; border-radius: 8px; width: 100%; height: 400px; border: 2px solid #555;"></canvas>
                  </div>
              </div>
              

              
              <!-- System Response Explanation (at bottom) -->
              <div class="response-explanation" style="background: linear-gradient(135deg, #2a2a2a, #3a3a3a); border-radius: 12px; padding: 30px; margin-top: 30px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.2);">
                  <h4 style="color: #E91E63; margin-bottom: 25px; font-size: 20px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-info-circle"></i> Understanding System Response</h4>
                  
                  <div style="color: #FFFFFF; line-height: 1.6;">
                      <p style="margin-bottom: 20px;"><strong>What is System Response?</strong></p>
                      <p style="margin-bottom: 15px;">System response shows how your PID controller behaves when the setpoint changes. It's like watching how quickly and smoothly your car responds when you press the accelerator or brake.</p>
                      
                      <div style="background: #333; padding: 20px; border-radius: 8px; margin: 20px 0;">
                          <h5 style="color: #E91E63; margin-bottom: 15px; font-size: 16px;"><i class="fas fa-chart-line"></i> Response Types</h5>
                          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                              <div style="background: #222; padding: 15px; border-radius: 6px; border-left: 3px solid #4CAF50;">
                                  <strong style="color: #4CAF50;">Step Response</strong>
                                  <p style="color: #AAA; margin: 5px 0 0 0; font-size: 14px;">Tests how quickly the system reaches a new setpoint. Good for measuring rise time and settling time.</p>
                              </div>
                              <div style="background: #222; padding: 15px; border-radius: 6px; border-left: 3px solid #FF9800;">
                                  <strong style="color: #FF9800;">Ramp Response</strong>
                                  <p style="color: #AAA; margin: 5px 0 0 0; font-size: 14px;">Tests how well the system follows a gradually changing setpoint. Good for measuring tracking performance.</p>
                              </div>
                              <div style="background: #222; padding: 15px; border-radius: 6px; border-left: 3px solid #2196F3;">
                                  <strong style="color: #2196F3;">Sinusoidal Response</strong>
                                  <p style="color: #AAA; margin: 5px 0 0 0; font-size: 14px;">Tests how well the system follows an oscillating setpoint. Good for measuring frequency response.</p>
                              </div>
                          </div>
                      </div>
                      
                      <p style="margin-bottom: 15px;"><strong>How to Use This Section:</strong></p>
                      <ul style="margin-bottom: 15px; padding-left: 20px;">
                          <li>First, tune your PID parameters in the "PID Tuning" tab</li>
                          <li>Select a response type (Step, Ramp, or Sinusoidal)</li>
                          <li>Click "Start Test" to see how your tuning performs</li>
                          <li>The graph shows the input signal (what you want) vs. the system response (what you get)</li>
                          <li>Good tuning means the blue line follows the pink line closely</li>
                      </ul>
                      
                      <p><strong>Learning Goal:</strong> Understand how different PID settings affect system performance and learn to recognize good vs. poor control behavior.</p>
                  </div>
              </div>
          </div>
        </div>

        <!-- Challenges Section -->
        <div class="simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);">
          <h2 class="section-header" style="color: #E91E63; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-line"></i> 5.3 Challenges</h2>
          
          <!-- Interactive Challenges Interface -->
          <div class="tab-content" id="challenges-tab">
              <div class="challenge-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px;">
                  <!-- Challenge 1: Minimal Overshoot -->
                  <div class="challenge-card" data-challenge="1" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                      <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-target"></i> Challenge 1: Minimal Overshoot</h4>
                      <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Tune the system to achieve less than 5% overshoot</p>
                      <div class="challenge-status" style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                          <span class="status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: #666;"></span>
                          <span style="color: #AAA;">Not Attempted</span>
                      </div>
                      <button class="check-challenge-btn" data-challenge="1" style="background: linear-gradient(135deg, #E91E63, #C2185B); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; width: 100%; justify-content: center;">
                          <i class="fas fa-check-circle"></i> Check Challenge
                      </button>
                  </div>
                  
                  <!-- Challenge 2: Fast Settling Time -->
                  <div class="challenge-card" data-challenge="2" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                      <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-stopwatch"></i> Challenge 2: Fast Settling Time</h4>
                      <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Achieve settling time of less than 2 seconds</p>
                      <div class="challenge-status" style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                          <span class="status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: #666;"></span>
                          <span style="color: #AAA;">Not Attempted</span>
                      </div>
                      <button class="check-challenge-btn" data-challenge="2" style="background: linear-gradient(135deg, #E91E63, #C2185B); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; width: 100%; justify-content: center;">
                          <i class="fas fa-check-circle"></i> Check Challenge
                      </button>
                  </div>
                  
                  <!-- Challenge 3: Disturbance Rejection -->
                  <div class="challenge-card" data-challenge="3" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                      <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-shield-alt"></i> Challenge 3: Disturbance Rejection</h4>
                      <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Maintain setpoint within 2C during disturbances</p>
                      <div class="challenge-status" style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                          <span class="status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: #666;"></span>
                          <span style="color: #AAA;">Not Attempted</span>
                      </div>
                      <button class="check-challenge-btn" data-challenge="3" style="background: linear-gradient(135deg, #E91E63, #C2185B); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; width: 100%; justify-content: center;">
                          <i class="fas fa-check-circle"></i> Check Challenge
                      </button>
                  </div>
              </div>
              
              <!-- Educational Explanation Section -->
              <div class="simulation-explanation" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 30px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.2);">
                  <h4 style="color: #E91E63; margin-bottom: 20px; font-size: 18px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-lightbulb"></i> Understanding PID Control</h4>
                  
                  <!-- PID Tuning Explanation -->
                  <div class="explanation-content" id="tuning-explanation" style="display: block;">
                      <div style="color: #FFFFFF; line-height: 1.6;">
                          <p style="margin-bottom: 15px;"><strong>Real-time PID Tuning:</strong> This graph shows how your PID controller responds to setpoint changes in real-time. The three lines represent:</p>
                          <ul style="margin-bottom: 15px; padding-left: 20px;">
                              <li><strong style="color: #E91E63;">Pink Line (Setpoint):</strong> Your target temperature - what you want the system to achieve</li>
                              <li><strong style="color: #2196F3;">Blue Line (Process Variable):</strong> The actual temperature - how the system is currently performing</li>
                              <li><strong style="color: #4CAF50;">Green Line (Control Output):</strong> The controller's effort - how hard the PID is working</li>
                          </ul>
                          <p style="margin-bottom: 15px;"><strong>How to Tune:</strong></p>
                          <ul style="margin-bottom: 15px; padding-left: 20px;">
                              <li><strong>Proportional (Kp):</strong> Controls response speed. Higher values = faster response but more overshoot</li>
                              <li><strong>Integral (Ki):</strong> Eliminates steady-state error. Higher values = less error but slower response</li>
                              <li><strong>Derivative (Kd):</strong> Reduces overshoot. Higher values = less oscillation but can amplify noise</li>
                          </ul>
                          <p><strong>Goal:</strong> Make the blue line follow the pink line as closely as possible with minimal overshoot and fast settling time.</p>
                      </div>
                  </div>
                  
                  <!-- System Response Explanation -->
                  <div class="explanation-content" id="response-explanation" style="display: none;">
                      <div style="color: #FFFFFF; line-height: 1.6;">
                          <p style="margin-bottom: 15px;"><strong>System Response Analysis:</strong> This tab shows you how well your PID controller is performing. Think of it like a report card for your tuning skills!</p>
                          
                          <p style="margin-bottom: 15px;"><strong>What You'll See:</strong></p>
                          <ul style="margin-bottom: 15px; padding-left: 20px;">
                              <li><strong>Target Line (Pink):</strong> This is what you want the system to achieve - your goal</li>
                              <li><strong>Actual Response (Blue):</strong> This is what the system actually does - the reality</li>
                              <li><strong>Good Tuning:</strong> The blue line follows the pink line closely with minimal overshoot</li>
                              <li><strong>Poor Tuning:</strong> The blue line oscillates, overshoots, or takes too long to settle</li>
                          </ul>
                          
                          <p style="margin-bottom: 15px;"><strong>Key Concepts:</strong></p>
                          <ul style="margin-bottom: 15px; padding-left: 20px;">
                              <li><strong>Rise Time:</strong> How quickly the system responds to changes (faster is usually better)</li>
                              <li><strong>Overshoot:</strong> How much the system goes above the target (less is better)</li>
                              <li><strong>Settling Time:</strong> How long it takes to stabilize at the target (faster is better)</li>
                              <li><strong>Steady State Error:</strong> The final difference from the target (less is better)</li>
                          </ul>
                          
                          <p><strong>Learning Goal:</strong> Practice tuning in the "PID Tuning" tab, then check your results here. Over time, you'll learn to recognize good vs. poor control behavior and understand how each PID parameter affects performance.</p>
                      </div>
                  </div>
                  
                  <!-- Challenges Explanation -->
                  <div class="explanation-content" id="challenges-explanation" style="display: none;">
                      <div style="color: #FFFFFF; line-height: 1.6;">
                          <p style="margin-bottom: 15px;"><strong>PID Tuning Challenges:</strong> These challenges test your understanding of PID control principles:</p>
                          <ul style="margin-bottom: 15px; padding-left: 20px;">
                              <li><strong>Challenge 1 - Minimal Overshoot:</strong> Achieve less than 5% overshoot. This requires careful balance of Kp and Kd to prevent the system from overshooting the target.</li>
                              <li><strong>Challenge 2 - Fast Settling Time:</strong> Achieve settling time under 2 seconds. This requires higher Kp for speed and proper Kd to control overshoot.</li>
                              <li><strong>Challenge 3 - Disturbance Rejection:</strong> Maintain setpoint within 2C during disturbances. This requires sufficient Kp and Ki to reject external disturbances.</li>
                          </ul>
                          <p style="margin-bottom: 15px;"><strong>Tuning Strategy:</strong></p>
                          <ul style="margin-bottom: 15px; padding-left: 20px;">
                              <li><strong>Start with Kp:</strong> Increase until you get good response speed</li>
                              <li><strong>Add Ki:</strong> Increase to eliminate steady-state error</li>
                              <li><strong>Add Kd:</strong> Increase to reduce overshoot and improve settling time</li>
                              <li><strong>Fine-tune:</strong> Make small adjustments to optimize performance</li>
                          </ul>
                          <p><strong>Learning Goal:</strong> Understand how each PID parameter affects system performance and learn to balance them for optimal control.</p>
                      </div>
                  </div>
              </div>
          </div>
        </div>
        ` : ''}
      `;

      // Initialize interactive features
      setTimeout(() => {
        initializeStepTracking();
        loadSavedAnswers();
        
        // Initialize PID simulation if this is worksheet 1
        if (worksheetId === 1) {
          initEnhancedPIDSimulation();
        }
      }, 100);
      
      // Show the content
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
    }

    // Render fault scenario with interactive features
    function renderFaultScenario(scenario) {
      const container = document.getElementById('worksheet-content');
      
      container.innerHTML = `
        <h1 class="page-title">Scenario ${scenario.id}: ${scenario.title}</h1>
        ${scenario.subtitle ? `<h2 class="page-subtitle" style="color: #AAA; margin-bottom: 30px; font-size: 18px; text-align: center;">${scenario.subtitle}</h2>` : ''}

        <!-- Interactive System Simulator Section -->
        <!-- (REMOVED: interactive simulator) -->



        <!-- Scenario Introduction -->
        <div class="worksheet-section introduction-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #f44336; box-shadow: 0 8px 20px rgba(244, 67, 54, 0.2);">
          <h2 class="section-header" style="color: #f44336; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-exclamation-triangle"></i> Scenario</h2>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="worksheet-content">
              ${(scenario.introduction?.paragraphs || scenario.paragraphs || []).map(p => `<p style="color: #FFFFFF; margin-bottom: 15px;">${p}</p>`).join('')}
            </div>
            ${scenario.image ? `
            <div style="text-align: center;">
              <img src="assets/scenarios/${scenario.image}" alt="${scenario.title}" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
            </div>
            ` : ''}
          </div>
        </div>

        <!-- System Overview Section -->
        ${scenario.system_overview ? `
        <div class="system-overview-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);">
          <h2 class="section-header" style="color: #2196F3; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-tachometer-alt"></i> Current System Status
          </h2>
          <div class="status-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            ${scenario.system_overview.components ? scenario.system_overview.components.map(component => `
            <div class="component-status" style="background: #333; padding: 20px; border-radius: 8px; border-left: 4px solid ${component.status.includes('normal') ? '#4CAF50' : component.status.includes('critical') || component.status.includes('alarm') ? '#f44336' : '#FF9800'};">
              <h4 style="color: #FFFFFF; margin-bottom: 10px;">${component.name}</h4>
              <p style="color: #AAA; margin-bottom: 8px;">Location: ${component.location}</p>
              <p style="color: #AAA; margin-bottom: 8px;">Status: <span style="color: ${component.status.includes('normal') ? '#4CAF50' : component.status.includes('critical') || component.status.includes('alarm') ? '#f44336' : '#FF9800'};">${component.status}</span></p>
              ${component.reading ? `<p style="color: #AAA;">Reading: ${component.reading}</p>` : ''}
            </div>
            `).join('') : ''}
          </div>
        </div>
        ` : ''}

        <!-- Investigation Tools Section -->
        ${scenario.interactive_elements && scenario.interactive_elements.investigation_tools ? `
        <div class="investigation-tools-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FF9800; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.2);">
          <h2 class="section-header" style="color: #FF9800; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-tools"></i> Investigation Tools
          </h2>
          <p style="color: #FFFFFF; margin-bottom: 20px;">Use these tools to investigate the problem and gather information:</p>
          <div class="tools-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            ${scenario.interactive_elements.investigation_tools.tools.map(tool => `
            <button class="investigation-tool" onclick="useTool('${tool.id}')" style="background: #333; color: white; border: 2px solid #FF9800; padding: 20px; border-radius: 8px; cursor: pointer; text-align: left; transition: all 0.3s ease;">
              <h4 style="color: #FF9800; margin-bottom: 10px;">${tool.name}</h4>
              <p style="color: #FFFFFF; margin: 0; font-size: 14px;">${tool.description}</p>
            </button>
            `).join('')}
          </div>
          
          <div id="tool-results" style="margin-top: 30px; padding: 20px; background: #333; border-radius: 8px; display: none;">
            <h3 style="color: #FFFFFF; margin-bottom: 15px;">Investigation Results</h3>
            <div id="tool-results-content" style="color: #FFFFFF;"></div>
          </div>
        </div>
        ` : ''}

        <!-- Learning Scenarios Section -->
        ${scenario.learning_scenarios ? `
        <div class="learning-scenarios-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);">
          <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-graduation-cap"></i> Learning Journey
          </h2>
          <div class="learning-progress" style="margin-bottom: 30px;">
            <div class="progress-bar" style="background: #333; height: 8px; border-radius: 4px; overflow: hidden;">
              <div id="learning-progress" style="background: linear-gradient(90deg, #9C27B0, #E91E63); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            </div>
            <div style="color: #FFFFFF; margin-top: 10px;">Progress: <span id="learning-score">0</span> / ${scenario.learning_scenarios.reduce((total, phase) => total + phase.points, 0)} points</div>
          </div>
          
          <div class="learning-phases">
            ${scenario.learning_scenarios.map((phase, index) => `
            <div class="learning-phase" data-phase="${index + 1}" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #9C27B0;">
              <div class="phase-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #FFFFFF; margin: 0;">Phase ${index + 1}: ${phase.title}</h3>
                <span class="phase-points" style="background: #9C27B0; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">${phase.points} pts</span>
              </div>
              <p style="color: #AAA; margin-bottom: 15px;">${phase.description}</p>
              <div class="phase-tasks">
                ${phase.tasks.map((task, taskIndex) => `
                <div class="task-item" style="display: flex; align-items: center; margin-bottom: 10px;">
                  <input type="checkbox" id="task-${index}-${taskIndex}" style="margin-right: 10px;">
                  <label for="task-${index}-${taskIndex}" style="color: #FFFFFF; cursor: pointer;">${task}</label>
                </div>
                `).join('')}
              </div>
            </div>
            `).join('')}
          </div>
        </div>
        ` : ''}

        <!-- Enhanced Questions Section -->
        <div class="questions-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #4CAF50; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.2);">
          <h2 class="section-header" style="color: #4CAF50; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-question-circle"></i> Troubleshooting Questions</h2>
          <div class="worksheet-content">
            ${scenario.questions.map((q, index) => `
              <div class="question-item" data-question="${index + 1}" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">${index + 1}. ${q.text}</h4>
                <textarea class="answer-input" data-question="${index + 1}" 
                         placeholder="${q.placeholder || 'Enter your answer here...'}" 
                         style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitAnswer(${index + 1})" 
                          style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    Submit Answer
                  </button>
                  <span class="question-feedback" style="margin-left: 10px; color: #AAA;"></span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      // Load saved answers
      setTimeout(loadSavedAnswers, 100);
      
      // Show the content
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
    }

  // System Controls
  function initializeSystemControls() {
    const sliders = ['temp-slider', 'pressure-slider', 'flow-slider', 'oil-slider'];
    const values = ['temp-value', 'pressure-value', 'flow-value', 'oil-value'];
    const units = ['C', ' bar', ' L/min', '%'];

    sliders.forEach((sliderId, index) => {
      const slider = document.getElementById(sliderId);
      const valueSpan = document.getElementById(values[index]);
      
      if (slider && valueSpan) {
        slider.addEventListener('input', (e) => {
          const value = e.target.value;
          valueSpan.textContent = value + units[index];
          updateSystemStatus();
        });
      }
    });
  }

  // Investigation Tools
  function useTool(toolId) {
    const resultsDiv = document.getElementById('tool-results');
    const contentDiv = document.getElementById('tool-results-content');
    
    if (!resultsDiv || !contentDiv) return;
    
    // Tool results based on the enhanced scenarios
    const toolResults = {
      // Tank Temperature Control (Scenario 1)
      'check_offset': 'Controller Investigation: Found +5C offset applied to temperature reading. This offset makes the controller think the tank is 5C cooler than it actually is.',
      'use_thermometer': 'Portable Thermometer Reading: 80C (actual tank temperature), while controller displays 75C. Confirms 5C discrepancy.',
      'review_reports': 'Quality Reports: Batch reports show temperature consistently 5C higher than setpoint. Product quality declining over past week.',
      'adjust_offset': 'Offset Adjustment: Removing the +5C offset immediately corrects the temperature reading. Tank now shows actual 80C.',
      'inspect_sensor_wiring': 'Wiring Inspection: All thermocouple connections are secure and properly terminated. Cable insulation intact, no signs of damage or moisture intrusion.',
      'check_cooling_system': 'Cooling System Check: Cooling water flow rate is 95% of design, inlet temperature 15C, outlet temperature 18C. System operating within normal parameters.',
      'review_maintenance_log': 'Maintenance Records: Last sensor calibration was 6 months ago, within tolerance. No recent maintenance activities on temperature system.',
      'test_backup_sensor': 'Backup Sensor Test: Secondary temperature sensor also reads 80C actual temperature. Confirms primary sensor is reading correctly.',
      'analyze_trend_data': 'Trend Analysis: Temperature data shows consistent 5C difference between setpoint and actual temperature started exactly 1 week ago.',
      'check_power_supply': 'Power Supply Check: Controller receiving stable 24VDC power, no voltage fluctuations detected. Power quality is excellent.',
      'test_control_valve': 'Control Valve Test: Cooling valve responds properly to manual commands. Valve position feedback matches commanded position.',
      'check_insulation': 'Insulation Inspection: Tank insulation is intact with no visible damage. Thermal imaging shows no unexpected heat loss areas.',
      
      // Cleanroom Temperature Control (Scenario 2)
      'check_heat_load': 'Heat Load Analysis: Current production generates 95kW heat load, exceeding design capacity of 85kW by 12%.',
      'verify_chiller_capacity': 'Chiller Performance: Operating at 100% capacity but struggling. Supply temperature 7C higher than design.',
      'analyze_production_schedule': 'Production Correlation: Temperature deviations occur only during peak production hours (9AM-5PM).',
      'inspect_airflow_distribution': 'Airflow Inspection: Some supply ducts partially blocked, reducing cooling efficiency by 15%.',
      
      // CNC Coolant System (Scenario 3)
      'analyze_coolant_quality': 'Coolant Analysis: pH elevated, contamination present. Extended operation degraded coolant chemistry.',
      'inspect_heat_exchanger': 'Heat Exchanger: 40% fouling detected. Reduced thermal efficiency causing poor cooling performance.',
      'monitor_temperature_cycles': 'Temperature Monitoring: Coolant temperature rises steadily during 24hr operation, no recovery time.',
      'verify_flow_distribution': 'Flow Distribution: Uneven flow to machines. Some receiving 70% of design flow rate.',
      
      // Server Room Cooling (Scenario 4)
      'thermal_imaging': 'Thermal Imaging: Hot spots identified around new server racks. Temperature variations up to 8C across room.',
      'airflow_analysis': 'Airflow Analysis: New servers disrupted airflow patterns. Cold air bypassing hot equipment.',
      'power_consumption_review': 'Power Analysis: New servers added 25% heat load, exceeding cooling system design capacity.',
      'emergency_load_balancing': 'Load Balancing: Moving critical processes to cooler areas reduced hot spot temperatures by 3C.',
      
      // Brine Flow Control (Scenario 5)
      'analyze_valve_characteristics': 'Valve Analysis: Control valve undersized for high-temperature brine conditions. Cv too small.',
      'check_cavitation_conditions': 'Cavitation Check: High brine temperature reduces vapor pressure margin. Cavitation occurring at 67% valve position.',
      'review_controller_tuning': 'Controller Tuning: PID parameters too aggressive for cavitating conditions. Causing hunting behavior.',
      'monitor_temperature_effects': 'Temperature Effects: Flow instability increases with brine temperature above 40C.',
      
      // Steam Sterilization (Scenario 6)
      'check_power_supply': 'Power Supply: Voltage fluctuations detected. 24V supply dropping to 21V causing display flickering.',
      'inspect_wiring': 'Wiring Inspection: Loose terminal connection on thermocouple input. Intermittent contact affecting reading.',
      'verify_actual_temperature': 'Temperature Verification: Portable meter reads 121C, controller reads 115C. 6C sensor error.',
      'test_controller_calibration': 'Calibration Test: Controller offset by -6C. Requires recalibration or sensor replacement.',
      
      // Injection Molding Temperature (Scenario 7)
      'thermal_mapping': 'Thermal Mapping: Cavity temperatures: 79C, 82C, 77C, 84C. 7C variation across mold.',
      'cooling_circuit_analysis': 'Cooling Circuits: Uneven flow rates. Circuit 4 has 40% more flow than Circuit 3.',
      'quality_correlation': 'Quality Analysis: Defective parts correlate with cavities having temperature >82C or <78C.',
      'extended_run_monitoring': 'Extended Run Data: Temperature variation increases to 9C after 4 hours of continuous operation.',
      
      // pH Control System (Scenario 8)
      'analyze_ph_response': 'pH Response: Sensor response time 45 seconds, too slow for effective control. Standard should be <15 seconds.',
      'review_control_tuning': 'Control Tuning: Proportional gain too high for slow process. Causing oscillations around setpoint.',
      'check_mixing_efficiency': 'Mixing Analysis: Poor mixing efficiency. Acid addition not uniformly distributed in reactor.',
      'validate_sensor_installation': 'Sensor Installation: pH sensor located in dead zone with poor mixing. Reading not representative.'
    };
    
    const result = toolResults[toolId] || 'Investigation in progress... This tool provides valuable diagnostic information.';
    
    contentDiv.innerHTML = `<p>${result}</p>`;
    resultsDiv.style.display = 'block';
    
    // Scroll to results
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  // Troubleshooting Wizard
  function initializeWizard() {
    window.wizardStep = 1;
    window.wizardScore = 0;
    updateWizardProgress();
  }

  function selectWizardOption(step, option) {
    const correctAnswers = {
      1: 'safety',
      2: 'oil',
      3: 'sensor',
      4: 'pressure',
      5: 'reset'
    };

    const feedback = {
      safety: 'Correct! Always check safety systems first.',
      power: 'Good thinking, but safety should come first.',
      oil: 'The day shift mentioned oil issues - good observation!',
      wifi: 'Wi-Fi issues are rarely the cause of system failures.'
    };

    if (correctAnswers[step] === option) {
      window.wizardScore += 20;
      showWizardFeedback(feedback[option] || 'Correct!', true);
    } else {
      showWizardFeedback(feedback[option] || 'Try again. Think about the scenario context.', false);
    }

    // Move to next step after delay
    setTimeout(() => {
      if (step < 5) {
        showWizardStep(step + 1);
      } else {
        showWizardComplete();
      }
    }, 2000);
  }

  function showWizardStep(step) {
    window.wizardStep = step;
    updateWizardProgress();
    
    const wizardContent = document.getElementById('wizard-content');
    const steps = [
      {
        title: 'Step 1: Initial Assessment',
        question: 'What is the first thing you should check when the system won\'t start?',
        options: [
          { key: 'safety', text: 'A) Check safety systems and emergency stops' },
          { key: 'power', text: 'B) Check power supply and circuit breakers' },
          { key: 'oil', text: 'C) Check oil level and temperature' },
          { key: 'wifi', text: 'D) Check Wi-Fi connection' }
        ]
      },
      {
        title: 'Step 2: Investigate the Clue',
        question: 'The day shift engineer mentioned oil was too cold. What should you check?',
        options: [
          { key: 'temp', text: 'A) Check oil temperature' },
          { key: 'oil', text: 'B) Check oil level and viscosity' },
          { key: 'pump', text: 'C) Check pump operation' },
          { key: 'valve', text: 'D) Check valve position' }
        ]
      },
      {
        title: 'Step 3: System Diagnostics',
        question: 'Which component would you inspect first based on the oil temperature issue?',
        options: [
          { key: 'heater', text: 'A) Oil heater system' },
          { key: 'sensor', text: 'B) Temperature sensors' },
          { key: 'pump', text: 'C) Hydraulic pump' },
          { key: 'valve', text: 'D) Control valves' }
        ]
      },
      {
        title: 'Step 4: Root Cause Analysis',
        question: 'What is the most likely root cause of the system failure?',
        options: [
          { key: 'low-oil', text: 'A) Low oil level' },
          { key: 'pressure', text: 'B) Low system pressure' },
          { key: 'temp', text: 'C) Cold oil preventing proper operation' },
          { key: 'sensor', text: 'D) Faulty temperature sensor' }
        ]
      },
      {
        title: 'Step 5: Solution Implementation',
        question: 'What is the correct action to resolve this issue?',
        options: [
          { key: 'reset', text: 'A) Reset the system and try again' },
          { key: 'heat', text: 'B) Warm up the oil before starting' },
          { key: 'replace', text: 'C) Replace the oil completely' },
          { key: 'bypass', text: 'D) Bypass the temperature sensor' }
        ]
      }
    ];

    if (steps[step - 1]) {
      const stepData = steps[step - 1];
      wizardContent.innerHTML = `
        <div class="wizard-step" data-step="${step}" style="display: block;">
          <h3 style="color: #FFFFFF; margin-bottom: 15px;">${stepData.title}</h3>
          <p style="color: #FFFFFF; margin-bottom: 20px;">${stepData.question}</p>
          <div class="wizard-options">
            ${stepData.options.map(option => `
              <button class="wizard-option" onclick="selectWizardOption(${step}, '${option.key}')" 
                      style="background: #333; color: white; border: 1px solid #555; padding: 15px; margin: 10px; border-radius: 8px; cursor: pointer; width: 100%; text-align: left;">
                ${option.text}
              </button>
            `).join('')}
          </div>
        </div>
      `;
    }
  }

  function showWizardFeedback(message, isCorrect) {
    const feedback = document.createElement('div');
    feedback.style.cssText = `
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: ${isCorrect ? '#4CAF50' : '#FF5722'}; color: white;
      padding: 20px; border-radius: 8px; z-index: 1000;
      font-weight: bold; text-align: center;
    `;
    feedback.textContent = message;
    document.body.appendChild(feedback);
    
    setTimeout(() => feedback.remove(), 2000);
  }

  function showWizardComplete() {
    const wizardContent = document.getElementById('wizard-content');
    wizardContent.innerHTML = `
      <div style="text-align: center; color: #FFFFFF;">
        <h3 style="color: #4CAF50; margin-bottom: 20px;"> Troubleshooting Complete!</h3>
        <p>Final Score: <span style="color: #FF9800; font-weight: bold;">${window.wizardScore}/100</span></p>
        <p style="margin-top: 20px;">You've successfully identified and resolved the fault!</p>
        <button onclick="restartWizard()" style="background: #4CAF50; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; margin-top: 20px;">
          Try Again
        </button>
      </div>
    `;
  }

  function restartWizard() {
    window.wizardStep = 1;
    window.wizardScore = 0;
    updateWizardProgress();
    showWizardStep(1);
  }

  function updateWizardProgress() {
    const progress = document.getElementById('wizard-progress');
    const currentStep = document.getElementById('current-step');
    const score = document.getElementById('wizard-score');
    
    if (progress) progress.style.width = (window.wizardStep / 5) * 100 + '%';
    if (currentStep) currentStep.textContent = window.wizardStep;
    if (score) score.textContent = `Score: ${window.wizardScore}`;
  }

  // System Simulation
  function startSystemSimulation() {
    setInterval(() => {
      updateSystemStatus();
      updateChart();
    }, 1000);
  }

  function updateSystemStatus() {
    const temp = document.getElementById('temp-slider')?.value || 150;
    const pressure = document.getElementById('pressure-slider')?.value || 5;
    const flow = document.getElementById('flow-slider')?.value || 50;
    const oil = document.getElementById('oil-slider')?.value || 80;

    // Update status indicators based on values
    const pumpStatus = document.getElementById('pump-status');
    const valveStatus = document.getElementById('valve-status');
    const sensorStatus = document.getElementById('sensor-status');
    const alarmStatus = document.getElementById('alarm-status');

    if (pumpStatus) {
      if (oil < 20) {
        pumpStatus.style.background = '#f44336';
        pumpStatus.innerHTML = '<i class="fas fa-cog"></i><br>PUMP: STOPPED';
      } else {
        pumpStatus.style.background = '#4CAF50';
        pumpStatus.innerHTML = '<i class="fas fa-cog"></i><br>PUMP: RUNNING';
      }
    }

    if (alarmStatus) {
      if (temp > 180 || oil < 20 || pressure < 2) {
        alarmStatus.style.background = '#f44336';
        alarmStatus.innerHTML = '<i class="fas fa-bell"></i><br>ALARMS: ACTIVE';
      } else {
        alarmStatus.style.background = '#333';
        alarmStatus.innerHTML = '<i class="fas fa-bell"></i><br>ALARMS: NONE';
      }
    }
  }

  // Fault Injection
  function injectFault(faultType) {
    const sliders = {
      'low-oil': { id: 'oil-slider', value: 15 },
      'high-temp': { id: 'temp-slider', value: 190 },
      'low-pressure': { id: 'pressure-slider', value: 1.5 },
      'sensor-fail': { id: 'temp-slider', value: 0 }
    };

    if (sliders[faultType]) {
      const slider = document.getElementById(sliders[faultType].id);
      if (slider) {
        slider.value = sliders[faultType].value;
        slider.dispatchEvent(new Event('input'));
      }
    }

    showFaultFeedback(faultType);
  }

  function showFaultFeedback(faultType) {
    const messages = {
      'low-oil': 'Low oil level fault injected! System pressure dropping...',
      'high-temp': 'High temperature fault injected! Thermal protection activating...',
      'low-pressure': 'Low pressure fault injected! Pump struggling to maintain flow...',
      'sensor-fail': 'Sensor failure injected! System operating with default values...'
    };

    const feedback = document.createElement('div');
    feedback.style.cssText = `
      position: fixed; top: 20px; right: 20px;
      background: #FF5722; color: white; padding: 15px;
      border-radius: 8px; z-index: 1000; font-weight: bold;
    `;
    feedback.textContent = messages[faultType] || 'Fault injected!';
    document.body.appendChild(feedback);
    
    setTimeout(() => feedback.remove(), 3000);
  }

  function resetSystem() {
    const sliders = ['temp-slider', 'pressure-slider', 'flow-slider', 'oil-slider'];
    const defaultValues = [150, 5, 50, 80];

    sliders.forEach((sliderId, index) => {
      const slider = document.getElementById(sliderId);
      if (slider) {
        slider.value = defaultValues[index];
        slider.dispatchEvent(new Event('input'));
      }
    });

    showFaultFeedback('System reset to normal operation');
  }

  // Chart functionality
  function initializeChart() {
    const canvas = document.getElementById('system-chart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    window.chartData = {
      time: [],
      temperature: [],
      pressure: [],
      flow: []
    };

    // Initialize chart
    ctx.fillStyle = '#222';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  function updateChart() {
    const canvas = document.getElementById('system-chart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const now = Date.now();
    
    // Add new data points
    window.chartData.time.push(now);
    window.chartData.temperature.push(document.getElementById('temp-slider')?.value || 150);
    window.chartData.pressure.push(document.getElementById('pressure-slider')?.value || 5);
    window.chartData.flow.push(document.getElementById('flow-slider')?.value || 50);

    // Keep only last 50 points
    if (window.chartData.time.length > 50) {
      window.chartData.time.shift();
      window.chartData.temperature.shift();
      window.chartData.pressure.shift();
      window.chartData.flow.shift();
    }

    // Draw chart
    ctx.fillStyle = '#222';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Draw grid
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 1;
    for (let i = 0; i < canvas.width; i += 50) {
      ctx.beginPath();
      ctx.moveTo(i, 0);
      ctx.lineTo(i, canvas.height);
      ctx.stroke();
    }

    // Draw data lines
    if (window.chartData.time.length > 1) {
      // Temperature line (red)
      ctx.strokeStyle = '#f44336';
      ctx.lineWidth = 2;
      ctx.beginPath();
      window.chartData.temperature.forEach((temp, i) => {
        const x = (i / window.chartData.temperature.length) * canvas.width;
        const y = canvas.height - (temp / 200) * canvas.height;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // Pressure line (blue)
      ctx.strokeStyle = '#2196F3';
      ctx.beginPath();
      window.chartData.pressure.forEach((pressure, i) => {
        const x = (i / window.chartData.pressure.length) * canvas.width;
        const y = canvas.height - (pressure / 10) * canvas.height;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }
  }

    // Render the interactive worksheet content directly to the container
    async function renderInteractiveWorksheet(worksheetId) {
      console.log('renderInteractiveWorksheet called with worksheetId:', worksheetId);
      const container = document.getElementById('worksheet-content');
      
      try {
        console.log('Fetching dbMaintenanceScenarios.json...');
        // Load the questions from the JSON file
        const response = await fetch('dbMaintenanceScenarios.json');
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('JSON data loaded, scenarios count:', data.scenarios ? data.scenarios.length : 'undefined');
        const scenario = data.scenarios.find(s => s.id === worksheetId);
        console.log('Found scenario:', scenario ? scenario.title : 'NOT FOUND');
        
        if (!scenario || !scenario.questions) {
          console.error(`Could not load questions for worksheet ${worksheetId}`);
          return;
        }
        
        console.log('Scenario questions count:', scenario.questions.length);
        console.log('Scenario has image:', scenario.image);
        
        // Generate multiple choice questions HTML
        const questionsHTML = scenario.questions.map((question, index) => {
          if (question.type === 'multiple_choice') {
            return `
              <div class="question-item" data-question="${question.id}" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question ${index + 1}: ${question.text}</h4>
                <div class="multiple-choice-options" style="margin-bottom: 15px;">
                  ${question.options.map((option, optionIndex) => `
                    <label class="option-label" style="display: block; margin-bottom: 10px; cursor: pointer; padding: 10px; border: 2px solid #555; border-radius: 4px; transition: all 0.3s ease;">
                      <input type="radio" name="question-${question.id}" value="${optionIndex}" style="margin-right: 10px;">
                      <span style="color: #FFFFFF;">${option}</span>
                    </label>
                  `).join('')}
                </div>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitMultipleChoiceQuestion('${question.id}')" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                  <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be checked against the correct answer.</span>
                </div>
                <div class="answer-feedback hidden" style="margin-top: 15px; padding: 15px; border-radius: 4px; display: none;">
                  <div class="feedback-content"></div>
                </div>
              </div>
            `;
          } else {
            // Fallback for text questions
            return `
              <div class="question-item" data-question="${question.id}" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question ${index + 1}: ${question.text}</h4>
                <textarea class="answer-input" data-question="${question.id}" placeholder="Enter your answer here..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitQuestion('${question.id}')" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                  <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be saved and compared to the correct answer.</span>
                </div>
                <div class="individual-comparison hidden"></div>
              </div>
            `;
          }
        }).join('');
        
        // Create the worksheet content - special handling for Worksheet 1
        if (worksheetId === 1) {
          // Special content for Worksheet 1 with all sections
          container.innerHTML = `
            <h1 class="page-title">${scenario.title}</h1>

            <div class="worksheet-section introduction-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);">
              <h2 class="section-header" style="color: #2196F3; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-info-circle"></i> 1. Introduction</h2>
              <div class="worksheet-content">
                <p>The system you have in front of you is a Closed-Loop Flow Control system, meaning it continuously adjusts itself to meet a desired target, called the setpoint. It does this by using feedback from sensors to control devices like pumps and valves, keeping the system accurate and stable even if conditions change.</p>
                
                <div class="cad-images" style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
                  <figure style="text-align: center;">
                    <img src="assets/cad.png" alt="CAD Diagram 1" style="max-width: 300px; height: auto; border-radius: 4px;">
                    <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Front View</figcaption>
                  </figure>
                  <figure style="text-align: center;">
                    <img src="assets/cad2.png" alt="CAD Diagram 2" style="max-width: 300px; height: auto; border-radius: 4px;">
                    <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Side View</figcaption>
                  </figure>
                </div>
              </div>
            </div>

            <div class="worksheet-section over-to-you-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FF9800; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.2);">
              <h2 class="section-header" style="color: #FF9800; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-hands-helping"></i> 2. Over To You</h2>
              <div class="worksheet-content">
                <p style="color: #FFFFFF; margin-bottom: 20px; font-weight: bold;">Select Start and observe the system start up. Once the pump is running you should see water flow through the flow gauge. Ensure the hand valve is in the open position, (the handle should be in line with the piping).</p>
                
                <div class="steps-container">
                  <div class="step-card" data-step="1" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                    <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                    <div class="step-content" style="flex: 1;">
                      <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #FFFFFF; margin: 0;">Set a Flow Rate</h4>
                        <label class="step-checkbox">
                          <input type="checkbox" class="step-complete-checkbox">
                          <span class="checkmark" style="margin-left: 10px;"></span>
                        </label>
                      </div>
                      <p style="color: #FFFFFF; margin: 0;">Enter a target flow rate on the HMI. You can adjust in increments of 20 using the +/- buttons.</p>
                    </div>
                  </div>

                  <div class="step-card" data-step="2" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                    <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                    <div class="step-content" style="flex: 1;">
                      <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #FFFFFF; margin: 0;">Observe Feedback</h4>
                        <label class="step-checkbox">
                          <input type="checkbox" class="step-complete-checkbox">
                          <span class="checkmark" style="margin-left: 10px;"></span>
                        </label>
                      </div>
                      <p style="color: #FFFFFF; margin: 0;">Watch the flow sensor reading on the HMI and compare it to the setpoint.</p>
                    </div>
                  </div>

                  <div class="step-card" data-step="3" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                    <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                    <div class="step-content" style="flex: 1;">
                      <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #FFFFFF; margin: 0;">Watch the System Adjust</h4>
                        <label class="step-checkbox">
                          <input type="checkbox" class="step-complete-checkbox">
                          <span class="checkmark" style="margin-left: 10px;"></span>
                        </label>
                      </div>
                      <p style="color: #FFFFFF; margin: 0;">Note how the pump speed and valve position change to bring the flow rate to the setpoint.</p>
                    </div>
                  </div>

                  <div class="step-card" data-step="4" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                    <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                    <div class="step-content" style="flex: 1;">
                      <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #FFFFFF; margin: 0;">Introduce a Disturbance</h4>
                        <label class="step-checkbox">
                          <input type="checkbox" class="step-complete-checkbox">
                          <span class="checkmark" style="margin-left: 10px;"></span>
                        </label>
                      </div>
                      <p style="color: #FFFFFF; margin: 0;">Temporarily restrict the flow (e.g., partially close the shut-off valve) and observe how the system reacts to maintain the flow rate.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="so-what-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; margin-bottom: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);">
              <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-lightbulb"></i> 3. So What?</h2>
              <div class="so-what-content">
                <p style="color: #FFFFFF; margin-bottom: 20px;">This is part of a control system, which automates processes in Industry. At the heart of this system is a PLC (Programmable Logic Controller), a computer that makes real-time decisions based on sensor data. The HMI (Human-Machine Interface) allows you to monitor and adjust settings easily.</p>
                
                <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                  <i class="fas fa-lightbulb" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                  <div>
                    <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Feedback Control</strong>
                    <p style="color: #FFFFFF; margin: 0;">The system continuously measures the actual flow rate and compares it to the desired setpoint. If there's a difference, it automatically adjusts the pump speed or valve position to correct it.</p>
                  </div>
                </div>
                
                <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                  <i class="fas fa-cogs" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                  <div>
                    <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Real-Time Automation</strong>
                    <p style="color: #FFFFFF; margin: 0;">The PLC processes sensor data and makes control decisions in milliseconds, far faster than any human could react. This ensures consistent, accurate control even when conditions change.</p>
                  </div>
                </div>
                
                <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                  <i class="fas fa-shield-alt" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                  <div>
                    <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Stability & Reliability</strong>
                    <p style="color: #FFFFFF; margin: 0;">Closed-loop systems are self-correcting. If something tries to disturb the process (like partially closing a valve), the system automatically compensates to maintain the desired flow rate.</p>
                  </div>
                </div>
                
                <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                  <i class="fas fa-industry" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                  <div>
                    <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Industrial Applications</strong>
                    <p style="color: #FFFFFF; margin: 0;">These principles are used everywhere in industry - from temperature control in manufacturing to pressure regulation in chemical plants. Understanding this system gives you insight into how modern automation works.</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="worksheet-section questions-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #4CAF50; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.2);">
              <h2 class="section-header" style="color: #4CAF50; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-question-circle"></i> 4. Questions & Answers</h2>
              <div class="questions-content">
                ${questionsHTML}
              </div>
            </div>

            <!-- PID Tuning Section -->
            <div class="simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);">
              <h2 class="section-header" style="color: #E91E63; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-line"></i> 5.1 PID Tuning</h2>
              
              <!-- PID Tuning Interface -->
              <div class="tab-content" id="tuning-tab">
                  <!-- Main control panel for setpoint and process variable -->
                  <div class="control-panel" style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; background: #333; padding: 20px; border-radius: 8px;">
                      <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                          <label style="color: #FFFFFF; min-width: 80px; font-weight: bold;">Setpoint:</label>
                          <input type="range" id="setpoint-slider" min="0" max="100" value="50" style="width: 150px;">
                          <span id="setpoint-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 60px;">50.0C</span>
                      </div>
                      <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                          <label style="color: #FFFFFF; min-width: 80px; font-weight: bold;">Process Variable:</label>
                          <span id="pv-value" class="value-display" style="color: #2196F3; font-weight: bold; min-width: 60px;">25.0C</span>
                      </div>
                      <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                          <label style="color: #FFFFFF; min-width: 80px; font-weight: bold;">Control Output:</label>
                          <span id="control-output-value" class="value-display" style="color: #4CAF50; font-weight: bold; min-width: 60px;">0.0%</span>
                      </div>
                  </div>

                  <!-- PID Parameter Tuning Panel -->
                  <div class="pid-tuning-panel" style="background: #333; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                      <h4 style="color: #FFFFFF; margin-bottom: 20px; font-size: 18px;">PID Parameters</h4>
                      <div class="tuning-controls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                          <!-- Proportional control -->
                          <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                              <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Proportional (Kp):</label>
                              <input type="range" id="kp-slider" min="0" max="2" step="0.1" value="0.5" style="flex: 1;">
                              <span id="kp-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.5</span>
                          </div>
                          <!-- Integral control -->
                          <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                              <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Integral (Ki):</label>
                              <input type="range" id="ki-slider" min="0" max="1" step="0.05" value="0.1" style="flex: 1;">
                              <span id="ki-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.1</span>
                          </div>
                          <!-- Derivative control -->
                          <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                              <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Derivative (Kd):</label>
                              <input type="range" id="kd-slider" min="0" max="1" step="0.05" value="0.2" style="flex: 1;">
                              <span id="kd-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.2</span>
                          </div>
                      </div>
                      <!-- Enhanced Real-time Performance Metrics for Maintenance Assessment -->
                      <div class="performance-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; background: #222; padding: 20px; border-radius: 8px;">
                          <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                              <label style="color: #FFFFFF; font-weight: bold;">Rise Time:</label>
                              <span id="rise-time" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0s</span>
                          </div>
                          <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                              <label style="color: #FFFFFF; font-weight: bold;">Overshoot:</label>
                              <span id="overshoot" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0%</span>
                          </div>
                          <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                              <label style="color: #FFFFFF; font-weight: bold;">Settling Time:</label>
                              <span id="settling-time" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0s</span>
                          </div>
                          <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                              <label style="color: #FFFFFF; font-weight: bold;">Steady State Error:</label>
                              <span id="steady-error" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0C</span>
                          </div>
                          <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                              <label style="color: #FFFFFF; font-weight: bold;">System Health:</label>
                              <span id="system-health" class="metric-value" style="color: #4CAF50; font-weight: bold; font-size: 16px;">Excellent</span>
                          </div>
                          <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                              <label style="color: #FFFFFF; font-weight: bold;">Maintenance Due:</label>
                              <span id="maintenance-due" class="metric-value" style="color: #FF9800; font-weight: bold; font-size: 16px;">30 days</span>
                          </div>
                      </div>
                      
                      <!-- Maintenance Assessment Panel -->
                      <div class="maintenance-assessment" style="background: #333; padding: 20px; border-radius: 8px; margin-top: 20px;">
                          <h5 style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;"><i class="fas fa-clipboard-check"></i> Maintenance Assessment</h5>
                          <div class="assessment-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                              <div class="assessment-item" style="background: #222; padding: 10px; border-radius: 6px; text-align: center;">
                                  <div style="color: #4CAF50; font-size: 14px; font-weight: bold;">PID Performance</div>
                                  <div id="pid-performance" style="color: #FFFFFF; font-size: 12px;">Optimal</div>
                              </div>
                              <div class="assessment-item" style="background: #222; padding: 10px; border-radius: 6px; text-align: center;">
                                  <div style="color: #4CAF50; font-size: 14px; font-weight: bold;">System Stability</div>
                                  <div id="system-stability" style="color: #FFFFFF; font-size: 12px;">Stable</div>
                              </div>
                              <div class="assessment-item" style="background: #222; padding: 10px; border-radius: 6px; text-align: center;">
                                  <div style="color: #4CAF50; font-size: 14px; font-weight: bold;">Response Quality</div>
                                  <div id="response-quality" style="color: #FFFFFF; font-size: 12px;">Good</div>
                              </div>
                              <div class="assessment-item" style="background: #222; padding: 10px; border-radius: 6px; text-align: center;">
                                  <div style="color: #4CAF50; font-size: 14px; font-weight: bold;">Fault Tolerance</div>
                                  <div id="fault-tolerance" style="color: #FFFFFF; font-size: 12px;">High</div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
            </div>

            <!-- Enhanced System Response Section with Industrial Maintenance Features -->
            <div class="simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);">
              <h2 class="section-header" style="color: #E91E63; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-line"></i> 5.2 Industrial System Response Analysis</h2>
              
              <!-- Maintenance Mode Selection -->
              <div class="maintenance-mode-panel" style="background: linear-gradient(135deg, #2a2a2a, #3a3a3a); border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 2px solid #FF9800; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.2);">
                <h4 style="color: #FF9800; margin-bottom: 20px; font-size: 18px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-tools"></i> Maintenance Mode Selection</h4>
                <div class="mode-selection" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                  <label class="mode-option" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 15px; background: #333; border-radius: 8px; border: 2px solid transparent; transition: all 0.3s ease;">
                    <input type="radio" name="maintenance-mode" value="normal" checked style="accent-color: #FF9800;">
                    <span style="color: #FFFFFF; font-weight: 500;">Normal Operation</span>
                  </label>
                  <label class="mode-option" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 15px; background: #333; border-radius: 8px; border: 2px solid transparent; transition: all 0.3s ease;">
                    <input type="radio" name="maintenance-mode" value="cold-start" style="accent-color: #FF9800;">
                    <span style="color: #FFFFFF; font-weight: 500;">Cold Start</span>
                  </label>
                  <label class="mode-option" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 15px; background: #333; border-radius: 8px; border: 2px solid transparent; transition: all 0.3s ease;">
                    <input type="radio" name="maintenance-mode" value="maintenance" style="accent-color: #FF9800;">
                    <span style="color: #FFFFFF; font-weight: 500;">Maintenance Mode</span>
                  </label>
                </div>
              </div>
              
              <!-- Disturbance Injection Panel -->
              <div class="disturbance-panel" style="background: linear-gradient(135deg, #2a2a2a, #3a3a3a); border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 2px solid #F44336; box-shadow: 0 8px 20px rgba(244, 67, 54, 0.2);">
                <h4 style="color: #F44336; margin-bottom: 20px; font-size: 18px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-exclamation-triangle"></i> Fault Injection & Disturbance Testing</h4>
                <div class="disturbance-controls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                  <div class="disturbance-group" style="background: #333; padding: 15px; border-radius: 8px;">
                    <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Valve Blockage (%)</label>
                    <input type="range" id="valve-blockage" min="0" max="80" value="0" style="width: 100%;">
                    <span id="valve-blockage-value" style="color: #F44336; font-weight: bold;">0%</span>
                  </div>
                  <div class="disturbance-group" style="background: #333; padding: 15px; border-radius: 8px;">
                    <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Pump Wear (%)</label>
                    <input type="range" id="pump-wear" min="0" max="50" value="0" style="width: 100%;">
                    <span id="pump-wear-value" style="color: #F44336; font-weight: bold;">0%</span>
                  </div>
                  <div class="disturbance-group" style="background: #333; padding: 15px; border-radius: 8px;">
                    <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Sensor Drift (C)</label>
                    <input type="range" id="sensor-drift" min="-10" max="10" value="0" style="width: 100%;">
                    <span id="sensor-drift-value" style="color: #F44336; font-weight: bold;">0C</span>
                  </div>
                </div>
                <div class="disturbance-buttons" style="display: flex; gap: 15px; margin-top: 20px; justify-content: center;">
                  <button id="inject-disturbance" class="action-button" style="background: #F44336; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                    <i class="fas fa-bolt"></i> Inject Disturbance
                  </button>
                  <button id="clear-disturbance" class="action-button" style="background: #555; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                    <i class="fas fa-eraser"></i> Clear All
                  </button>
                </div>
              </div>
              
              <!-- System Response Testing Interface -->
              <div class="tab-content" id="response-tab">
                  <!-- Response Type Selection -->
                  <div class="response-control-panel" style="background: linear-gradient(135deg, #2a2a2a, #3a3a3a); border-radius: 12px; padding: 30px; margin-bottom: 30px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.2);">
                      <h4 style="color: #E91E63; margin-bottom: 25px; font-size: 20px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-sliders-h"></i> Response Type Selection</h4>
                      
                      <div class="control-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 25px;">
                          <!-- Input Type Selection -->
                          <div class="control-section" style="background: #333; padding: 20px; border-radius: 8px;">
                              <h5 style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;"><i class="fas fa-wave-square"></i> Input Signal Type</h5>
                              <div class="input-type-options" style="display: flex; flex-direction: column; gap: 12px;">
                                  <label class="radio-option" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border-radius: 6px; transition: all 0.3s ease;">
                                      <input type="radio" name="input-type" value="step" checked style="accent-color: #E91E63;">
                                      <span style="color: #FFFFFF; font-weight: 500;">Step Response</span>
                                      <span style="color: #AAA; font-size: 12px; margin-left: auto;">Instant change</span>
                                  </label>
                                  <label class="radio-option" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border-radius: 6px; transition: all 0.3s ease;">
                                      <input type="radio" name="input-type" value="ramp" style="accent-color: #E91E63;">
                                      <span style="color: #FFFFFF; font-weight: 500;">Ramp Response</span>
                                      <span style="color: #AAA; font-size: 12px; margin-left: auto;">Linear increase</span>
                                  </label>
                                  <label class="radio-option" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border-radius: 6px; transition: all 0.3s ease;">
                                      <input type="radio" name="input-type" value="sine" style="accent-color: #E91E63;">
                                      <span style="color: #FFFFFF; font-weight: 500;">Sinusoidal Response</span>
                                      <span style="color: #AAA; font-size: 12px; margin-left: auto;">Oscillating input</span>
                                  </label>
                              </div>
                          </div>
                          
                          <!-- Response PID Controls -->
                          <div class="control-section" style="background: #333; padding: 20px; border-radius: 8px;">
                              <h5 style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;"><i class="fas fa-tachometer-alt"></i> Response PID Settings</h5>
                              <div class="response-pid-controls" style="display: flex; flex-direction: column; gap: 15px;">
                                  <!-- Proportional control -->
                                  <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                                      <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Proportional (Kp):</label>
                                      <input type="range" id="response-kp-slider" min="0" max="2" step="0.1" value="0.5" style="flex: 1;">
                                      <span id="response-kp-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.5</span>
                                  </div>
                                  <!-- Integral control -->
                                  <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                                      <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Integral (Ki):</label>
                                      <input type="range" id="response-ki-slider" min="0" max="1" step="0.05" value="0.1" style="flex: 1;">
                                      <span id="response-ki-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.1</span>
                                  </div>
                                  <!-- Derivative control -->
                                  <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                                      <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Derivative (Kd):</label>
                                      <input type="range" id="response-kd-slider" min="0" max="1" step="0.05" value="0.2" style="flex: 1;">
                                      <span id="response-kd-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.2</span>
                                  </div>
                              </div>
                          </div>
                      </div>
                      
                      <!-- Action Buttons -->
                      <div class="action-buttons" style="display: flex; gap: 15px; justify-content: center;">
                          <button id="start-response" class="action-button primary" style="background: linear-gradient(135deg, #E91E63, #C2185B); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px;">
                              <i class="fas fa-play"></i> Start Test
                          </button>
                          <button id="stop-response" class="action-button secondary" style="background: #555; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px;">
                              <i class="fas fa-stop"></i> Stop Test
                          </button>
                          <button id="reset-response" class="action-button secondary" style="background: #555; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px;">
                              <i class="fas fa-redo"></i> Reset
                          </button>
                      </div>
                  </div>
                  
                  <!-- Response Graph -->
                  <div class="response-graph-container" style="background: linear-gradient(135deg, #2a2a2a, #3a3a3a); border-radius: 12px; padding: 30px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.2);">
                      <h4 style="color: #E91E63; margin-bottom: 25px; font-size: 20px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-line"></i> System Response Analysis</h4>
                      
                      <div class="graph-wrapper" style="position: relative;">
                          <canvas id="response-chart" style="background: #222; border-radius: 8px; width: 100%; height: 400px; border: 2px solid #555;"></canvas>
                      </div>
                  </div>
              </div>
            </div>

            <!-- Challenges Section -->
            <div class="simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);">
              <h2 class="section-header" style="color: #E91E63; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-line"></i> 5.3 Challenges</h2>
              
              <!-- Interactive Challenges Interface -->
              <div class="tab-content" id="challenges-tab">
                  <div class="challenge-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px;">
                      <!-- Challenge 1: Minimal Overshoot -->
                      <div class="challenge-card" data-challenge="1" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                          <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-target"></i> Challenge 1: Minimal Overshoot</h4>
                          <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Tune the system to achieve less than 5% overshoot</p>
                          <button class="start-challenge" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Start Challenge</button>
                      </div>
                      <!-- Challenge 2: Fast Response -->
                      <div class="challenge-card" data-challenge="2" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                          <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-tachometer-alt"></i> Challenge 2: Fast Response</h4>
                          <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Achieve settling time under 3 seconds</p>
                          <button class="start-challenge" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Start Challenge</button>
                      </div>
                      <!-- Challenge 3: Disturbance Rejection -->
                      <div class="challenge-card" data-challenge="3" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                          <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-shield-alt"></i> Challenge 3: Disturbance Rejection</h4>
                          <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Maintain stable control with random disturbances</p>
                          <button class="start-challenge" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Start Challenge</button>
                      </div>
                  </div>
              </div>
            </div>

            <!-- Industrial Flow Loop Behavior Simulation -->
            <div class="simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.3);">
              <h2 class="section-header" style="color: #2196F3; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-water"></i> 5.4 Industrial Flow Loop Behavior</h2>
              
              <!-- Flow Loop Control Panel -->
              <div class="flow-loop-panel" style="background: linear-gradient(135deg, #2a2a2a, #3a3a3a); border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);">
                <h4 style="color: #2196F3; margin-bottom: 20px; font-size: 18px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-cogs"></i> Pump & Valve Coordination</h4>
                
                <div class="flow-controls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                  <div class="control-group" style="background: #333; padding: 15px; border-radius: 8px;">
                    <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Flow Setpoint (L/min)</label>
                    <input type="range" id="flow-setpoint" min="0" max="100" value="50" style="width: 100%;">
                    <span id="flow-setpoint-value" style="color: #2196F3; font-weight: bold;">50 L/min</span>
                  </div>
                  <div class="control-group" style="background: #333; padding: 15px; border-radius: 8px;">
                    <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Pump Speed (%)</label>
                    <span id="pump-speed" style="color: #4CAF50; font-weight: bold; font-size: 18px;">75%</span>
                    <div class="pump-status" style="color: #FFFFFF; font-size: 12px; margin-top: 5px;">Running</div>
                  </div>
                  <div class="control-group" style="background: #333; padding: 15px; border-radius: 8px;">
                    <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Valve Position (%)</label>
                    <span id="valve-position" style="color: #FF9800; font-weight: bold; font-size: 18px;">60%</span>
                    <div class="valve-status" style="color: #FFFFFF; font-size: 12px; margin-top: 5px;">Open</div>
                  </div>
                </div>
                
                <div class="flow-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #222; padding: 15px; border-radius: 8px;">
                  <div class="metric">
                    <label style="color: #FFFFFF; font-size: 12px;">Actual Flow</label>
                    <div id="actual-flow" style="color: #2196F3; font-weight: bold; font-size: 16px;">48.5 L/min</div>
                  </div>
                  <div class="metric">
                    <label style="color: #FFFFFF; font-size: 12px;">Pressure Drop</label>
                    <div id="pressure-drop" style="color: #FF5722; font-weight: bold; font-size: 16px;">2.3 bar</div>
                  </div>
                  <div class="metric">
                    <label style="color: #FFFFFF; font-size: 12px;">System Efficiency</label>
                    <div id="system-efficiency" style="color: #4CAF50; font-weight: bold; font-size: 16px;">94%</div>
                  </div>
                </div>
              </div>
              
              <!-- Flow Loop Visualization -->
              <div class="flow-visualization" style="background: #222; border-radius: 8px; padding: 20px; border: 2px solid #555;">
                <canvas id="flow-loop-canvas" width="800" height="300" style="background: #222; border-radius: 8px; width: 100%; height: 300px; border: 2px solid #555;"></canvas>
              </div>
            </div>

            <!-- Maintenance Scenarios Section -->
            <div class="simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.3);">
              <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-tools"></i> 5.5 Industrial Maintenance Scenarios</h2>
              
              <div class="maintenance-scenarios" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- Scenario 1: Cold Start -->
                <div class="scenario-card" style="background: #333; padding: 20px; border-radius: 12px; border: 2px solid #9C27B0;">
                  <h4 style="color: #9C27B0; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-thermometer-empty"></i> Cold Start Scenario</h4>
                  <p style="color: #FFFFFF; margin-bottom: 15px; font-size: 14px;">Simulate system startup from cold conditions. Observe how PID parameters affect recovery time and stability.</p>
                  <button class="scenario-button" data-scenario="cold-start" style="background: #9C27B0; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                    Start Cold Start
                  </button>
                </div>
                
                <!-- Scenario 2: Valve Maintenance -->
                <div class="scenario-card" style="background: #333; padding: 20px; border-radius: 12px; border: 2px solid #9C27B0;">
                  <h4 style="color: #9C27B0; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-valve"></i> Valve Maintenance</h4>
                  <p style="color: #FFFFFF; margin-bottom: 15px; font-size: 14px;">Simulate valve wear and maintenance procedures. Learn to identify valve-related performance issues.</p>
                  <button class="scenario-button" data-scenario="valve-maintenance" style="background: #9C27B0; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                    Start Valve Test
                  </button>
                </div>
                
                <!-- Scenario 3: Pump Performance -->
                <div class="scenario-card" style="background: #333; padding: 20px; border-radius: 12px; border: 2px solid #9C27B0;">
                  <h4 style="color: #9C27B0; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-pump"></i> Pump Performance</h4>
                  <p style="color: #FFFFFF; margin-bottom: 15px; font-size: 14px;">Analyze pump performance degradation over time. Understand predictive maintenance indicators.</p>
                  <button class="scenario-button" data-scenario="pump-performance" style="background: #9C27B0; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                    Start Pump Test
                  </button>
                </div>
              </div>
            </div>

            <!-- Main simulation canvas for real-time visualization -->
            <div class="simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);">
              <h2 class="section-header" style="color: #E91E63; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-line"></i> 5.6 Real-Time System Visualization</h2>
              <canvas id="simulation-canvas" class="simulation-canvas" width="800" height="200" style="background: #222; border-radius: 8px; width: 100%; height: 200px; margin: 25px 0; border: 2px solid #555;"></canvas>
            </div>
          `;
          
          // Initialize the interactive features for Worksheet 1
          setTimeout(() => {
            initializeInteractiveFeatures();
            if (typeof initEnhancedPIDSimulation === 'function') {
              initEnhancedPIDSimulation();
            }
          }, 100);
          
        } else {
          // Generic content for all worksheets using JSON structure
          let worksheetHTML = `<h1 class="page-title">${scenario.title}</h1>`;

          // Introduction Section
          if (scenario.introduction) {
            worksheetHTML += `
              <div class="worksheet-section introduction-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);">
                <h2 class="section-header" style="color: #2196F3; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-info-circle"></i> ${scenario.introduction.title}</h2>
                <div class="worksheet-content">
                  ${scenario.introduction.paragraphs.map(paragraph => `<p style="color: #FFFFFF; margin-bottom: 15px;">${paragraph}</p>`).join('')}
                  
                  ${scenario.introduction.keyPoints ? `
                    <div class="key-points" style="margin: 20px 0;">
                      ${scenario.introduction.keyPoints.map(point => `
                        <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px; padding: 15px; background: #333; border-radius: 8px;">
                          <i class="${point.icon}" style="color: ${point.color}; font-size: 20px; margin-top: 5px;"></i>
                          <div>
                            <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">${point.title}</strong>
                            <p style="color: #FFFFFF; margin: 0;">${point.description}</p>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  ` : ''}
                  
                  ${scenario.image ? `
                    <div class="system-diagram" style="text-align: center; margin: 20px 0;">
                      <figure>
                        <img src="assets/maintenance/${scenario.image}" alt="${scenario.title}" style="max-width: 400px; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                        <figcaption style="color: #FFFFFF; margin-top: 10px; font-style: italic;">${scenario.title} System Diagram</figcaption>
                      </figure>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          } else if (scenario.paragraphs) {
            // Fallback for old format
            worksheetHTML += `
              <div class="worksheet-section introduction-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);">
                <h2 class="section-header" style="color: #2196F3; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-info-circle"></i> Introduction</h2>
                <div class="worksheet-content">
                  ${scenario.paragraphs.map(paragraph => `<p style="color: #FFFFFF; margin-bottom: 15px;">${paragraph}</p>`).join('')}
                  
                  ${scenario.image ? `
                    <div class="system-diagram" style="text-align: center; margin: 20px 0;">
                      <figure>
                        <img src="assets/maintenance/${scenario.image}" alt="${scenario.title}" style="max-width: 400px; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                        <figcaption style="color: #FFFFFF; margin-top: 10px; font-style: italic;">${scenario.title} System Diagram</figcaption>
                      </figure>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }

          // Over To You Section
          if (scenario.overToYou) {
            worksheetHTML += `
              <div class="worksheet-section over-to-you-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FF9800; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.2);">
                <h2 class="section-header" style="color: #FF9800; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-user-cog"></i> ${scenario.overToYou.title}</h2>
                <div class="worksheet-content">
                  <p style="color: #FFFFFF; margin-bottom: 20px;">${scenario.overToYou.description}</p>
                  
                  ${scenario.overToYou.objectives ? `
                    <div class="objectives" style="margin: 20px 0;">
                      <h3 style="color: #FF9800; margin-bottom: 15px;">Learning Objectives:</h3>
                      <ul style="color: #FFFFFF; padding-left: 20px;">
                        ${scenario.overToYou.objectives.map(objective => `<li style="margin-bottom: 8px;">${objective}</li>`).join('')}
                      </ul>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }

          // So What Section
          if (scenario.soWhat) {
            worksheetHTML += `
              <div class="worksheet-section so-what-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);">
                <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-lightbulb"></i> ${scenario.soWhat.title}</h2>
                <div class="worksheet-content">
                  <p style="color: #FFFFFF; margin-bottom: 20px;">${scenario.soWhat.description}</p>
                  
                  ${scenario.soWhat.keyLearnings ? `
                    <div class="key-learnings" style="margin: 20px 0;">
                      <h3 style="color: #9C27B0; margin-bottom: 15px;">Key Learnings:</h3>
                      <ul style="color: #FFFFFF; padding-left: 20px;">
                        ${scenario.soWhat.keyLearnings.map(learning => `<li style="margin-bottom: 8px;">${learning}</li>`).join('')}
                      </ul>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }

                  // Simulation Section
        worksheetHTML += `
          <div class="worksheet-section simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #F44336; box-shadow: 0 8px 20px rgba(244, 67, 54, 0.2);">
            <h2 class="section-header" style="color: #F44336; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-stop-circle"></i> Emergency Stop Simulation</h2>
            <p style="color: #FFFFFF; margin-bottom: 15px;">Interactive simulation for testing emergency stop system operation, fault injection, and reset procedures.</p>
            <!-- Emergency Stop simulation will be dynamically generated by simulation script -->
          </div>
        `;

          // Questions Section
          worksheetHTML += `
            <div class="worksheet-section questions-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #4CAF50; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.2);">
              <h2 class="section-header" style="color: #4CAF50; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-question-circle"></i> Questions & Answers</h2>
              <div class="questions-content">
                ${questionsHTML}
              </div>
            </div>
          `;

          container.innerHTML = worksheetHTML;
          
          // Initialize simulation based on worksheet ID
          setTimeout(() => {
            if (worksheetId === 2 && typeof initializeEmergencyStopSimulation === 'function') {
              initializeEmergencyStopSimulation();
            } else if (worksheetId === 1 && typeof initEnhancedPIDSimulation === 'function') {
              initEnhancedPIDSimulation();
            }
          }, 100);
        }
        
        console.log('Worksheet content rendered successfully');
        
        // Hide loading and show content
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        
        console.log('Loading container hidden, main content shown');
        
        // Update navigation buttons
        setTimeout(updateNavigationButtons, 100);
        
        // Initialize simulations based on worksheet type
        setTimeout(() => {
          // Check if we're in maintenance mode
          const urlParams = new URLSearchParams(window.location.search);
          const isMaintenanceMode = urlParams.get('type') === 'maintenance';
          
          if (isMaintenanceMode) {
            // Initialize maintenance procedures and scenarios
            if (typeof initializeMaintenanceProcedures === 'function') {
              initializeMaintenanceProcedures();
            }
            if (typeof initializeIndustrialMaintenanceScenario === 'function') {
              initializeIndustrialMaintenanceScenario();
            }
          }
          
          // Initialize specific simulations based on scenario ID
          if (scenario.id === 2 && typeof initializeEmergencyStopSimulation === 'function') {
            initializeEmergencyStopSimulation();
          } else if (scenario.id === 3 && typeof initializeStatusLEDSimulation === 'function') {
            initializeStatusLEDSimulation();
          } else if (scenario.id === 4 && typeof initializePLCSimulation === 'function') {
            initializePLCSimulation();
          } else if (scenario.id === 5 && typeof initializeHMISimulation === 'function') {
            initializeHMISimulation();
          } else if (scenario.id === 6 && typeof initializePumpSimulation === 'function') {
            initializePumpSimulation();
          } else if (scenario.id === 7 && typeof initializeValveSimulation === 'function') {
            initializeValveSimulation();
          } else if (scenario.id === 8 && typeof initializeFloatSwitchSimulation === 'function') {
            initializeFloatSwitchSimulation();
          }
        }, 200);
        
      } catch (error) {
        console.error('Error rendering interactive worksheet:', error);
        console.error('Error details:', error.message);
        console.error('Error stack:', error.stack);
        renderWorksheet1Fallback();
      }
    }

    // Fallback function to render Worksheet 1 with basic content
    function renderWorksheet1Fallback() {
      const container = document.getElementById('worksheet-content');
      
      container.innerHTML = `
        <h1 class="page-title">
          Worksheet 1: Closed-Loop Control Systems
        </h1>

        <div class="worksheet-section introduction-section">
          <h2 class="section-header">1. Introduction</h2>
          <div class="worksheet-content">
            <p>The system you have in front of you is a Closed-Loop Flow Control system, meaning it continuously adjusts itself to meet a desired target, called the setpoint. It does this by using feedback from sensors to control devices like pumps and valves, keeping the system accurate and stable even if conditions change.</p>
            
            <div class="cad-images" style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
              <figure style="text-align: center;">
                <img src="assets/cad.png" alt="CAD Diagram 1" style="max-width: 300px; height: auto; border-radius: 4px;">
                <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Front View</figcaption>
              </figure>
              <figure style="text-align: center;">
                <img src="assets/cad2.png" alt="CAD Diagram 2" style="max-width: 300px; height: auto; border-radius: 4px;">
                <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Side View</figcaption>
              </figure>
            </div>
          </div>
        </div>

        <div class="worksheet-section over-to-you-section">
          <h2 class="section-header">2. Over To You</h2>
          <div class="worksheet-content">
            <p style="color: #FFFFFF; margin-bottom: 20px; font-weight: bold;">Select Start and observe the system start up. Once the pump is running you should see water flow through the flow gauge. Ensure the hand valve is in the open position, (the handle should be in line with the piping).</p>
            
            <div class="steps-container">
              <div class="step-card" data-step="1" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Set a Flow Rate</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Enter a target flow rate on the HMI. You can adjust in increments of 20 using the +/- buttons.</p>
                </div>
              </div>

              <div class="step-card" data-step="2" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Observe Feedback</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Watch the flow sensor reading on the HMI and compare it to the setpoint.</p>
                </div>
              </div>

              <div class="step-card" data-step="3" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Watch the System Adjust</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Note how the pump speed and valve position change to bring the flow rate to the setpoint.</p>
                </div>
              </div>

              <div class="step-card" data-step="4" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Introduce a Disturbance</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Temporarily restrict the flow (e.g., partially close the shut-off valve) and observe how the system reacts to maintain the flow rate.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="so-what-section" style="background: #2d2d2d; border-radius: 8px; padding: 20px; margin-top: 30px; border-left: 4px solid #4CAF50;">
          <h2 class="section-header" style="color: #FFFFFF; margin-bottom: 20px;">So What?</h2>
          <div class="so-what-content">
            <p style="color: #FFFFFF; margin-bottom: 20px;">This is part of a control system, which automates processes in Industry. At the heart of this system is a PLC (Programmable Logic Controller), a computer that makes real-time decisions based on sensor data. The HMI (Human-Machine Interface) allows you to monitor and adjust settings easily.</p>
            
            <div class="key-point" style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: #1a2f1a; border-radius: 6px;">
              <i class="fas fa-lightbulb" style="font-size: 24px; color: #4CAF50; margin-top: 4px;"></i>
              <div>
                <strong style="display: block; color: #4CAF50; margin-bottom: 8px; font-size: 18px;">Control Loop in Action:</strong>
                <p style="margin: 0; color: #FFFFFF;">Restricting the hand valve reduced flow, which the sensor detected and sent to the PLC. The PLC increased pump speed and adjusted the valve to restore flow, showing automatic correction.</p>
              </div>
            </div>

            <div class="key-point" style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: #1a2f1a; border-radius: 6px;">
              <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #4CAF50; margin-top: 4px;"></i>
              <div>
                <strong style="display: block; color: #4CAF50; margin-bottom: 8px; font-size: 18px;">System Behavior:</strong>
                <p style="margin: 0; color: #FFFFFF;">Rapid valve changes caused oscillations, highlighting the need for gradual adjustments. Fully closing the valve stopped flow; the PLC responded by maxing the pump and opening the valve, but no water moved.</p>
              </div>
            </div>

            <div class="key-point" style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: #1a2f1a; border-radius: 6px;">
              <i class="fas fa-info-circle" style="font-size: 24px; color: #4CAF50; margin-top: 4px;"></i>
              <div>
                <strong style="display: block; color: #4CAF50; margin-bottom: 8px; font-size: 18px;">Important Takeaway:</strong>
                <p style="margin: 0; color: #FFFFFF;">This demonstrates risks like pressure buildup and why managing flow restrictions is critical.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="worksheet-section">
          <h2 class="section-header">Questions and Answers</h2>
          <div class="questions-section">
            <div class="question-item" data-question="1" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">1. What is the purpose of a closed-loop control system?</div>
              <textarea class="answer-input" data-question="1" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(1)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> To continuously adjust flow using sensor feedback to meet a setpoint, maintaining accuracy and stability even if conditions change.
              </div>
            </div>

            <div class="question-item" data-question="2" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">2. What should you ensure about the hand valve before starting the system?</div>
              <textarea class="answer-input" data-question="2" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(2)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> Ensure the hand valve is in the open position, with the handle in line with the piping.
              </div>
            </div>

            <div class="question-item" data-question="3" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">3. What happens when you restrict the flow by partially closing the shut-off valve?</div>
              <textarea class="answer-input" data-question="3" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(3)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> The flow drops, the sensor detects this and sends data to the PLC, which increases pump speed and adjusts the valve to restore flow.
              </div>
            </div>

            <div class="question-item" data-question="4" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">4. What is the role of the PLC in this system?</div>
              <textarea class="answer-input" data-question="4" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(4)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> The PLC is a computer that makes real-time decisions based on sensor data to control devices like pumps and valves.
              </div>
            </div>

            <div class="question-item" data-question="5" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">5. Why can rapid valve changes cause problems?</div>
              <textarea class="answer-input" data-question="5" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(5)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> Rapid changes can cause oscillations in flow, making the system unstable; gradual adjustments help maintain smooth control.
              </div>
            </div>
          </div>
        </div>

        <div class="note" style="background: #2d2a1a; border-left: 4px solid #FFC107; padding: 15px; margin-top: 20px; border-radius: 4px;">
          <p style="color: #FFC107; margin: 0; font-style: italic;"><strong>Note:</strong> This is a simplified version of Worksheet 1. The full interactive version with PID simulation is temporarily unavailable.</p>
        </div>
      `;

      // Initialize basic step completion functionality
      initializeBasicWorksheet1Features();
      
      // Show the content
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      
      // Update navigation buttons
      setTimeout(updateNavigationButtons, 100);
    }

    // Initialize the original Worksheet 1 features
    function initializeOriginalWorksheet1Features() {
      // Initialize step completion functionality
      const stepCards = document.querySelectorAll('.step-card');
      stepCards.forEach(card => {
        const checkbox = card.querySelector('.step-complete-checkbox');
        const stepNumber = card.dataset.step;
        
        // Load saved state
        const savedState = localStorage.getItem(`worksheet1_step${stepNumber}_complete`);
        if (savedState === 'true') {
          checkbox.checked = true;
          card.classList.add('step-completed');
        }

        // Function to toggle step completion
        const toggleStep = (e) => {
          // Don't toggle if clicking the checkbox itself
          if (e.target.type === 'checkbox') return;
          
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            card.classList.add('step-completed');
          } else {
            card.classList.remove('step-completed');
          }
          
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, checkbox.checked);
        };

        card.addEventListener('click', toggleStep);
        
        // Also handle checkbox changes
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            card.classList.add('step-completed');
          } else {
            card.classList.remove('step-completed');
          }
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, e.target.checked);
        });
      });

      // Initialize tab system if present
      if (typeof initTabSystem === 'function') {
        initTabSystem();
      }
      
      // Initialize PID simulation if present
      if (typeof initEnhancedPIDSimulation === 'function') {
        initEnhancedPIDSimulation();
      }
    }

    // Render regular worksheet from JSON data
    function renderWorksheet(scenario, type) {
      const container = document.getElementById('worksheet-content');
      
      // Build content sections based on available data
      let contentSections = [];
      
      // Always include title
      contentSections.push(`<h1 class="page-title">${type === 'fault' ? 'Fault Scenario' : 'Worksheet'} ${scenario.id}: ${scenario.title}</h1>`);
      
      // Introduction/Description section (always present if paragraphs exist)
      const introContent = scenario.introduction || scenario.paragraphs;
      if (introContent && introContent.length > 0) {
        contentSections.push(`
          <div class="worksheet-section introduction-section" style="background: #1a1a1a !important; border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);">
            <h2 class="section-header" style="color: #2196F3; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-info-circle"></i> Introduction
            </h2>
            <div class="worksheet-content">
              ${introContent.map(p => `<p style="color: #FFFFFF; margin-bottom: 15px;">${p}</p>`).join('')}
            </div>
          </div>
        `);
      }
      
      // System Diagram section (only if image exists)
      if (scenario.image) {
        contentSections.push(`
          <div class="worksheet-section diagram-section" style="background: #1a1a1a !important; border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FF9800; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.2);">
            <h2 class="section-header" style="color: #FF9800; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-image"></i> System Diagram
            </h2>
            <div class="worksheet-content" style="text-align: center;">
              <img src="assets/${type === 'fault' ? 'scenarios' : 'maintenance'}/${scenario.image}" 
                   alt="${scenario.title}" class="scenario-image" style="max-width: 100%; height: auto; border-radius: 8px;">
            </div>
          </div>
        `);
      }
      
      // Steps section (only if steps exist)
      if (scenario.steps && scenario.steps.length > 0) {
        contentSections.push(`
          <div class="worksheet-section steps-section" style="background: #1a1a1a !important; border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);">
            <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-list-ol"></i> Steps to Complete
            </h2>
            <div class="worksheet-content">
              ${scenario.steps.map((step, index) => `
                <div class="step-card" data-step="${index + 1}" style="background: #333 !important; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">${index + 1}</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">${step.title || `Step ${index + 1}`}</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">${step.description || step}</p>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `);
      }
      
      // Educational content section (only if soWhat exists)
      if (scenario.soWhat && (scenario.soWhat.content || scenario.soWhat.keyPoints)) {
        contentSections.push(`
          <div class="worksheet-section educational-section" style="background: #1a1a1a !important; border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);">
            <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-lightbulb"></i> So What?
            </h2>
            <div class="worksheet-content">
              ${scenario.soWhat.content ? `<p style="color: #FFFFFF; margin-bottom: 20px;">${scenario.soWhat.content}</p>` : ''}
              ${scenario.soWhat.keyPoints ? scenario.soWhat.keyPoints.map(point => `
                <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333 !important; border-radius: 8px;">
                  <i class="fas fa-lightbulb" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                  <div>
                    <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">${point.title}</strong>
                    <p style="color: #FFFFFF; margin: 0;">${point.description}</p>
                  </div>
                </div>
              `).join('') : ''}
            </div>
          </div>
        `);
      }
      
      // Questions section (only if questions exist)
      if (scenario.questions && scenario.questions.length > 0) {
        contentSections.push(`
          <div class="worksheet-section questions-section" style="background: #1a1a1a !important; border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #4CAF50; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.2);">
            <h2 class="section-header" style="color: #4CAF50; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-question-circle"></i> Questions
            </h2>
            <div class="worksheet-content">
              ${scenario.questions.map((q, index) => `
                <div class="question-item" data-question="${index + 1}" style="background: #333 !important; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                  <h4 style="color: #FFFFFF; margin-bottom: 10px;">${index + 1}. ${q.text}</h4>
                  <textarea class="answer-input" data-question="${index + 1}" 
                           placeholder="${q.placeholder || 'Enter your answer here...'}" 
                           style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222 !important; color: #FFFFFF; resize: vertical;"></textarea>
                  <div class="question-actions" style="margin-top: 15px;">
                    <button class="submit-question-btn" onclick="submitAnswer(${index + 1})" 
                            style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                      Submit Answer
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `);
      }
      
      // Simulation section (only if simulation exists)
      if (scenario.simulation) {
        contentSections.push(`
          <div class="worksheet-section simulation-section" style="background: #1a1a1a !important; border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.2);">
            <h2 class="section-header" style="color: #E91E63; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-chart-line"></i> ${scenario.simulation.title || 'Interactive Simulation'}
            </h2>
            <div class="worksheet-content">
              <p style="color: #FFFFFF; margin-bottom: 20px;">${scenario.simulation.description || 'Interactive simulation content will be loaded here.'}</p>
                       <div id="simulation-container" style="background: #333 !important; padding: 20px; border-radius: 8px;">
           ${(() => {
             const urlParams = new URLSearchParams(window.location.search);
             const isMaintenanceMode = urlParams.get('type') === 'maintenance';
             
             if (isMaintenanceMode) {
               return `
                 <!-- Maintenance Training Panels -->
                 <div id="maintenance-dashboard-panel"></div>
                 <div id="scenario-selector-panel"></div>
                 <div id="scenario-interface-panel"></div>
                 <div id="troubleshooting-panel"></div>
                 <div id="safety-procedures-panel"></div>
                 <div id="maintenance-records-panel"></div>
                 <div id="assessment-panel"></div>
               `;
             } else {
               // Original simulation panels
               if (scenario.id === 4) {
                 return `
                   <!-- PLC I/O Simulation Panels -->
                   <div id="plc-io-panel"></div>
                   <div id="plc-control-panel"></div>
                   <div id="ladder-logic-panel"></div>
                   <div id="plc-fault-panel"></div>
                 `;
               } else if (scenario.id === 5) {
                 return `
                   <!-- HMI Simulation Panels -->
                   <div id="hmi-display-panel"></div>
                   <div id="hmi-alarm-panel"></div>
                   <div id="hmi-config-panel"></div>
                 `;
               } else if (scenario.id === 6) {
                 return `
                   <!-- Pump Simulation Panels -->
                   <div id="pump-display-panel"></div>
                   <div id="pump-control-panel"></div>
                   <div id="pump-protection-panel"></div>
                   <div id="pump-fault-panel"></div>
                 `;
               } else if (scenario.id === 7) {
                 return `
                   <!-- Valve Simulation Panels -->
                   <div id="valve-display-panel"></div>
                   <div id="valve-control-panel"></div>
                   <div id="valve-calibration-panel"></div>
                   <div id="valve-fault-panel"></div>
                 `;
               } else if (scenario.id === 8) {
                 return `
                   <!-- Float Switch Simulation Panels -->
                   <div id="float-tank-panel"></div>
                   <div id="float-control-panel"></div>
                   <div id="float-logic-panel"></div>
                   <div id="float-fault-panel"></div>
                 `;
               } else {
                 return `
                   <p style="color: #FFFFFF; text-align: center;">Simulation functionality available for enhanced worksheets.</p>
                 `;
               }
             }
           })()}
         </div>
            </div>
          </div>
        `);
      }
      
      // Combine all sections
      container.innerHTML = contentSections.join('');
      
      // Initialize interactive features if steps exist
      if (scenario.steps && scenario.steps.length > 0) {
        initializeStepTracking();
      }
      
      // Load saved answers
      setTimeout(loadSavedAnswers, 100);
      
      // Show the content
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
    }
    
    // Initialize step tracking for regular worksheets
    function initializeStepTracking() {
      const stepCards = document.querySelectorAll('.step-card');
      stepCards.forEach(card => {
        const checkbox = card.querySelector('.step-complete-checkbox');
        const stepNumber = card.dataset.step;
        
        if (!checkbox) return;
        
        // Load saved state
        const worksheetId = getUrlParameter('id');
        const type = getUrlParameter('type') || 'maintenance';
        const savedState = localStorage.getItem(`${type}_worksheet_${worksheetId}_step${stepNumber}_complete`);
        
        if (savedState === 'true') {
          checkbox.checked = true;
          card.style.opacity = '0.7';
        }

        // Function to toggle step completion
        const toggleStep = (e) => {
          // Don't toggle if clicking the checkbox itself
          if (e.target.type === 'checkbox') return;
          
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          
          localStorage.setItem(`${type}_worksheet_${worksheetId}_step${stepNumber}_complete`, checkbox.checked);
        };

        card.addEventListener('click', toggleStep);
        
        // Also handle checkbox changes
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          localStorage.setItem(`${type}_worksheet_${worksheetId}_step${stepNumber}_complete`, e.target.checked);
        });
      });
    }

    // Submit answer function for regular worksheets
    function submitAnswer(questionNum) {
      const textarea = document.querySelector(`textarea[data-question="${questionNum}"]`);
      const button = document.querySelector(`button[onclick="submitAnswer(${questionNum})"]`);
      const questionItem = document.querySelector(`.question-item[data-question="${questionNum}"]`);
      
      if (textarea && button && questionItem) {
        const userAnswer = textarea.value.trim();
        
        if (userAnswer === '') {
          showInlineNotification('Please provide an answer before submitting.', 'error');
          return;
        }
        
        // Disable textarea and button
        textarea.disabled = true;
        button.textContent = 'Submitted';
        button.disabled = true;
        button.style.backgroundColor = '#4CAF50';
        button.style.cursor = 'not-allowed';
        
        // Get correct answer for this worksheet and question
        const worksheetId = getUrlParameter('id');
        const type = getUrlParameter('type') || 'maintenance';
        const correctAnswer = getCorrectAnswer(worksheetId, questionNum);
        
        // Show answer comparison
        const comparisonDiv = questionItem.querySelector('.answer-comparison');
        if (comparisonDiv) {
          comparisonDiv.innerHTML = `
            <div style="margin-bottom: 15px;">
              <strong style="color: #4CAF50; display: block; margin-bottom: 8px;">You answered:</strong>
              <p style="color: #FFFFFF; margin: 0; padding: 10px; background: #333; border-radius: 4px;">${escapeHtml(userAnswer)}</p>
            </div>
            <div>
              <strong style="color: #4CAF50; display: block; margin-bottom: 8px;">Correct Answer:</strong>
              <p style="color: #FFFFFF; margin: 0; padding: 10px; background: #333; border-radius: 4px;">${escapeHtml(correctAnswer)}</p>
            </div>
          `;
          comparisonDiv.classList.remove('hidden');
        }
        
        // Save answer with timestamp
        const key = `${type}_worksheet_${worksheetId}_answer_${questionNum}`;
        const timestampKey = `${key}_timestamp`;
        localStorage.setItem(key, userAnswer);
        localStorage.setItem(timestampKey, new Date().toISOString());
        
        console.log('Answer submitted for question', questionNum, ':', userAnswer);
      }
    }

    // Add CSS for multiple choice styling
    const style = document.createElement('style');
    style.textContent = `
      .option-label:hover {
        border-color: var(--accent-color, #4a9eff) !important;
        background: #333 !important;
      }
      .option-label input[type="radio"]:checked + span {
        color: var(--accent-color, #4a9eff) !important;
      }
      .option-label input[type="radio"]:checked {
        accent-color: var(--accent-color, #4a9eff);
      }
    `;
    document.head.appendChild(style);

    // Submit multiple choice answer function
    function submitMultipleChoiceAnswer(questionNum) {
      const selectedOption = document.querySelector(`input[name="question-${questionNum}"]:checked`);
      const button = document.querySelector(`button[onclick="submitMultipleChoiceAnswer(${questionNum})"]`);
      const questionItem = document.querySelector(`.question-item[data-question="${questionNum}"]`);
      
      if (!selectedOption) {
        showInlineNotification('Please select an answer before submitting.', 'error');
        return;
      }
      
      if (button && questionItem) {
        const selectedIndex = parseInt(selectedOption.value);
        const selectedText = selectedOption.parentElement.querySelector('span').textContent;
        
        // Disable all radio buttons and button
        const radioButtons = questionItem.querySelectorAll('input[type="radio"]');
        radioButtons.forEach(radio => radio.disabled = true);
        button.textContent = 'Submitted';
        button.disabled = true;
        button.style.backgroundColor = '#4CAF50';
        button.style.cursor = 'not-allowed';
        
        // Get correct answer for this worksheet and question
        const worksheetId = getUrlParameter('id');
        const type = getUrlParameter('type') || 'maintenance';
        const correctAnswer = getCorrectAnswer(worksheetId, questionNum);
        
        // Show answer comparison
        const comparisonDiv = questionItem.querySelector('.answer-comparison');
        if (comparisonDiv) {
          const isCorrect = selectedIndex === correctAnswer.correct_answer;
          comparisonDiv.innerHTML = `
            <div style="margin-bottom: 15px;">
              <strong style="color: ${isCorrect ? '#4CAF50' : '#f44336'}; display: block; margin-bottom: 8px;">
                ${isCorrect ? ' Correct!' : ' Incorrect'}
              </strong>
              <p style="color: #FFFFFF; margin: 0; padding: 10px; background: #333; border-radius: 4px;">${escapeHtml(selectedText)}</p>
            </div>
            <div style="margin-bottom: 15px;">
              <strong style="color: #4CAF50; display: block; margin-bottom: 8px;">Correct Answer:</strong>
              <p style="color: #FFFFFF; margin: 0; padding: 10px; background: #333; border-radius: 4px;">${escapeHtml(correctAnswer.correct_text)}</p>
            </div>
            <div>
              <strong style="color: #4CAF50; display: block; margin-bottom: 8px;">Explanation:</strong>
              <p style="color: #FFFFFF; margin: 0; padding: 10px; background: #333; border-radius: 4px;">${escapeHtml(correctAnswer.explanation)}</p>
            </div>
          `;
          comparisonDiv.classList.remove('hidden');
        }
        
        // Save answer with timestamp
        const key = `${type}_worksheet_${worksheetId}_answer_${questionNum}`;
        const timestampKey = `${key}_timestamp`;
        localStorage.setItem(key, selectedText);
        localStorage.setItem(timestampKey, new Date().toISOString());
        
        console.log('Multiple choice answer submitted for question', questionNum, ':', selectedText);
      }
    }
    
    // Get correct answer for a specific worksheet and question
    function getCorrectAnswer(worksheetId, questionNum) {
      const correctAnswers = {
        1: { // Closed-Loop Control Systems (Multiple Choice)
          1: {
            correct_answer: 1,
            correct_text: "Sensors, actuators, control elements, and safety systems",
            explanation: "A comprehensive closed-loop system inspection should include sensors (temperature, pressure, flow), actuators (valves, motors), control elements (PID controller, displays), and safety systems (alarms, emergency stops). This ensures the entire control loop is functioning properly."
          },
          2: {
            correct_answer: 1,
            correct_text: "Compare with a calibrated reference thermometer at multiple points",
            explanation: "Proper sensor verification requires comparing the sensor reading with a calibrated reference thermometer at multiple temperature points across the sensor's operating range. This ensures accuracy throughout the entire measurement range."
          },
          3: {
            correct_answer: 1,
            correct_text: "Maintenance logs, calibration certificates, test results, and any adjustments made",
            explanation: "Complete documentation should include maintenance logs with all readings, calibration certificates for reference instruments, test results showing before/after values, and detailed records of any adjustments made. This provides a complete audit trail for quality assurance and troubleshooting."
          }
        },
        2: { // Emergency Stop Systems
          1: "Check each E-stop button for physical damage, proper mounting, and clear labeling. Ensure the button is not stuck or damaged and is easily accessible.",
          2: "Use a multimeter to verify the E-stop contacts open properly when activated and close when reset. Test during a planned shutdown to avoid disrupting production.",
          3: "E-stop system maintenance requires documentation of all tests performed, any defects found, corrective actions taken, and verification that the system meets safety standards like ISO 13850."
        },
        3: { // Status LED Indicators
          1: "Test LED operation by changing system conditions or using test functions if available. Verify each LED illuminates properly and corresponds to the correct system state.",
          2: "If an LED is lit but showing incorrect status, check the signal source, verify wiring connections, and confirm the LED is receiving the correct input signal from the control system.",
          3: "LED indicators should be checked daily during routine inspections and tested monthly during preventive maintenance to ensure they provide accurate status information when needed."
        },
        4: { // PLC Maintenance
          1: "Check the PLC cabinet for proper ventilation, clean filters, secure mounting, verify input voltage is within specifications, and inspect for signs of overheating or corrosion.",
          2: "Connect to the PLC with programming software, compare the current program with the master backup, verify all program blocks are present, and check the program creation/modification dates.",
          3: "Monitor cabinet temperature, humidity levels, ensure proper ventilation and air filtration, check for dust accumulation, and verify the cabinet is properly sealed against environmental contaminants."
        },
        5: { // HMI System
          1: "Use the built-in calibration utility or press specific screen areas to test touch accuracy. Verify the system responds to touches at the correct locations without drift or offset.",
          2: "Check for software updates, verify communication with the PLC, test alarm acknowledgment functions, and ensure all screens load properly without errors or missing graphics.",
          3: "Navigate through all available screens systematically, test all buttons and input fields, verify data entry functions work correctly, and confirm all process graphics display properly."
        },
        6: { // Pump Maintenance
          1: "Record flow rate, discharge pressure, suction pressure, motor current, vibration levels, and operating temperature. Compare these values to baseline measurements and manufacturer specifications.",
          2: "Listen for irregular noise patterns, use vibration analysis equipment to detect bearing frequencies, check for excessive noise that indicates cavitation or air entrainment.",
          3: "Replace wear rings, impeller inspection and balancing, bearing lubrication and replacement, alignment checks, seal replacement, and motor maintenance according to the maintenance schedule."
        },
        7: { // Control Valve Maintenance
          1: "Command the valve to various positions using the control system and verify the actual position feedback matches the commanded position within acceptable tolerance limits.",
          2: "Time the valve stroke from fully open to fully closed and compare to manufacturer specifications. Typical control valves should respond within 15-60 seconds depending on size and application.",
          3: "Visual inspection for external leakage at packing glands, actuator connections, and body joints. Test for internal leakage by checking if the valve can maintain shutoff when required."
        },
        8: { // Float Switch
          1: "Manually lift and lower the float through its full range of motion, checking for smooth operation without binding, sticking, or excessive resistance that could prevent proper operation.",
          2: "Use a multimeter to verify the switch contacts change state at the correct float positions and provide clean switching without intermittent operation or contact bounce.",
          3: "Clean the float and switch mechanism, check mounting hardware for tightness, inspect cables for damage, and verify the switch is positioned correctly for the required level control."
        },
        9: { // Proximity Switch
          1: "Move a target object slowly toward the sensor and measure the exact distance where switching occurs. Verify this distance matches the sensor specifications and is consistent.",
          2: "Test with different target materials (steel, aluminum, brass) to understand how material type affects sensing distance and ensure the sensor works properly with the actual application materials.",
          3: "Regular cleaning of the sensor face, protection from mechanical damage, verification of mounting security, and periodic testing to ensure consistent operation and proper sensing distance."
        },
        10: { // Flow Sensor
          1: "Use a calibrated reference flow meter or time a known volume to verify sensor accuracy. Check calibration at multiple flow rates across the sensor's operating range.",
          2: "Verify proper installation with adequate straight pipe runs upstream and downstream, correct orientation, and proper grounding. Check for pipe stress or misalignment affecting the sensor.",
          3: "Regular cleaning of sensor elements, verification of electrical connections, checking for pipe deposits or scaling that could affect accuracy, and periodic calibration verification."
        },
        11: { // Temperature Sensor
          1: "Use a calibrated reference thermometer to compare readings at known temperature points. Check accuracy across the sensor's operating range, typically at 25%, 50%, and 75% of span.",
          2: "Subject the sensor to a rapid temperature change and measure how quickly it reaches 63% of the final value. Compare response time to manufacturer specifications.",
          3: "Regular inspection of sensor housing and connections, verification of proper installation depth and thermal contact, checking signal conditioning equipment, and periodic calibration verification."
        },
        12: { // Digital Sensors
          1: "Activate each sensor and verify clean switching between on and off states using a multimeter or oscilloscope to check for proper voltage levels and clean transitions.",
          2: "Use an oscilloscope to verify digital signals are clean without noise, contact bounce, or intermittent switching that could cause false signals to the control system.",
          3: "Regular cleaning of sensor faces, checking mounting security, verifying proper voltage levels, testing response time, and ensuring proper grounding and shielding of signal cables."
        },
        13: { // Analogue Sensors
          1: "Use calibrated reference standards to verify sensor accuracy at multiple points across the measurement range, typically 0%, 25%, 50%, 75%, and 100% of span.",
          2: "Check amplifiers, signal conditioners, and analog-to-digital converters for proper operation, correct gain settings, and freedom from drift or offset errors.",
          3: "Regular inspection of sensor elements, verification of signal conditioning circuits, checking for electrical noise or interference, and periodic calibration using traceable standards."
        },
        14: { // Faults
          1: "Common faults include sensor failures, actuator malfunctions, communication errors, power supply problems, software errors, and environmental issues like overheating or contamination.",
          2: "Use a systematic approach: gather information about symptoms, analyze possible causes, test theories starting with the most likely, and verify the solution addresses the root cause.",
          3: "Regular calibration of instruments, proper environmental controls, scheduled replacement of wear items, trending of performance data, and maintaining spare parts inventory."
        }
      };
      
      return correctAnswers[worksheetId]?.[questionNum] || "This is a maintenance-related question that requires understanding of industrial systems and proper maintenance procedures.";
    }
    
    // Helper function to escape HTML characters
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Load saved answers when page loads
    function loadSavedAnswers() {
      const worksheetId = getUrlParameter('id');
      const type = getUrlParameter('type') || 'maintenance';
      
      // Find all question textareas
      const textareas = document.querySelectorAll('textarea[data-question]');
      textareas.forEach(textarea => {
        const questionNum = textarea.dataset.question;
        const key = `${type}_worksheet_${worksheetId}_answer_${questionNum}`;
        const savedAnswer = localStorage.getItem(key);
        
        if (savedAnswer) {
          textarea.value = savedAnswer;
          textarea.disabled = true;
          
          // Also disable the corresponding button
          const button = document.querySelector(`button[onclick="submitAnswer(${questionNum})"]`);
          if (button) {
            button.textContent = 'Submitted';
            button.disabled = true;
            button.style.backgroundColor = '#4CAF50';
            button.style.cursor = 'not-allowed';
          }
          
          // Show the answer comparison
          const questionItem = document.querySelector(`.question-item[data-question="${questionNum}"]`);
          const comparisonDiv = questionItem?.querySelector('.answer-comparison');
          if (comparisonDiv) {
            const correctAnswer = getCorrectAnswer(worksheetId, parseInt(questionNum));
            comparisonDiv.innerHTML = `
              <div style="margin-bottom: 15px;">
                <strong style="color: #4CAF50; display: block; margin-bottom: 8px;">You answered:</strong>
                <p style="color: #FFFFFF; margin: 0; padding: 10px; background: #333; border-radius: 4px;">${escapeHtml(savedAnswer)}</p>
              </div>
              <div>
                <strong style="color: #4CAF50; display: block; margin-bottom: 8px;">Correct Answer:</strong>
                <p style="color: #FFFFFF; margin: 0; padding: 10px; background: #333; border-radius: 4px;">${escapeHtml(correctAnswer)}</p>
              </div>
            `;
            comparisonDiv.classList.remove('hidden');
          }
        }
      });
    }

    // Show error message
    function showError(message) {
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('error-container').style.display = 'block';
      const errorText = document.querySelector('#error-container p');
      if (errorText) {
        errorText.textContent = message;
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Small delay to allow URL parameters to be set by main process
      setTimeout(() => {
        loadWorksheet();
        updateBackButtons();
        initializeResponseTestEventListeners();
      }, 100);
    });

    // Initialize basic Worksheet 1 features for fallback
    function initializeBasicWorksheet1Features() {
      // Initialize step completion functionality
      const stepCards = document.querySelectorAll('.step-card');
      stepCards.forEach(card => {
        const checkbox = card.querySelector('.step-complete-checkbox');
        const stepNumber = card.dataset.step;
        
        // Load saved state
        const savedState = localStorage.getItem(`worksheet1_step${stepNumber}_complete`);
        if (savedState === 'true') {
          checkbox.checked = true;
          card.style.opacity = '0.7';
        }

        // Function to toggle step completion
        const toggleStep = (e) => {
          // Don't toggle if clicking the checkbox itself
          if (e.target.type === 'checkbox') return;
          
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, checkbox.checked);
        };

        card.addEventListener('click', toggleStep);
        
        // Also handle checkbox changes
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, e.target.checked);
        });
      });
    }

    // Submit answer function for Worksheet 1 questions
    window.submitWorksheet1Question = function(questionNum) {
      const textarea = document.querySelector(`textarea[data-question="${questionNum}"]`);
      const button = document.querySelector(`button[onclick="submitWorksheet1Question(${questionNum})"]`);
      const correctAnswerDiv = document.querySelector(`.question-item[data-question="${questionNum}"] .correct-answer`);
      
      if (textarea && button && correctAnswerDiv) {
        const userAnswer = textarea.value.trim();
        
        if (userAnswer === '') {
          showInlineNotification('Please provide an answer before submitting.', 'error');
          return;
        }
        
        // Disable textarea and button
        textarea.disabled = true;
        button.textContent = 'Submitted';
        button.disabled = true;
        button.style.backgroundColor = '#4CAF50';
        
        // Show correct answer
        correctAnswerDiv.style.display = 'block';
        
        // Save answer
        const key = `worksheet1_answer_${questionNum}`;
        localStorage.setItem(key, userAnswer);
        
        console.log('Question', questionNum, 'submitted:', userAnswer);
      }
    };

    // Navigation function for worksheet buttons
    function navigateWorksheet(direction) {
      const currentId = parseInt(getUrlParameter('id'));
      const currentType = getUrlParameter('type') || 'maintenance';
      
      let nextId;
      if (direction === 'next') {
        nextId = currentType === 'maintenance' ? Math.min(currentId + 1, 14) : Math.min(currentId + 1, 8);
      } else if (direction === 'prev') {
        nextId = Math.max(currentId - 1, 1);
      }
      
      if (nextId && nextId !== currentId) {
        window.location.href = `worksheet.html?id=${nextId}&type=${currentType}`;
      }
    }

    // Update navigation button states
    function updateNavigationButtons() {
      const currentId = parseInt(getUrlParameter('id'));
      const currentType = getUrlParameter('type') || 'maintenance';
      const maxId = currentType === 'maintenance' ? 14 : 8;
      
      const prevBtn = document.querySelector('.prev-btn');
      const nextBtn = document.querySelector('.next-btn');
      
      if (prevBtn) {
        prevBtn.disabled = currentId <= 1;
      }
      
      if (nextBtn) {
        nextBtn.disabled = currentId >= maxId;
      }
    }

    // Initialize interactive features for the enhanced worksheet
    function initializeInteractiveFeatures() {
      // Initialize step completion functionality
      const stepCards = document.querySelectorAll('.step-card');
      stepCards.forEach(card => {
        const checkbox = card.querySelector('.step-complete-checkbox');
        const stepNumber = card.dataset.step;
        
        // Load saved state
        const savedState = localStorage.getItem(`worksheet1_step${stepNumber}_complete`);
        if (savedState === 'true') {
          checkbox.checked = true;
          card.style.opacity = '0.7';
        }

        // Function to toggle step completion
        const toggleStep = (e) => {
          // Don't toggle if clicking the checkbox itself
          if (e.target.type === 'checkbox') return;
          
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, checkbox.checked);
        };

        card.addEventListener('click', toggleStep);
        
        // Also handle checkbox changes
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, e.target.checked);
        });
      });

      // Initialize Q&A functionality
      const submitBtns = document.querySelectorAll('.submit-question-btn');
      submitBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const questionNum = this.getAttribute('onclick').match(/\d+/)[0];
          submitInteractiveQuestion(parseInt(questionNum));
        });
      });
      
      // Load saved answers for Worksheet 1
      for (let i = 1; i <= 5; i++) {
        const savedAnswer = localStorage.getItem(`worksheet1_interactive_answer_${i}`);
        if (savedAnswer) {
          const textarea = document.querySelector(`textarea[data-question="${i}"]`);
          const button = document.querySelector(`button[onclick*="${i}"]`);
          const questionItem = document.querySelector(`.question-item[data-question="${i}"]`);
          
          if (textarea && button && questionItem) {
            textarea.value = savedAnswer;
            textarea.disabled = true;
            button.textContent = 'Submitted';
            button.disabled = true;
            button.style.backgroundColor = '#4CAF50';
            
            // Show the comparison
            const comparison = questionItem.querySelector('.individual-comparison');
            if (comparison) {
              const correctAnswer = getWorksheet1CorrectAnswer(i);
              comparison.innerHTML = `
                <div style="background: #1a2f1a; padding: 15px; border-radius: 4px; margin-top: 15px; border-left: 3px solid #4CAF50;">
                  <div style="margin-bottom: 15px;">
                    <strong style="color: #4CAF50; display: block; margin-bottom: 8px;">You answered:</strong>
                    <p style="color: #FFFFFF; margin: 0; padding: 10px; background: #333; border-radius: 4px;">${escapeHtml(savedAnswer)}</p>
                  </div>
                  <div>
                    <strong style="color: #4CAF50; display: block; margin-bottom: 8px;">Correct Answer:</strong>
                    <p style="color: #FFFFFF; margin: 0; padding: 10px; background: #333; border-radius: 4px;">${escapeHtml(correctAnswer)}</p>
                  </div>
                </div>
              `;
              comparison.classList.remove('hidden');
            }
          }
        }
      }

      // Tab system removed - sections are now displayed vertically
    }

    // Initialize PID simulation functionality
    function initEnhancedPIDSimulation() {
      console.log('Initializing PID simulation...');
      
      // Tab switching removed - sections are now displayed vertically
      
      // Initialize sliders and controls
      const setpointSlider = document.getElementById('setpoint-slider');
      const setpointValue = document.getElementById('setpoint-value');
      if (setpointSlider && setpointValue) {
        setpointSlider.addEventListener('input', function() {
          simulationData.setpoint = parseFloat(this.value);
          setpointValue.textContent = this.value + '.0C';
          updatePIDSimulation();
        });
      }
      
      const kpSlider = document.getElementById('kp-slider');
      const kpValue = document.getElementById('kp-value');
      if (kpSlider && kpValue) {
        kpSlider.addEventListener('input', function() {
          simulationData.kp = parseFloat(this.value);
          kpValue.textContent = this.value;
          updatePIDSimulation();
        });
      }
      
      const kiSlider = document.getElementById('ki-slider');
      const kiValue = document.getElementById('ki-value');
      if (kiSlider && kiValue) {
        kiSlider.addEventListener('input', function() {
          simulationData.ki = parseFloat(this.value);
          kiValue.textContent = this.value;
          updatePIDSimulation();
        });
      }
      
      const kdSlider = document.getElementById('kd-slider');
      const kdValue = document.getElementById('kd-value');
      if (kdSlider && kdValue) {
        kdSlider.addEventListener('input', function() {
          simulationData.kd = parseFloat(this.value);
          kdValue.textContent = this.value;
          updatePIDSimulation();
        });
      }
      
      // Initialize response-specific PID controls
      const responseKpSlider = document.getElementById('response-kp-slider');
      const responseKpValue = document.getElementById('response-kp-value');
      if (responseKpSlider && responseKpValue) {
        responseKpSlider.addEventListener('input', function() {
          simulationData.responseKp = parseFloat(this.value);
          responseKpValue.textContent = this.value;
          // PID values will be read dynamically in the continuous simulation
          console.log('PID Kp changed to:', this.value);
        });
      }
      
      const responseKiSlider = document.getElementById('response-ki-slider');
      const responseKiValue = document.getElementById('response-ki-value');
      if (responseKiSlider && responseKiValue) {
        responseKiSlider.addEventListener('input', function() {
          simulationData.responseKi = parseFloat(this.value);
          responseKiValue.textContent = this.value;
          // PID values will be read dynamically in the continuous simulation
          console.log('PID Ki changed to:', this.value);
        });
      }
      
      const responseKdSlider = document.getElementById('response-kd-slider');
      const responseKdValue = document.getElementById('response-kd-value');
      if (responseKdSlider && responseKdValue) {
        responseKdSlider.addEventListener('input', function() {
          simulationData.responseKd = parseFloat(this.value);
          responseKdValue.textContent = this.value;
          // PID values will be read dynamically in the continuous simulation
          console.log('PID Kd changed to:', this.value);
        });
      }
      
      // Initialize input type radio buttons
      const inputTypeRadios = document.querySelectorAll('input[name="input-type"]');
      inputTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          console.log('Input type changed to:', this.value);
          // Restart the simulation with new input type if it's running
          if (simulationData.responseAnimationInterval) {
            console.log('Restarting simulation with new input type');
            runResponseTest();
          }
        });
      });
      
      // Initialize response test buttons
      const startResponseBtn = document.getElementById('start-response');
      const stopResponseBtn = document.getElementById('stop-response');
      const resetResponseBtn = document.getElementById('reset-response');
      
      if (startResponseBtn) {
        startResponseBtn.addEventListener('click', function() {
          runResponseTest();
        });
      }
      
      if (stopResponseBtn) {
        stopResponseBtn.addEventListener('click', function() {
          if (simulationData.responseAnimationInterval) {
            clearInterval(simulationData.responseAnimationInterval);
            simulationData.responseAnimationInterval = null;
            console.log('Stopped continuous response simulation');
          }
        });
      }
      
      if (resetResponseBtn) {
        resetResponseBtn.addEventListener('click', function() {
          console.log('Reset button clicked');
          
          // Stop current simulation completely
          if (simulationData && simulationData.responseAnimationInterval) {
            clearInterval(simulationData.responseAnimationInterval);
            simulationData.responseAnimationInterval = null;
            console.log('Stopped simulation for reset');
          }
          
          // Reset ALL simulation data
          if (simulationData) {
            simulationData.responseData = null;
            simulationData.responseTime = 0;
            simulationData.responseValue = 25;
            simulationData.integral = 0;
            simulationData.lastError = 0;
            simulationData.time = 0;
          }
          
          // Destroy Chart.js charts if they exist
          if (responseChart) {
            responseChart.destroy();
            responseChart = null;
            console.log('Destroyed response chart for reset');
          }
          if (pidTuningChart) {
            pidTuningChart.destroy();
            pidTuningChart = null;
            console.log('Destroyed PID tuning chart for reset');
          }
          
          // Reset PID sliders to default values
          const kpSlider = document.getElementById('response-kp-slider');
          const kiSlider = document.getElementById('response-ki-slider');
          const kdSlider = document.getElementById('response-kd-slider');
          const kpValue = document.getElementById('response-kp-value');
          const kiValue = document.getElementById('response-ki-value');
          const kdValue = document.getElementById('response-kd-value');
          
          if (kpSlider && kpValue) {
            kpSlider.value = 0.5;
            kpValue.textContent = '0.5';
            simulationData.responseKp = 0.5;
          }
          if (kiSlider && kiValue) {
            kiSlider.value = 0.1;
            kiValue.textContent = '0.1';
            simulationData.responseKi = 0.1;
          }
          if (kdSlider && kdValue) {
            kdSlider.value = 0.2;
            kdValue.textContent = '0.2';
            simulationData.responseKd = 0.2;
          }
          
          // Reset metrics
          const metrics = ['response-rise-time', 'response-overshoot', 'response-settling-time', 'response-steady-error'];
          metrics.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = '--';
          });
          
          console.log('Reset complete');
        });
      }
      
      // Initialize challenge buttons
      const challengeButtons = document.querySelectorAll('.check-challenge-btn');
      challengeButtons.forEach(button => {
        button.addEventListener('click', function() {
          const challengeId = this.getAttribute('data-challenge');
          startChallenge(challengeId);
        });
      });
      
      // Initialize reset button
      const resetPidBtn = document.getElementById('reset-pid');
      if (resetPidBtn) {
        resetPidBtn.addEventListener('click', function() {
          resetPIDToDefaults();
        });
      }
      
      // Initialize simulation
      updatePIDSimulation();
      
      // Start real-time simulation
      startRealTimeSimulation();
      
      console.log('PID simulation initialized');
      
      // Add debugging function to window for testing
      window.debugPIDValues = function() {
        const kp = (simulationData && simulationData.responseKp) || parseFloat(document.getElementById('response-kp-slider')?.value) || 0.5;
        const ki = (simulationData && simulationData.responseKi) || parseFloat(document.getElementById('response-ki-slider')?.value) || 0.1;
        const kd = (simulationData && simulationData.responseKd) || parseFloat(document.getElementById('response-kd-slider')?.value) || 0.2;
        console.log('Current PID values - Kp:', kp, 'Ki:', ki, 'Kd:', kd);
        return { kp, ki, kd };
      };
      
      // Add test function to generate and display sample data
      window.testResponseData = function() {
        const data = generateResponseData('step', 25, 15, 0.5);
        console.log('Test response data:', {
          input: data.input.slice(0, 5),
          response: data.response.slice(0, 5),
          error: data.error.slice(0, 5)
        });
        return data;
      };
      
      // Initialize enhanced industrial maintenance features
      initializeIndustrialMaintenanceFeatures();
    }
    
    // Enhanced Industrial Maintenance Features
    function initializeIndustrialMaintenanceFeatures() {
      console.log('Initializing industrial maintenance features...');
      
      // Initialize maintenance mode selection
      const maintenanceModeRadios = document.querySelectorAll('input[name="maintenance-mode"]');
      maintenanceModeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          console.log('Maintenance mode changed to:', this.value);
          updateMaintenanceMode(this.value);
        });
      });
      
      // Initialize disturbance controls
      initializeDisturbanceControls();
      
      // Initialize flow loop controls
      initializeFlowLoopControls();
      
      // Initialize maintenance scenarios
      initializeMaintenanceScenarios();
      
      // Initialize enhanced performance metrics
      initializeEnhancedMetrics();
      
      console.log('Industrial maintenance features initialized');
    }
    
    // Initialize disturbance injection controls
    function initializeDisturbanceControls() {
      const valveBlockage = document.getElementById('valve-blockage');
      const valveBlockageValue = document.getElementById('valve-blockage-value');
      const pumpWear = document.getElementById('pump-wear');
      const pumpWearValue = document.getElementById('pump-wear-value');
      const sensorDrift = document.getElementById('sensor-drift');
      const sensorDriftValue = document.getElementById('sensor-drift-value');
      
      if (valveBlockage && valveBlockageValue) {
        valveBlockage.addEventListener('input', function() {
          const value = parseFloat(this.value);
          valveBlockageValue.textContent = value + '%';
          simulationData.valveBlockage = value / 100;
          updateDisturbanceEffects();
        });
      }
      
      if (pumpWear && pumpWearValue) {
        pumpWear.addEventListener('input', function() {
          const value = parseFloat(this.value);
          pumpWearValue.textContent = value + '%';
          simulationData.pumpWear = value / 100;
          updateDisturbanceEffects();
        });
      }
      
      if (sensorDrift && sensorDriftValue) {
        sensorDrift.addEventListener('input', function() {
          const value = parseFloat(this.value);
          sensorDriftValue.textContent = value + 'C';
          simulationData.sensorDrift = value;
          updateDisturbanceEffects();
        });
      }
      
      // Initialize disturbance buttons
      const injectDisturbanceBtn = document.getElementById('inject-disturbance');
      const clearDisturbanceBtn = document.getElementById('clear-disturbance');
      
      if (injectDisturbanceBtn) {
        injectDisturbanceBtn.addEventListener('click', function() {
          injectDisturbance();
        });
      }
      
      if (clearDisturbanceBtn) {
        clearDisturbanceBtn.addEventListener('click', function() {
          clearDisturbances();
        });
      }
    }
    
    // Initialize flow loop controls
    function initializeFlowLoopControls() {
      const flowSetpoint = document.getElementById('flow-setpoint');
      const flowSetpointValue = document.getElementById('flow-setpoint-value');
      
      if (flowSetpoint && flowSetpointValue) {
        flowSetpoint.addEventListener('input', function() {
          const value = parseFloat(this.value);
          flowSetpointValue.textContent = value + ' L/min';
          simulationData.flowSetpoint = value;
          updateFlowLoopSimulation();
        });
      }
      
      // Start flow loop simulation
      startFlowLoopSimulation();
    }
    
    // Initialize maintenance scenarios
    function initializeMaintenanceScenarios() {
      const scenarioButtons = document.querySelectorAll('.scenario-button');
      scenarioButtons.forEach(button => {
        button.addEventListener('click', function() {
          const scenario = this.getAttribute('data-scenario');
          startMaintenanceScenario(scenario);
        });
      });
    }
    
    // Initialize enhanced performance metrics
    function initializeEnhancedMetrics() {
      // Update metrics every second
      setInterval(() => {
        updateEnhancedMetrics();
      }, 1000);
    }

    // Enhanced PID Simulation Variables with Industrial Maintenance Features
    let simulationData = {
      setpoint: 50,
      processVariable: 25,
      kp: 0.5,
      ki: 0.1,
      kd: 0.2,
      time: 0,
      error: 0,
      integral: 0,
      derivative: 0,
      output: 0,
      lastError: 0,
      simulationInterval: null,
      graphData: {
        setpoint: [],
        processVariable: [],
        controlOutput: [],
        time: []
      },
      maxDataPoints: 200,
      
      // Industrial Maintenance Features
      maintenanceMode: 'normal',
      valveBlockage: 0,
      pumpWear: 0,
      sensorDrift: 0,
      flowSetpoint: 50,
      actualFlow: 48.5,
      pumpSpeed: 75,
      valvePosition: 60,
      pressureDrop: 2.3,
      systemEfficiency: 94,
      systemHealth: 'Excellent',
      maintenanceDue: 30,
      
      // Performance metrics
      riseTime: 0,
      overshoot: 0,
      settlingTime: 0,
      steadyStateError: 0,
      pidPerformance: 'Optimal',
      systemStability: 'Stable',
      responseQuality: 'Good',
      faultTolerance: 'High',
      
      // Flow loop simulation
      flowLoopInterval: null,
      flowLoopData: {
        time: [],
        setpoint: [],
        actual: [],
        pumpSpeed: [],
        valvePosition: []
      }
    };

    // Update PID simulation with current values
    function updatePIDSimulation() {
      const setpointSlider = document.getElementById('setpoint-slider');
      const kpSlider = document.getElementById('kp-slider');
      const kiSlider = document.getElementById('ki-slider');
      const kdSlider = document.getElementById('kd-slider');
      
      if (setpointSlider && kpSlider && kiSlider && kdSlider) {
        simulationData.setpoint = parseFloat(setpointSlider.value);
        simulationData.kp = parseFloat(kpSlider.value);
        simulationData.ki = parseFloat(kiSlider.value);
        simulationData.kd = parseFloat(kdSlider.value);
        
        // Calculate performance metrics
        calculatePerformanceMetrics();
      }
    }

    // Reset PID parameters to default values
    function resetPIDToDefaults() {
      // Default values
      const defaults = {
        setpoint: 50,
        kp: 0.5,
        ki: 0.1,
        kd: 0.2
      };
      
      // Reset sliders
      const setpointSlider = document.getElementById('setpoint-slider');
      const kpSlider = document.getElementById('kp-slider');
      const kiSlider = document.getElementById('ki-slider');
      const kdSlider = document.getElementById('kd-slider');
      
      if (setpointSlider) {
        setpointSlider.value = defaults.setpoint;
        document.getElementById('setpoint-value').textContent = defaults.setpoint + '.0C';
      }
      
      if (kpSlider) {
        kpSlider.value = defaults.kp;
        document.getElementById('kp-value').textContent = defaults.kp;
      }
      
      if (kiSlider) {
        kiSlider.value = defaults.ki;
        document.getElementById('ki-value').textContent = defaults.ki;
      }
      
      if (kdSlider) {
        kdSlider.value = defaults.kd;
        document.getElementById('kd-value').textContent = defaults.kd;
      }
      
      // Reset simulation data
      simulationData.setpoint = defaults.setpoint;
      simulationData.kp = defaults.kp;
      simulationData.ki = defaults.ki;
      simulationData.kd = defaults.kd;
      simulationData.integral = 0;
      simulationData.derivative = 0;
      simulationData.output = 0;
      simulationData.lastError = 0;
      
      // Clear graph data
      simulationData.graphData.setpoint = [];
      simulationData.graphData.processVariable = [];
      simulationData.graphData.controlOutput = [];
      simulationData.graphData.time = [];
      simulationData.time = 0;
      
      // Update simulation
      updatePIDSimulation();
      
      // Reinitialize graph
      initPIDTuningGraph();
      
      // Show feedback
      const resetBtn = document.getElementById('reset-pid');
      if (resetBtn) {
        const originalText = resetBtn.innerHTML;
        resetBtn.innerHTML = '<i class="fas fa-check"></i> Reset Complete!';
        resetBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
        
        setTimeout(() => {
          resetBtn.innerHTML = originalText;
          resetBtn.style.background = 'linear-gradient(135deg, #FF9800, #F57C00)';
        }, 2000);
      }
    }

    // Calculate performance metrics based on PID parameters
    function calculatePerformanceMetrics() {
      const riseTime = Math.max(0.5, 2.0 - simulationData.kp * 0.8);
      const overshoot = Math.max(0, 15 - simulationData.kp * 5 + simulationData.ki * 10);
      const settlingTime = Math.max(1.0, 5.0 - simulationData.kp * 1.5 + simulationData.ki * 2);
      
      // Update metric displays
      const riseTimeElement = document.getElementById('rise-time');
      const overshootElement = document.getElementById('overshoot');
      const settlingTimeElement = document.getElementById('settling-time');
      
      if (riseTimeElement) riseTimeElement.textContent = riseTime.toFixed(1) + 's';
      if (overshootElement) overshootElement.textContent = overshoot.toFixed(1) + '%';
      if (settlingTimeElement) settlingTimeElement.textContent = settlingTime.toFixed(1) + 's';
    }

    // Start real-time PID simulation
    function startRealTimeSimulation() {
      if (simulationData.simulationInterval) {
        clearInterval(simulationData.simulationInterval);
      }
      
      // Initialize graph
      initPIDTuningGraph();
      
      simulationData.simulationInterval = setInterval(() => {
        // Calculate PID control
        const error = simulationData.setpoint - simulationData.processVariable;
        simulationData.integral += error * 0.1; // dt = 0.1
        simulationData.derivative = (error - simulationData.lastError) / 0.1;
        
        // PID output
        simulationData.output = simulationData.kp * error + 
                               simulationData.ki * simulationData.integral + 
                               simulationData.kd * simulationData.derivative;
        
        // Clamp output to 0-100% range
        simulationData.output = Math.max(0, Math.min(100, simulationData.output));
        
        // Update process variable (simplified first-order system)
        const tau = 2.0; // time constant
        simulationData.processVariable += (simulationData.output - simulationData.processVariable) * 0.1 / tau;
        
        // Add some noise
        simulationData.processVariable += (Math.random() - 0.5) * 0.5;
        
        // Update display
        const pvValue = document.getElementById('pv-value');
        if (pvValue) {
          pvValue.textContent = simulationData.processVariable.toFixed(1) + 'C';
        }
        
        // Update control output display
        const controlOutputValue = document.getElementById('control-output-value');
        if (controlOutputValue) {
          controlOutputValue.textContent = simulationData.output.toFixed(1) + '%';
          
          // Visual indicator when output is clamped
          if (simulationData.output >= 100) {
            controlOutputValue.style.color = '#FF5722'; // Orange-red when at max
            controlOutputValue.style.fontWeight = 'bold';
          } else if (simulationData.output <= 0) {
            controlOutputValue.style.color = '#FF9800'; // Orange when at min
            controlOutputValue.style.fontWeight = 'bold';
          } else {
            controlOutputValue.style.color = '#4CAF50'; // Normal green
            controlOutputValue.style.fontWeight = 'bold';
          }
        }
        
        // Add data to graph
        addGraphData();
        
        // Draw graph
        drawPIDTuningGraph();
        
        simulationData.lastError = error;
        simulationData.time += 0.1;
      }, 100); // Update every 100ms
    }

    // Global Chart.js chart instances
    let responseChart = null;
    let pidTuningChart = null;

    // Run response test simulation with Chart.js
    function runResponseTest() {
      console.log('runResponseTest() called');
      
      const canvas = document.getElementById('response-chart');
      if (!canvas) return;
      
      // Get input type from radio buttons
      const selectedRadio = document.querySelector('input[name="input-type"]:checked');
      const inputType = selectedRadio ? selectedRadio.value : 'step';
      console.log('Starting simulation with input type:', inputType);
      
      // Use default parameters for simplified interface
      const amplitude = 25; // Default amplitude
      const duration = 15; // Default duration
      const frequency = 0.5; // Default frequency
      
      // Update PID display
      updatePIDDisplay();
      
      // Stop any existing simulation
      if (simulationData.responseAnimationInterval) {
        clearInterval(simulationData.responseAnimationInterval);
      }
      
      // Start continuous real-time simulation
      startContinuousResponseSimulation(canvas, inputType, amplitude, duration, frequency);
    }

    // Create Chart.js response chart
    function createResponseChart(canvas, inputType, amplitude, duration, frequency) {
      // Destroy existing chart if it exists
      if (responseChart) {
        responseChart.destroy();
      }
      
      // Generate data based on input type
      const data = generateResponseData(inputType, amplitude, duration, frequency);
      
      // Debug: log the data being passed to the chart
      console.log('Chart data generated:', {
        inputLength: data.input.length,
        responseLength: data.response.length,
        errorLength: data.error.length,
        sampleInput: data.input.slice(0, 3),
        sampleResponse: data.response.slice(0, 3),
        sampleError: data.error.slice(0, 3)
      });
      
      // Create new Chart.js chart
      responseChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels: data.input.map(point => point.time.toFixed(1) + 's'),
          datasets: [
            {
              label: 'Input Signal',
              data: data.input.map(point => point.value),
              borderColor: '#E91E63',
              backgroundColor: 'rgba(233, 30, 99, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1
            },
            {
              label: 'System Response',
              data: data.response.map(point => point.value),
              borderColor: '#2196F3',
              backgroundColor: 'rgba(33, 150, 243, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1
            },
            {
              label: 'Error Signal',
              data: data.error.map(point => point.value),
              borderColor: '#4CAF50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#FFFFFF',
                font: {
                  size: 12
                }
              }
            },
            title: {
              display: true,
              text: 'System Response Analysis',
              color: '#FFFFFF',
              font: {
                size: 16,
                weight: 'bold'
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Time (seconds)',
                color: '#FFFFFF'
              },
              ticks: {
                color: '#FFFFFF'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Temperature (C)',
                color: '#FFFFFF'
              },
              ticks: {
                color: '#FFFFFF'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              suggestedMin: 0,
              suggestedMax: 80
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          elements: {
            point: {
              radius: 0
            }
          }
        }
      });
    }

    // Generate response data for Chart.js
    function generateResponseData(inputType, amplitude, duration, frequency) {
      const timeSteps = 200;
      const baseTemp = 25; // Base temperature
      
      // PID simulation variables
      let integral = 0;
      let lastError = 0;
      
      // Get current PID parameters - use response-specific values if available, otherwise fall back to main values
      const kp = (simulationData && simulationData.responseKp) || (simulationData && simulationData.kp) || parseFloat(document.getElementById('response-kp-slider')?.value) || parseFloat(document.getElementById('kp-slider')?.value) || 0.5;
      const ki = (simulationData && simulationData.responseKi) || (simulationData && simulationData.ki) || parseFloat(document.getElementById('response-ki-slider')?.value) || parseFloat(document.getElementById('ki-slider')?.value) || 0.1;
      const kd = (simulationData && simulationData.responseKd) || (simulationData && simulationData.kd) || parseFloat(document.getElementById('response-kd-slider')?.value) || parseFloat(document.getElementById('kd-slider')?.value) || 0.2;
      
      console.log('Generating response data with PID values - Kp:', kp, 'Ki:', ki, 'Kd:', kd);
      
      const data = {
        input: [],
        response: [],
        error: []
      };
      
      for (let i = 0; i < timeSteps; i++) {
        const time = (i / timeSteps) * duration;
        let inputValue = baseTemp;
        let responseValue = baseTemp;
        
        // Generate input signal
        switch (inputType) {
          case 'step':
            inputValue = baseTemp + (time > duration * 0.2 ? amplitude : 0);
            break;
          case 'ramp':
            inputValue = baseTemp + (time / duration) * amplitude;
            break;
          case 'sine':
            inputValue = baseTemp + amplitude * Math.sin(2 * Math.PI * frequency * time);
            break;
        }
        
        // Generate system response (simplified PID simulation)
        const dt = duration / timeSteps;
        
        if (i > 0) {
          const prevResponse = data.response[i - 1].value;
          
          // Calculate error between input and current response
          const error = inputValue - prevResponse;
          
          // Update integral term (accumulate error over time)
          integral += error * dt;
          
          // Calculate derivative term (rate of change of error)
          const derivative = (error - lastError) / dt;
          
          // Calculate PID control output
          const controlOutput = kp * error + ki * integral + kd * derivative;
          
          // Clamp control output to reasonable range
          const clampedControlOutput = Math.max(-50, Math.min(50, controlOutput));
          
          // Update response using first-order system model
          const tau = 2.0; // time constant
          responseValue = prevResponse + clampedControlOutput * dt / tau;
          
          // Add some realistic noise
          responseValue += (Math.random() - 0.5) * 0.5;
          
          // Update last error for next iteration
          lastError = error;
        } else {
          // For the first point, start at base temperature
          responseValue = baseTemp;
        }
        
        const errorValue = inputValue - responseValue;
        
        data.input.push({ time, value: inputValue });
        data.response.push({ time, value: responseValue });
        data.error.push({ time, value: errorValue });
      }
      
      return data;
    }

    // Start continuous real-time simulation with Chart.js
    function startContinuousResponseSimulation(canvas, inputType, amplitude, duration, frequency) {
      console.log('Starting continuous response simulation');
      
      // Destroy existing chart if it exists
      if (responseChart) {
        responseChart.destroy();
      }
      
      // Initialize simulation variables
      let time = 0;
      let responseValue = 25; // Base temperature
      let integral = 0;
      let lastError = 0;
      const dt = 0.1; // Time step
      const tau = 2.0; // System time constant
      
      // Initialize data arrays for chart
      const chartData = {
        labels: [],
        input: [],
        response: [],
        error: []
      };
      
      // Create initial chart
      responseChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Input Signal',
              data: [],
              borderColor: '#E91E63',
              backgroundColor: 'rgba(233, 30, 99, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1
            },
            {
              label: 'System Response',
              data: [],
              borderColor: '#2196F3',
              backgroundColor: 'rgba(33, 150, 243, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1
            },
            {
              label: 'Error Signal',
              data: [],
              borderColor: '#4CAF50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 0 // Disable animations for real-time updates
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#FFFFFF',
                font: {
                  size: 12
                }
              }
            },
                         title: {
               display: true,
               text: `Real-time ${inputType.charAt(0).toUpperCase() + inputType.slice(1)} Response Analysis`,
               color: '#FFFFFF',
               font: {
                 size: 16,
                 weight: 'bold'
               }
             }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Time (seconds)',
                color: '#FFFFFF'
              },
              ticks: {
                color: '#FFFFFF'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Temperature (C)',
                color: '#FFFFFF'
              },
              ticks: {
                color: '#FFFFFF'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              suggestedMin: 0,
              suggestedMax: 80
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          elements: {
            point: {
              radius: 0
            }
          }
        }
      });
      
      // Start continuous simulation
      simulationData.responseAnimationInterval = setInterval(() => {
        // Get current PID parameters dynamically
        const kp = (simulationData && simulationData.responseKp) || parseFloat(document.getElementById('response-kp-slider')?.value) || 0.5;
        const ki = (simulationData && simulationData.responseKi) || parseFloat(document.getElementById('response-ki-slider')?.value) || 0.1;
        const kd = (simulationData && simulationData.responseKd) || parseFloat(document.getElementById('response-kd-slider')?.value) || 0.2;
        
        // Generate input signal based on type
        let inputValue = 25; // Base temperature
        switch (inputType) {
          case 'step':
            inputValue = 25 + (time > 3 ? amplitude : 0);
            break;
          case 'ramp':
            const rampTime = time % 10; // Repeat every 10 seconds
            inputValue = 25 + (rampTime / 10) * amplitude;
            break;
          case 'sine':
            inputValue = 37.5 + (amplitude / 2) * Math.sin(2 * Math.PI * 0.2 * time);
            break;
        }
        
        // Calculate error
        const error = inputValue - responseValue;
        
        // Update integral term
        integral += error * dt;
        
        // Calculate derivative term
        const derivative = (error - lastError) / dt;
        
        // Calculate PID control output
        const controlOutput = kp * error + ki * integral + kd * derivative;
        
        // Clamp control output
        const clampedControlOutput = Math.max(-50, Math.min(50, controlOutput));
        
        // Update system response
        responseValue += clampedControlOutput * dt / tau;
        
        // Add some noise
        responseValue += (Math.random() - 0.5) * 0.5;
        
        // Calculate error signal
        const errorValue = inputValue - responseValue;
        
        // Add data to chart arrays
        chartData.labels.push(time.toFixed(1) + 's');
        chartData.input.push(inputValue);
        chartData.response.push(responseValue);
        chartData.error.push(errorValue);
        
        // Keep only last 150 points for smooth display
        if (chartData.labels.length > 150) {
          chartData.labels.shift();
          chartData.input.shift();
          chartData.response.shift();
          chartData.error.shift();
        }
        
        // Update chart data
        responseChart.data.labels = chartData.labels;
        responseChart.data.datasets[0].data = chartData.input;
        responseChart.data.datasets[1].data = chartData.response;
        responseChart.data.datasets[2].data = chartData.error;
        
        // Update the chart
        responseChart.update('none'); // Use 'none' mode for better performance
        
        // Update time and last error
        time += dt;
        lastError = error;
        
        // Log occasionally for debugging
        if (Math.floor(time * 10) % 50 === 0) {
          console.log('Continuous simulation - Time:', time.toFixed(1), 'Input:', inputValue.toFixed(1), 'Response:', responseValue.toFixed(1), 'Error:', errorValue.toFixed(1));
        }
      }, 100); // Update every 100ms
      
      console.log('Continuous response simulation started');
    }

    // Update response chart with current PID values
    function updateResponseChart() {
      if (!responseChart) {
        console.log('No response chart to update');
        return;
      }
      
      // Get current input type
      const selectedRadio = document.querySelector('input[name="input-type"]:checked');
      const inputType = selectedRadio ? selectedRadio.value : 'step';
      
      // Get current PID values for debugging
      const kp = (simulationData && simulationData.responseKp) || parseFloat(document.getElementById('response-kp-slider')?.value) || 0.5;
      const ki = (simulationData && simulationData.responseKi) || parseFloat(document.getElementById('response-ki-slider')?.value) || 0.1;
      const kd = (simulationData && simulationData.responseKd) || parseFloat(document.getElementById('response-kd-slider')?.value) || 0.2;
      
      console.log('Updating response chart with PID values - Kp:', kp, 'Ki:', ki, 'Kd:', kd);
      
      // Generate new data with current PID values
      const data = generateResponseData(inputType, 25, 15, 0.5);
      
      // Update chart data
      responseChart.data.labels = data.input.map(point => point.time.toFixed(1) + 's');
      responseChart.data.datasets[0].data = data.input.map(point => point.value);
      responseChart.data.datasets[1].data = data.response.map(point => point.value);
      responseChart.data.datasets[2].data = data.error.map(point => point.value);
      
      // Update the chart
      responseChart.update();
      
      console.log('Response chart updated successfully');
    }

    // Draw enhanced grid on canvas
    function drawEnhancedGrid(ctx, width, height, duration) {
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 1;
      
      // Vertical lines (time)
      for (let x = 0; x <= width; x += width / 10) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }
      
      // Horizontal lines (temperature)
      for (let y = 0; y <= height; y += height / 8) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }
      
      // Add labels
      ctx.fillStyle = '#FFFFFF';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      
      // Y-axis labels (temperature) - will be updated dynamically
      for (let i = 0; i <= 8; i++) {
        const y = height - (i * height / 8);
        const temp = i * 12.5; // 0 to 100C
        ctx.fillText(temp + 'C', 30, y + 4);
      }
      
      // X-axis labels (time) - for scrolling display
      for (let i = 0; i <= 10; i++) {
        const x = i * width / 10;
        const time = i * duration / 10;
        ctx.fillText(time.toFixed(1) + 's', x, height - 5);
      }
    }
    
    // Draw dynamic grid with auto-scaling Y-axis
    function drawDynamicGrid(ctx, width, height, data, timeWindow) {
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 1;
      
      // Auto-scale Y-axis based on actual data range
      let allValues = [];
      if (data && data.input && data.input.length > 0) {
        allValues = allValues.concat(data.input.map(p => p.value));
      }
      if (data && data.response && data.response.length > 0) {
        allValues = allValues.concat(data.response.map(p => p.value));
      }
      if (data && data.error && data.error.length > 0) {
        // Scale error values to fit in temperature range
        allValues = allValues.concat(data.error.map(p => 50 + p.value * 2));
      }
      
      let tempMin = 0;
      let tempMax = 80;
      
      if (allValues.length > 0) {
        const dataMin = Math.min(...allValues);
        const dataMax = Math.max(...allValues);
        const range = dataMax - dataMin;
        const padding = range * 0.2; // 20% padding
        
        tempMin = Math.max(0, Math.floor(dataMin - padding));
        tempMax = Math.min(100, Math.ceil(dataMax + padding));
        
        // Ensure minimum range for visibility
        if (tempMax - tempMin < 20) {
          const center = (tempMin + tempMax) / 2;
          tempMin = Math.max(0, center - 10);
          tempMax = Math.min(100, center + 10);
        }
      }
      
      // Store the calculated range for use in curve drawing
      window.currentTempRange = { min: tempMin, max: tempMax };
      
      // Vertical lines (time)
      for (let x = 0; x <= width; x += width / 10) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }
      
      // Horizontal lines (temperature)
      for (let y = 0; y <= height; y += height / 8) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }
      
      // Add labels
      ctx.fillStyle = '#FFFFFF';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      
      // Y-axis labels (temperature) - dynamic scaling
      for (let i = 0; i <= 8; i++) {
        const y = height - (i * height / 8);
        const temp = tempMin + (i * (tempMax - tempMin) / 8);
        ctx.fillText(temp.toFixed(1) + 'C', 30, y + 4);
      }
      
      // X-axis labels (time) - for scrolling display
      for (let i = 0; i <= 10; i++) {
        const x = i * width / 10;
        const time = i * timeWindow / 10;
        ctx.fillText(time.toFixed(1) + 's', x, height - 5);
      }
    }

    // Generate enhanced response data based on input type and parameters
    function generateEnhancedResponseData(inputType, amplitude, duration, frequency) {
      const data = {
        input: [],
        response: [],
        error: []
      };
      
      const timeSteps = 200;
      const baseTemp = 25; // Base temperature
      
      // PID simulation variables
      let integral = 0;
      let lastError = 0;
      
      // Get current PID parameters - use response-specific values if available, otherwise fall back to main values
      const kp = (simulationData && simulationData.responseKp) || (simulationData && simulationData.kp) || parseFloat(document.getElementById('response-kp-slider')?.value) || parseFloat(document.getElementById('kp-slider')?.value) || 0.5;
      const ki = (simulationData && simulationData.responseKi) || (simulationData && simulationData.ki) || parseFloat(document.getElementById('response-ki-slider')?.value) || parseFloat(document.getElementById('ki-slider')?.value) || 0.1;
      const kd = (simulationData && simulationData.responseKd) || (simulationData && simulationData.kd) || parseFloat(document.getElementById('response-kd-slider')?.value) || parseFloat(document.getElementById('kd-slider')?.value) || 0.2;
      
      for (let i = 0; i < timeSteps; i++) {
        const time = (i / timeSteps) * duration;
        let inputValue = baseTemp;
        let responseValue = baseTemp;
        
        // Generate input signal
        switch (inputType) {
          case 'step':
            inputValue = baseTemp + (time > duration * 0.2 ? amplitude : 0);
            break;
          case 'ramp':
            inputValue = baseTemp + (time / duration) * amplitude;
            break;
          case 'sine':
            inputValue = baseTemp + amplitude * Math.sin(2 * Math.PI * frequency * time);
            break;
        }
        
        // Generate system response (simplified PID simulation)
        const dt = duration / timeSteps;
        
        if (i > 0) {
          const prevResponse = data.response[i - 1].value;
          
          // Calculate error between input and current response
          const error = inputValue - prevResponse;
          
          // Update integral term (accumulate error over time)
          integral += error * dt;
          
          // Calculate derivative term (rate of change of error)
          const derivative = (error - lastError) / dt;
          
          // Calculate PID control output
          const controlOutput = kp * error + ki * integral + kd * derivative;
          
          // Clamp control output to reasonable range
          const clampedControlOutput = Math.max(-50, Math.min(50, controlOutput));
          
          // Update response using first-order system model
          const tau = 2.0; // time constant
          responseValue = prevResponse + clampedControlOutput * dt / tau;
          
          // Add some realistic noise
          responseValue += (Math.random() - 0.5) * 0.5;
          
          // Update last error for next iteration
          lastError = error;
        } else {
          // For the first point, start at base temperature
          responseValue = baseTemp;
        }
        
        const errorValue = inputValue - responseValue;
        
        data.input.push({ time, value: inputValue });
        data.response.push({ time, value: responseValue });
        data.error.push({ time, value: errorValue });
      }
      
      // Ensure we have valid data
      if (data.input.length === 0) {
        console.error('No data generated');
        return { input: [], response: [], error: [] };
      }
      
      return data;
    }

    // Start real-time response simulation
    function startRealTimeResponseSimulation(ctx, width, height, inputType, amplitude, duration, frequency) {
      if (simulationData.responseAnimationInterval) {
        clearInterval(simulationData.responseAnimationInterval);
      }
      
      // Initialize simulation data
      let time = 0;
      let responseValue = 25; // Base temperature
      let integral = 0;
      let lastError = 0;
      const dt = 0.1; // Time step
      const tau = 2.0; // System time constant
      
      // PID parameters will be read dynamically on each iteration
      
      // Store data for plotting
      const data = {
        input: [],
        response: [],
        error: []
      };
      
      simulationData.responseAnimationInterval = setInterval(() => {
        // Check if input type was changed
        if (simulationData.inputTypeChanged) {
          console.log('Input type changed detected, resetting simulation');
          time = 0; // Reset time
          responseValue = 25; // Reset response
          integral = 0; // Reset integral
          lastError = 0; // Reset last error
          
          // Clear data arrays
          data.input = [];
          data.response = [];
          data.error = [];
          
          // Clear the flag
          simulationData.inputTypeChanged = false;
          console.log('Simulation reset complete');
        }
        
        // Get current input type from radio buttons (in case it changed)
        const selectedRadio = document.querySelector('input[name="input-type"]:checked');
        const currentInputType = selectedRadio ? selectedRadio.value : inputType;
        
        // Debug: log the current input type every 50 iterations (5 seconds)
        if (Math.floor(time * 10) % 50 === 0) {
          console.log('Current input type:', currentInputType, 'Time:', time.toFixed(1));
        }
        

        
        // Clear canvas and redraw grid
        ctx.fillStyle = '#222';
        ctx.fillRect(0, 0, width, height);
        
        // Calculate time window for scrolling display
        const timeWindow = 15; // Show last 15 seconds
        const startTime = Math.max(0, time - timeWindow);
        const endTime = time;
        
        drawDynamicGrid(ctx, width, height, data, timeWindow);
        
        // Generate input signal based on current type
        let inputValue = 25; // Base temperature
        switch (currentInputType) {
          case 'step':
            inputValue = 25 + (time > 3 ? amplitude : 0);
            break;
          case 'ramp':
            // Create a repeating ramp that goes from 25C to 50C over 10 seconds, then repeats
            const rampTime = time % 10; // Repeat every 10 seconds
            inputValue = 25 + (rampTime / 10) * amplitude;
            break;
          case 'sine':
            // Create a sine wave that oscillates around 37.5C (midpoint of 25-50C)
            inputValue = 37.5 + (amplitude / 2) * Math.sin(2 * Math.PI * 0.2 * time); // 0.2 Hz = 5 second period
            break;
        }
        
        // Get current PID parameters dynamically on each iteration
        const kp = (simulationData && simulationData.responseKp) || (simulationData && simulationData.kp) || parseFloat(document.getElementById('response-kp-slider')?.value) || parseFloat(document.getElementById('kp-slider')?.value) || 0.5;
        const ki = (simulationData && simulationData.responseKi) || (simulationData && simulationData.ki) || parseFloat(document.getElementById('response-ki-slider')?.value) || parseFloat(document.getElementById('ki-slider')?.value) || 0.1;
        const kd = (simulationData && simulationData.responseKd) || (simulationData && simulationData.kd) || parseFloat(document.getElementById('response-kd-slider')?.value) || parseFloat(document.getElementById('kd-slider')?.value) || 0.2;
        
        // Debug: log PID values occasionally
        if (Math.floor(time * 10) % 100 === 0) {
          console.log('Real-time simulation PID values - Kp:', kp, 'Ki:', ki, 'Kd:', kd);
        }
        
        // Calculate error
        const error = inputValue - responseValue;
        
        // Update integral term
        integral += error * dt;
        
        // Calculate derivative term
        const derivative = (error - lastError) / dt;
        
        // Calculate PID control output
        const controlOutput = kp * error + ki * integral + kd * derivative;
        
        // Clamp control output
        const clampedControlOutput = Math.max(0, Math.min(100, controlOutput));
        
        // Update system response
        responseValue += (clampedControlOutput - responseValue) * dt / tau;
        
        // Add some noise
        responseValue += (Math.random() - 0.5) * 0.5;
        
        // Store data
        data.input.push({ time, value: inputValue });
        data.response.push({ time, value: responseValue });
        data.error.push({ time, value: error });
        
        // Keep only last 150 points for smooth display
        if (data.input.length > 150) {
          data.input.shift();
          data.response.shift();
          data.error.shift();
        }
        
        // Draw curves
        drawResponseCurves(ctx, data, width, height, duration, data.input.length - 1);
        
        // Update time
        time += dt;
        lastError = error;
        
        // Continue simulation indefinitely (don't stop after duration)
        // The simulation will keep running and the display will scroll
      }, 100); // Update every 100ms
    }
    
    // Draw response curves
    function drawResponseCurves(ctx, data, width, height, duration, maxIndex) {
      // Validate data
      if (!data || !data.input || !data.response || !data.error) {
        console.error('Invalid data structure for drawing curves:', data);
        return;
      }
      
      // Use dynamic Y-axis scaling from drawDynamicGrid
      const tempRange = window.currentTempRange || { min: 0, max: 80 };
      const tempMin = tempRange.min;
      const tempMax = tempRange.max;
      const tempRangeValue = tempMax - tempMin;
      
      // Draw input signal (pink)
      ctx.strokeStyle = '#E91E63';
      ctx.lineWidth = 3;
      ctx.beginPath();
      for (let i = 0; i <= maxIndex && i < data.input.length; i++) {
        const point = data.input[i];
        // Calculate scrolling X position
        const timeWindow = 15;
        const startTime = Math.max(0, data.input[data.input.length - 1]?.time - timeWindow || 0);
        const x = ((point.time - startTime) / timeWindow) * width;
        const y = height - ((point.value - tempMin) / tempRangeValue) * height;
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();
      
      // Draw system response (blue)
      ctx.strokeStyle = '#2196F3';
      ctx.lineWidth = 3;
      ctx.beginPath();
      for (let i = 0; i <= maxIndex && i < data.response.length; i++) {
        const point = data.response[i];
        // Calculate scrolling X position
        const timeWindow = 15;
        const startTime = Math.max(0, data.response[data.response.length - 1]?.time - timeWindow || 0);
        const x = ((point.time - startTime) / timeWindow) * width;
        const y = height - ((point.value - tempMin) / tempRangeValue) * height;
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();
      
      // Draw error signal (green, scaled)
      ctx.strokeStyle = '#4CAF50';
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i = 0; i <= maxIndex && i < data.error.length; i++) {
        const point = data.error[i];
        // Calculate scrolling X position
        const timeWindow = 15;
        const startTime = Math.max(0, data.error[data.error.length - 1]?.time - timeWindow || 0);
        const x = ((point.time - startTime) / timeWindow) * width;
        // Scale error to fit in temperature range
        const scaledError = 50 + point.value * 2; // Center at 50C, scale by 2
        const y = height - ((scaledError - tempMin) / tempRangeValue) * height;
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();
    }

    // Animate response curve
    function animateResponse(ctx, data, width, height, inputType) {
      let currentIndex = 0;
      const animationInterval = setInterval(() => {
        if (currentIndex >= data.length) {
          clearInterval(animationInterval);
          return;
        }
        
        const point = data[currentIndex];
        const x = (point.time / 10) * width;
        const y = height - ((point.value - 0) / 100) * height;
        
        // Draw point
        ctx.fillStyle = '#4CAF50';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();
        
        currentIndex++;
      }, 50); // Update every 50ms
    }

    // Draw labels on canvas
    function drawLabels(ctx, width, height, inputType) {
      ctx.fillStyle = '#FFFFFF';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      
      // Title
      ctx.fillText(`${inputType.charAt(0).toUpperCase() + inputType.slice(1)} Response Test`, width / 2, 20);
      
      // Y-axis label
      ctx.save();
      ctx.translate(20, height / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillText('Temperature (C)', 0, 0);
      ctx.restore();
      
      // X-axis label
      ctx.fillText('Time (seconds)', width / 2, height - 10);
    }
    
    // Update PID display in response tab
    function updatePIDDisplay() {
      const kpDisplay = document.getElementById('display-kp');
      const kiDisplay = document.getElementById('display-ki');
      const kdDisplay = document.getElementById('display-kd');
      
      if (kpDisplay && simulationData) kpDisplay.textContent = simulationData.kp.toFixed(2);
      if (kiDisplay && simulationData) kiDisplay.textContent = simulationData.ki.toFixed(2);
      if (kdDisplay && simulationData) kdDisplay.textContent = simulationData.kd.toFixed(2);
    }
    
    // Initialize event listeners for response test
    function initializeResponseTestEventListeners() {
      // Add event listeners to radio buttons
      const radioButtons = document.querySelectorAll('input[name="input-type"]');
      radioButtons.forEach(radio => {
        radio.addEventListener('change', () => {
          console.log('Response type changed to:', radio.value);
          
          // Force the simulation to immediately use the new input type
          // by setting a flag that the simulation will check
          if (simulationData) {
            simulationData.inputTypeChanged = true;
            simulationData.newInputType = radio.value;
            console.log('Set input type change flag to:', radio.value);
          }
        });
      });
      
      // Add event listeners to PID sliders
      const kpSlider = document.getElementById('kp-slider');
      const kiSlider = document.getElementById('ki-slider');
      const kdSlider = document.getElementById('kd-slider');
      
      if (kpSlider) {
        kpSlider.addEventListener('input', () => {
          if (simulationData) {
            simulationData.kp = parseFloat(kpSlider.value);
            updatePIDDisplay();
          }
        });
      }
      
      if (kiSlider) {
        kiSlider.addEventListener('input', () => {
          if (simulationData) {
            simulationData.ki = parseFloat(kiSlider.value);
            updatePIDDisplay();
          }
        });
      }
      
      if (kdSlider) {
        kdSlider.addEventListener('input', () => {
          if (simulationData) {
            simulationData.kd = parseFloat(kdSlider.value);
            updatePIDDisplay();
          }
        });
      }
    }
    
    // Calculate and display response metrics
    function calculateResponseMetrics(data) {
      // Calculate rise time (time to reach 90% of final value)
      const finalValue = data.response[data.response.length - 1].value;
      const targetValue = finalValue * 0.9;
      let riseTime = 0;
      
      for (let i = 0; i < data.response.length; i++) {
        if (data.response[i].value >= targetValue) {
          riseTime = data.response[i].time;
          break;
        }
      }
      
      // Calculate overshoot
      const maxValue = Math.max(...data.response.map(p => p.value));
      const overshoot = ((maxValue - finalValue) / finalValue) * 100;
      
      // Calculate settling time (time to stay within 5% of final value)
      let settlingTime = 0;
      const tolerance = finalValue * 0.05;
      
      for (let i = data.response.length - 1; i >= 0; i--) {
        if (Math.abs(data.response[i].value - finalValue) > tolerance) {
          settlingTime = data.response[i].time;
          break;
        }
      }
      
      // Calculate steady state error
      const steadyError = Math.abs(data.error[data.error.length - 1].value);
      
      // Update display
      const riseTimeElement = document.getElementById('response-rise-time');
      const overshootElement = document.getElementById('response-overshoot');
      const settlingTimeElement = document.getElementById('response-settling-time');
      const steadyErrorElement = document.getElementById('response-steady-error');
      
      if (riseTimeElement) riseTimeElement.textContent = riseTime.toFixed(2) + 's';
      if (overshootElement) overshootElement.textContent = overshoot.toFixed(1) + '%';
      if (settlingTimeElement) settlingTimeElement.textContent = settlingTime.toFixed(2) + 's';
      if (steadyErrorElement) steadyErrorElement.textContent = steadyError.toFixed(2) + 'C';
    }

    // Start challenge
    function startChallenge(challengeId) {
      const challengeCard = document.querySelector(`[data-challenge="${challengeId}"]`);
      const checkButton = document.querySelector(`.check-challenge-btn[data-challenge="${challengeId}"]`);
      if (!challengeCard || !checkButton) return;
      
      const statusIndicator = challengeCard.querySelector('.status-indicator');
      const statusText = challengeCard.querySelector('.challenge-status span:last-child');
      
      // Update button to show evaluating state
      checkButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Evaluating...';
      checkButton.style.background = 'linear-gradient(135deg, #FF9800, #F57C00)';
      checkButton.disabled = true;
      
      // Reset status
      statusIndicator.style.background = '#FF9800';
      statusText.textContent = 'Evaluating...';
      statusText.style.color = '#FF9800';
      
      // Evaluate based on current PID settings
      setTimeout(() => {
        let success = false;
        
        switch (challengeId) {
          case '1': // Minimal Overshoot
            const overshoot = Math.max(0, 15 - simulationData.kp * 5 + simulationData.ki * 10);
            success = overshoot < 5;
            break;
          case '2': // Fast Settling Time
            const settlingTime = Math.max(1.0, 5.0 - simulationData.kp * 1.5 + simulationData.ki * 2);
            success = settlingTime < 2;
            break;
          case '3': // Disturbance Rejection
            success = simulationData.kp > 0.8 && simulationData.ki > 0.05;
            break;
        }
        
        if (success) {
          statusIndicator.style.background = '#4CAF50';
          statusText.textContent = 'Completed!';
          statusText.style.color = '#4CAF50';
          
          // Update button for success
          checkButton.innerHTML = '<i class="fas fa-check-circle"></i> Challenge Complete!';
          checkButton.style.background = 'linear-gradient(135deg, #4CAF50, #388E3C)';
          checkButton.disabled = true;
          
          // Add success animation
          challengeCard.style.transform = 'scale(1.02)';
          challengeCard.style.boxShadow = '0 8px 25px rgba(76, 175, 80, 0.4)';
          setTimeout(() => {
            challengeCard.style.transform = 'scale(1)';
            challengeCard.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
          }, 500);
        } else {
          statusIndicator.style.background = '#f44336';
          statusText.textContent = 'Failed';
          statusText.style.color = '#f44336';
          
          // Update button for failure
          checkButton.innerHTML = '<i class="fas fa-times-circle"></i> Try Again';
          checkButton.style.background = 'linear-gradient(135deg, #f44336, #D32F2F)';
          checkButton.disabled = false;
          
          // Add failure animation
          challengeCard.style.transform = 'scale(0.98)';
          setTimeout(() => {
            challengeCard.style.transform = 'scale(1)';
          }, 200);
        }
      }, 1500);
    }

    // Initialize PID tuning graph with Chart.js
    function initPIDTuningGraph() {
      const canvas = document.getElementById('pid-tuning-chart');
      if (!canvas) return;
      
      // Destroy existing chart if it exists
      if (pidTuningChart) {
        pidTuningChart.destroy();
      }
      
      // Create new Chart.js chart
      pidTuningChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Setpoint',
              data: [],
              borderColor: '#E91E63',
              backgroundColor: 'rgba(233, 30, 99, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1
            },
            {
              label: 'Process Variable',
              data: [],
              borderColor: '#2196F3',
              backgroundColor: 'rgba(33, 150, 243, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1
            },
            {
              label: 'Control Output (%)',
              data: [],
              borderColor: '#4CAF50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 0 // Disable animations for real-time updates
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#FFFFFF',
                font: {
                  size: 12
                }
              }
            },
            title: {
              display: true,
              text: 'Real-time PID Tuning',
              color: '#FFFFFF',
              font: {
                size: 16,
                weight: 'bold'
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Time (seconds)',
                color: '#FFFFFF'
              },
              ticks: {
                color: '#FFFFFF'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Temperature (C) / Control Output (%)',
                color: '#FFFFFF'
              },
              ticks: {
                color: '#FFFFFF'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              suggestedMin: 0,
              suggestedMax: 100
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          elements: {
            point: {
              radius: 0
            }
          }
        }
      });
      
      // Clear graph data
      simulationData.graphData.setpoint = [];
      simulationData.graphData.processVariable = [];
      simulationData.graphData.controlOutput = [];
      simulationData.graphData.time = [];
    }



    // Add data point to graph
    function addGraphData() {
      simulationData.graphData.time.push(simulationData.time);
      simulationData.graphData.setpoint.push(simulationData.setpoint);
      simulationData.graphData.processVariable.push(simulationData.processVariable);
      simulationData.graphData.controlOutput.push(simulationData.output);
      
      // Keep only the last maxDataPoints
      if (simulationData.graphData.time.length > simulationData.maxDataPoints) {
        simulationData.graphData.time.shift();
        simulationData.graphData.setpoint.shift();
        simulationData.graphData.processVariable.shift();
        simulationData.graphData.controlOutput.shift();
      }
    }

    // Update PID tuning graph with Chart.js
    function drawPIDTuningGraph() {
      if (!pidTuningChart || simulationData.graphData.time.length < 2) return;
      
      // Calculate time window for scrolling (keep last 20 seconds)
      const currentTime = simulationData.time;
      const timeWindow = 20; // 20 second window
      const startTime = Math.max(0, currentTime - timeWindow);
      
      // Filter data to show only the last 20 seconds
      const filteredData = {
        time: [],
        setpoint: [],
        processVariable: [],
        controlOutput: []
      };
      
      simulationData.graphData.time.forEach((time, index) => {
        if (time >= startTime && time <= currentTime) {
          filteredData.time.push(time);
          filteredData.setpoint.push(simulationData.graphData.setpoint[index]);
          filteredData.processVariable.push(simulationData.graphData.processVariable[index]);
          filteredData.controlOutput.push(simulationData.graphData.controlOutput[index]);
        }
      });
      
      // Update chart data
      pidTuningChart.data.labels = filteredData.time.map(t => t.toFixed(1) + 's');
      pidTuningChart.data.datasets[0].data = filteredData.setpoint;
      pidTuningChart.data.datasets[1].data = filteredData.processVariable;
      pidTuningChart.data.datasets[2].data = filteredData.controlOutput;
      
      // Update the chart
      pidTuningChart.update('none'); // Use 'none' mode for better performance
    }

    // Tab switching function removed - sections are now displayed vertically

    // Interactive Fault Scenario 1 - Tank Temperature Control with Operator Offset Error
    function renderInteractiveFaultScenario1(scenario) {
      const container = document.getElementById('worksheet-content');
      
      container.innerHTML = `
        <h1 class="page-title">
          <i class="fas fa-thermometer-half"></i> ${scenario.title}
          <div style="font-size: 18px; font-weight: normal; color: #FFA726; margin-top: 10px;">
            ${scenario.subtitle}  ${scenario.difficulty.toUpperCase()}  ${scenario.estimated_time}
          </div>
        </h1>





        <!-- Scenario -->
        <div class="worksheet-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FF5722;">
          <h2 class="section-header" style="color: #FF5722; margin-bottom: 20px; font-size: 24px;">
            <i class="fas fa-info-circle"></i> Scenario
          </h2>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="background: #333; padding: 15px; border-radius: 8px;">
              <strong style="color: #FFA726;">Company:</strong> ${scenario.background.company}<br>
              <strong style="color: #FFA726;">Process:</strong> ${scenario.background.process}<br>
              <strong style="color: #FFA726;">Shift:</strong> ${scenario.background.shift}<br>
              <strong style="color: #FFA726;">Urgency:</strong> ${scenario.background.urgency}
            </div>
            <div style="text-align: center;">
              <img src="assets/scenarios/${scenario.image}" alt="${scenario.title}" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
            </div>
          </div>
          <div style="color: #FFFFFF; line-height: 1.6;">
            ${scenario.introduction.map(para => `<p style="margin-bottom: 15px;">${para}</p>`).join('')}
          </div>
        </div>

        <!-- Interactive Tank Temperature System -->
        <div class="worksheet-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #4CAF50;">
          <h2 class="section-header" style="color: #4CAF50; margin-bottom: 20px; font-size: 24px;">
            <i class="fas fa-thermometer-half"></i> Interactive Tank Temperature Control System
          </h2>
          
          <!-- System Status Display -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="sim-card" style="background: #333; padding: 20px; border-radius: 8px; text-align: center;">
              <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Setpoint</label>
              <div style="font-size: 24px; color: #4CAF50; font-weight: bold;">${scenario.system_overview.setpoint}C</div>
            </div>
            <div class="sim-card" style="background: #333; padding: 20px; border-radius: 8px; text-align: center;">
              <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Displayed Temperature</label>
              <div id="displayed-temp" style="font-size: 24px; color: #4CAF50; font-weight: bold;">${scenario.system_overview.displayed_temp}C</div>
              <div style="font-size: 12px; color: #888; margin-top: 5px;">What controller sees</div>
            </div>
            <div class="sim-card" style="background: #333; padding: 20px; border-radius: 8px; text-align: center;">
              <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Actual Temperature</label>
              <div id="actual-temp" style="font-size: 24px; color: #FF5722; font-weight: bold;">${scenario.system_overview.actual_temp}C</div>
              <div style="font-size: 12px; color: #888; margin-top: 5px;">Real tank temperature</div>
            </div>
            <div class="sim-card" style="background: #333; padding: 20px; border-radius: 8px; text-align: center;">
              <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Temperature Offset</label>
              <div id="temp-offset" style="font-size: 24px; color: #FF9800; font-weight: bold;">+${scenario.system_overview.offset_applied}C</div>
              <div style="font-size: 12px; color: #888; margin-top: 5px;">Applied adjustment</div>
            </div>
            <div class="sim-card" style="background: #333; padding: 20px; border-radius: 8px; text-align: center;">
              <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Cooling System</label>
              <div id="cooling-load" style="font-size: 18px; color: #2196F3; font-weight: bold;">${scenario.system_overview.cooling_load}</div>
              <div style="font-size: 12px; color: #888; margin-top: 5px;">Working harder than normal</div>
            </div>
            <div class="sim-card" style="background: #333; padding: 20px; border-radius: 8px; text-align: center;">
              <label style="color: #FFFFFF; font-weight: bold; display: block; margin-bottom: 10px;">Quality Status</label>
              <div id="quality-status" style="font-size: 18px; color: #FF5722; font-weight: bold;">ISSUES DETECTED</div>
              <div style="font-size: 12px; color: #888; margin-top: 5px;">Signs of overheating</div>
            </div>
          </div>

          <!-- Interactive Investigation Tools -->
          <div style="margin-bottom: 30px;">
            <h3 style="color: #FFFFFF; margin-bottom: 15px;">Investigation Tools</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
              <button onclick="inspectSensorWiring()" style="background: #607D8B; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-plug"></i> Inspect Sensor Wiring
              </button>
              <button onclick="usePortableThermometer()" style="background: #FF9800; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-thermometer-half"></i> Use Portable Thermometer
              </button>
              <button onclick="checkCoolingSystem()" style="background: #795548; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-snowflake"></i> Check Cooling System
              </button>
              <button onclick="reviewQualityReports()" style="background: #9C27B0; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-chart-line"></i> Review Quality Reports
              </button>
              <button onclick="testBackupSensor()" style="background: #5D4037; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-thermometer-quarter"></i> Test Backup Sensor
              </button>
              <button onclick="checkControllerOffset()" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-search"></i> Check Controller Offset
              </button>
              <button onclick="adjustOffset()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-cog"></i> Adjust Offset
              </button>
              <button onclick="reviewMaintenanceLog()" style="background: #546E7A; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-clipboard-list"></i> Review Maintenance Log
              </button>
              <button onclick="analyzeTrendData()" style="background: #424242; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-chart-area"></i> Analyze Trend Data
              </button>
              <button onclick="checkPowerSupply()" style="background: #37474F; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-bolt"></i> Check Power Supply
              </button>
              <button onclick="testControlValve()" style="background: #455A64; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-valve"></i> Test Control Valve
              </button>
              <button onclick="checkInsulation()" style="background: #3E2723; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-shield-alt"></i> Check Tank Insulation
              </button>
            </div>
          </div>

          <!-- Temperature Chart -->
          <div style="background: #222; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #FFFFFF; margin-bottom: 15px;">Temperature Trend (Displayed vs Actual)</h3>
            <canvas id="temperature-chart" width="800" height="300" style="width: 100%; height: 200px; background: #111; border-radius: 4px;"></canvas>
          </div>

          <!-- Component Status -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            ${scenario.system_overview.components.map(component => `
              <div class="component-card" style="background: #333; padding: 20px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                <h4 style="color: #4CAF50; margin-bottom: 10px;">${component.name}</h4>
                <div style="color: #FFFFFF; font-size: 14px; line-height: 1.5;">
                  <strong>Type:</strong> ${component.type.replace('_', ' ')}<br>
                  <strong>Location:</strong> ${component.location}<br>
                  <strong>Status:</strong> <span style="color: #FF5722;">${component.status.toUpperCase()}</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Interactive Learning Scenarios -->
        <div class="worksheet-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #9C27B0;">
          <h2 class="section-header" style="color: #9C27B0; margin-bottom: 20px; font-size: 24px;">
            <i class="fas fa-tools"></i> Interactive Learning Journey
          </h2>
          
          <!-- Progress Bar -->
          <div style="background: #333; border-radius: 10px; margin-bottom: 30px; overflow: hidden;">
            <div id="learning-progress" style="background: linear-gradient(90deg, #9C27B0, #E91E63); height: 8px; width: 0%; transition: width 0.3s ease;"></div>
          </div>
          
          <!-- Step Counter and Score -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div style="color: #FFFFFF;">
              Phase <span id="current-learning-phase">1</span> of ${scenario.learning_scenarios.length}
            </div>
            <div style="color: #FFFFFF;">
              Score: <span id="learning-score" style="color: #4CAF50; font-weight: bold;">0</span>/100
            </div>
          </div>

          <!-- Learning Phase Content -->
          <div id="learning-content">
            <!-- Dynamic content will be loaded here -->
          </div>
        </div>

        <!-- Real-World Examples -->
        <div class="worksheet-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FFC107;">
          <h2 class="section-header" style="color: #FFC107; margin-bottom: 20px; font-size: 24px;">
            <i class="fas fa-industry"></i> Real-World Examples - When This Goes Wrong
          </h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            ${scenario.real_world_examples.map(example => `
              <div style="background: #333; padding: 20px; border-radius: 8px; border-left: 4px solid #FFC107;">
                <h4 style="color: #FFC107; margin-bottom: 10px;">${example.industry}</h4>
                <p style="color: #FFFFFF; margin-bottom: 10px; font-size: 14px;">${example.problem}</p>
                <div style="color: #FF5722; font-weight: bold; font-size: 14px;">Cost: ${example.cost}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Enhanced Questions -->
        <div class="worksheet-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FF9800;">
          <h2 class="section-header" style="color: #FF9800; margin-bottom: 20px; font-size: 24px;">
            <i class="fas fa-question-circle"></i> Assessment Questions
          </h2>
          
          ${scenario.questions.map((question, index) => `
            <div class="question-item" style="background: #333; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #FF9800; margin-bottom: 15px;">Question ${index + 1}</h3>
              <p style="color: #FFFFFF; margin-bottom: 15px; line-height: 1.6;">${question.text}</p>
              
              ${question.type === 'multiple_choice' ? `
                <div style="margin-bottom: 15px;">
                  ${question.options.map((option, optIndex) => `
                    <label style="display: block; color: #FFFFFF; margin-bottom: 10px; cursor: pointer; padding: 10px; border-radius: 5px; background: #333; transition: background 0.3s;">
                      <input type="radio" name="question_${question.id}" value="${optIndex}" style="margin-right: 10px;">
                      ${option}
                    </label>
                  `).join('')}
                </div>
                <button onclick="submitMultipleChoice('${question.id}', ${question.correct_answer})" style="background: #FF9800; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                  Submit Answer
                </button>
                <div id="explanation_${question.id}" style="display: none; background: #1a2f1a; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 3px solid #4CAF50;">
                  <strong style="color: #4CAF50;">Explanation:</strong><br>
                  <span style="color: #FFFFFF;">${question.explanation}</span>
                </div>
              ` : `
                <textarea placeholder="${question.placeholder}" style="width: 100%; height: 100px; padding: 12px; border: 1px solid #555; border-radius: 6px; background: #222; color: #FFFFFF; resize: vertical; font-family: inherit;" data-question="${question.id}"></textarea>
                <button onclick="submitTextAnswer('${question.id}')" style="background: #FF9800; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;">
                  Submit Answer
                </button>
              `}
            </div>
          `).join('')}
        </div>
      `;

      // Initialize the tank temperature system simulation
      initializeTankTemperatureSystem();
      
      // Initialize the learning journey
      initializeLearningJourney(scenario);
      
      // Show the content and hide loading
      document.getElementById('main-content').style.display = 'block';
      document.getElementById('loading-container').style.display = 'none';
      
      // Update navigation buttons
      updateNavigationButtons();
    }

    // Tank Temperature System Functions
    let tankData = {
      setpoint: 75,
      actualTemp: 80,
      displayedTemp: 75,
      offset: 5,
      coolingLoad: 'HIGH',
      qualityIssues: true,
      chartData: [],
      offsetDiscovered: false,
      actualTempDiscovered: false
    };

    function initializeTankTemperatureSystem() {
      // Initialize the temperature chart
      const canvas = document.getElementById('temperature-chart');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 300;
        
        // Start the tank temperature simulation
        setInterval(updateTankTemperatureSystem, 1000);
      }
    }

    function updateTankTemperatureSystem() {
      const displayedTempElement = document.getElementById('displayed-temp');
      const actualTempElement = document.getElementById('actual-temp');
      const offsetElement = document.getElementById('temp-offset');
      const coolingLoadElement = document.getElementById('cooling-load');
      const qualityStatusElement = document.getElementById('quality-status');
      
      // Calculate displayed temperature (actual minus offset)
      tankData.displayedTemp = tankData.actualTemp - tankData.offset;
      
      // Update display elements
      if (displayedTempElement) {
        displayedTempElement.textContent = tankData.displayedTemp + 'C';
        displayedTempElement.style.color = Math.abs(tankData.displayedTemp - tankData.setpoint) < 2 ? '#4CAF50' : '#FF5722';
      }
      
      if (actualTempElement) {
        actualTempElement.textContent = tankData.actualTemp + 'C';
        actualTempElement.style.color = tankData.actualTemp > tankData.setpoint + 2 ? '#FF5722' : '#4CAF50';
      }
      
      if (offsetElement) {
        offsetElement.textContent = (tankData.offset > 0 ? '+' : '') + tankData.offset + 'C';
        offsetElement.style.color = Math.abs(tankData.offset) > 0 ? '#FF9800' : '#4CAF50';
      }
      
      if (coolingLoadElement) {
        coolingLoadElement.textContent = tankData.coolingLoad;
        coolingLoadElement.style.color = tankData.coolingLoad === 'HIGH' ? '#FF5722' : '#4CAF50';
      }
      
      if (qualityStatusElement) {
        qualityStatusElement.textContent = tankData.qualityIssues ? 'ISSUES DETECTED' : 'NORMAL';
        qualityStatusElement.style.color = tankData.qualityIssues ? '#FF5722' : '#4CAF50';
      }
      
      // Update chart
      updateTankTemperatureChart();
    }

    function updateTankTemperatureChart() {
      const canvas = document.getElementById('temperature-chart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const now = Date.now();
      
      // Add new data point
      tankData.chartData.push({
        time: now,
        displayedTemp: tankData.displayedTemp,
        actualTemp: tankData.actualTemp,
        setpoint: tankData.setpoint
      });
      
      // Keep only last 50 points
      if (tankData.chartData.length > 50) {
        tankData.chartData.shift();
      }
      
      // Clear canvas
      ctx.fillStyle = '#111';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw grid
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 1;
      for (let i = 0; i < canvas.width; i += 50) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, canvas.height);
        ctx.stroke();
      }
      for (let i = 0; i < canvas.height; i += 30) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(canvas.width, i);
        ctx.stroke();
      }
      
      // Draw temperature lines
      if (tankData.chartData.length > 1) {
        // Draw displayed temperature line (what controller sees)
        ctx.strokeStyle = '#4CAF50';
        ctx.lineWidth = 3;
        ctx.beginPath();
        tankData.chartData.forEach((point, index) => {
          const x = (index / (tankData.chartData.length - 1)) * canvas.width;
          const y = canvas.height - ((point.displayedTemp - 60) / 30) * canvas.height;
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        ctx.stroke();
        
        // Draw actual temperature line (real tank temperature)
        ctx.strokeStyle = '#FF5722';
        ctx.lineWidth = 3;
        ctx.beginPath();
        tankData.chartData.forEach((point, index) => {
          const x = (index / (tankData.chartData.length - 1)) * canvas.width;
          const y = canvas.height - ((point.actualTemp - 60) / 30) * canvas.height;
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        ctx.stroke();
        
        // Draw setpoint line
        ctx.strokeStyle = '#FFC107';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        const setpointY = canvas.height - ((tankData.setpoint - 60) / 30) * canvas.height;
        ctx.moveTo(0, setpointY);
        ctx.lineTo(canvas.width, setpointY);
        ctx.stroke();
        ctx.setLineDash([]);
      }
      
      // Draw legend
      ctx.fillStyle = '#FFFFFF';
      ctx.font = '12px Arial';
      ctx.fillText('Displayed Temp', 10, 20);
      ctx.fillText('Actual Temp', 10, 35);
      ctx.fillText('Setpoint', 10, 50);
      
      ctx.fillStyle = '#4CAF50';
      ctx.fillRect(110, 12, 20, 3);
      ctx.fillStyle = '#FF5722';
      ctx.fillRect(110, 27, 20, 3);
      ctx.fillStyle = '#FFC107';
      ctx.fillRect(110, 42, 20, 3);
    }

    // Interactive Investigation Functions
    function checkControllerOffset() {
      tankData.offsetDiscovered = true;
      showFeedback('Controller offset discovered: +5C is currently applied!', '#2196F3');
      
      // Show a detailed popup
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #2196F3; margin-bottom: 20px;">Controller Offset Settings</h3>
        <p style="margin-bottom: 15px;">Current offset: <strong>+5C</strong></p>
        <p style="margin-bottom: 15px;">This means the controller subtracts 5C from the sensor reading.</p>
        <p style="margin-bottom: 20px;">Note from day shift: "Added +5C offset to compensate for slow sensor response."</p>
        <button onclick="this.parentElement.remove()" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          Close
        </button>
      `;
      document.body.appendChild(popup);
    }

    function usePortableThermometer() {
      tankData.actualTempDiscovered = true;
      showFeedback('Portable thermometer reading: 80C - The tank is actually hotter than displayed!', '#FF9800');
      
      // Show a detailed popup
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #FF9800; margin-bottom: 20px;">Portable Thermometer Reading</h3>
        <p style="margin-bottom: 15px;">Actual tank temperature: <strong>80C</strong></p>
        <p style="margin-bottom: 15px;">Controller displays: <strong>75C</strong></p>
        <p style="margin-bottom: 20px;">The tank is running 5C hotter than the controller thinks!</p>
        <button onclick="this.parentElement.remove()" style="background: #FF9800; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          Close
        </button>
      `;
      document.body.appendChild(popup);
    }

    function reviewQualityReports() {
      showFeedback('Quality reports show signs of overheating in recent batches!', '#9C27B0');
      
      // Show a detailed popup
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #9C27B0; margin-bottom: 20px;">Quality Report Analysis</h3>
        <ul style="text-align: left; margin-bottom: 20px;">
          <li style="margin-bottom: 10px;">Batch 1247: Product showed signs of thermal degradation</li>
          <li style="margin-bottom: 10px;">Batch 1248: Color changes indicating overheating</li>
          <li style="margin-bottom: 10px;">Batch 1249: Viscosity higher than specification</li>
        </ul>
        <p style="margin-bottom: 20px;">All issues started appearing after the day shift made their "adjustment"</p>
        <button onclick="this.parentElement.remove()" style="background: #9C27B0; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          Close
        </button>
      `;
      document.body.appendChild(popup);
    }

    function adjustOffset() {
      // Show offset adjustment interface
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #4CAF50; margin-bottom: 20px;">Adjust Temperature Offset</h3>
        <p style="margin-bottom: 15px;">Current offset: <span id="popup-offset">+${tankData.offset}C</span></p>
        <div style="margin-bottom: 20px;">
          <input type="range" id="offset-slider" min="-10" max="10" value="${tankData.offset}" 
                 style="width: 300px;" oninput="updateOffsetPreview(this.value)">
          <div style="margin-top: 10px;">
            <span style="font-size: 12px;">-10C</span>
            <span style="float: right; font-size: 12px;">+10C</span>
          </div>
        </div>
        <div style="margin-bottom: 20px;">
          <button onclick="applyOffset()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
            Apply Offset
          </button>
          <button onclick="closeOffsetPopup()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            Cancel
          </button>
        </div>
        <p style="font-size: 12px; color: #888;">Gradually reduce the offset to prevent thermal shock to the system</p>
      `;
      document.body.appendChild(popup);
    }

    function updateOffsetPreview(value) {
      document.getElementById('popup-offset').textContent = (value > 0 ? '+' : '') + value + 'C';
    }

    function closeOffsetPopup() {
      const popup = document.querySelector('div[style*="position: fixed"]');
      if (popup) popup.remove();
    }

    function applyOffset() {
      const newOffset = parseFloat(document.getElementById('offset-slider').value);
      tankData.offset = newOffset;
      
      // Update quality issues based on offset
      tankData.qualityIssues = Math.abs(tankData.actualTemp - tankData.setpoint) > 2;
      tankData.coolingLoad = Math.abs(tankData.actualTemp - tankData.setpoint) > 3 ? 'HIGH' : 'NORMAL';
      
      // Close popup
      const popup = document.querySelector('div[style*="position: fixed"]');
      if (popup) popup.remove();
      
      showFeedback(`Offset adjusted to ${newOffset > 0 ? '+' : ''}${newOffset}C`, '#4CAF50');
    }

    function showFeedback(message, color = '#FF5722') {
      const feedback = document.createElement('div');
      feedback.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 1000;
        background: ${color}; color: white; padding: 15px 20px;
        border-radius: 8px; font-weight: bold; max-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      `;
      feedback.textContent = message;
      document.body.appendChild(feedback);
      
      setTimeout(() => feedback.remove(), 4000);
    }

    // Additional Red Herring Investigation Functions
    function inspectSensorWiring() {
      showFeedback('Sensor wiring inspection complete - All connections are secure!', '#607D8B');
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #607D8B; margin-bottom: 20px;">Sensor Wiring Inspection</h3>
        <p style="margin-bottom: 15px;">All thermocouple connections are secure and properly terminated.</p>
        <p style="margin-bottom: 15px;">Cable insulation is intact with no signs of damage or moisture intrusion.</p>
        <p style="margin-bottom: 20px;">Wiring is not the cause of the temperature issue.</p>
        <button onclick="this.parentElement.remove()" style="background: #607D8B; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          Close
        </button>
      `;
      document.body.appendChild(popup);
    }

    function checkCoolingSystem() {
      showFeedback('Cooling system operating within normal parameters!', '#795548');
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #795548; margin-bottom: 20px;">Cooling System Performance</h3>
        <ul style="text-align: left; margin-bottom: 20px;">
          <li style="margin-bottom: 10px;">Flow rate: 95% of design capacity</li>
          <li style="margin-bottom: 10px;">Inlet temperature: 15C</li>
          <li style="margin-bottom: 10px;">Outlet temperature: 18C</li>
          <li style="margin-bottom: 10px;">Pump operation: Normal</li>
        </ul>
        <p style="margin-bottom: 20px;">The cooling system is working properly and not causing the temperature issue.</p>
        <button onclick="this.parentElement.remove()" style="background: #795548; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          Close
        </button>
      `;
      document.body.appendChild(popup);
    }

    function reviewMaintenanceLog() {
      showFeedback('Maintenance records reviewed - No recent issues found!', '#546E7A');
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #546E7A; margin-bottom: 20px;">Maintenance History</h3>
        <ul style="text-align: left; margin-bottom: 20px;">
          <li style="margin-bottom: 10px;">Last sensor calibration: 6 months ago (within tolerance)</li>
          <li style="margin-bottom: 10px;">Pump maintenance: 3 months ago (routine)</li>
          <li style="margin-bottom: 10px;">Heat exchanger cleaning: 2 months ago</li>
          <li style="margin-bottom: 10px;">No recent work orders on temperature system</li>
        </ul>
        <p style="margin-bottom: 20px;">Maintenance history shows no recent activities that could cause this issue.</p>
        <button onclick="this.parentElement.remove()" style="background: #546E7A; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          Close
        </button>
      `;
      document.body.appendChild(popup);
    }

    function testBackupSensor() {
      showFeedback('Backup sensor confirms primary sensor is reading correctly!', '#5D4037');
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #5D4037; margin-bottom: 20px;">Backup Sensor Test</h3>
        <p style="margin-bottom: 15px;">Secondary temperature sensor reading: <strong>80C</strong></p>
        <p style="margin-bottom: 15px;">Primary sensor reading: <strong>80C</strong></p>
        <p style="margin-bottom: 20px;">Both sensors agree - they're reading the actual temperature correctly!</p>
        <button onclick="this.parentElement.remove()" style="background: #5D4037; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          Close
        </button>
      `;
      document.body.appendChild(popup);
    }

    function analyzeTrendData() {
      showFeedback('Trend analysis reveals when the problem started!', '#424242');
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #424242; margin-bottom: 20px;">Historical Trend Analysis</h3>
        <p style="margin-bottom: 15px;">The 5C temperature discrepancy started exactly <strong>1 week ago</strong></p>
        <p style="margin-bottom: 15px;">Before that, displayed and actual temperatures matched perfectly</p>
        <p style="margin-bottom: 20px;">This suggests something changed in the system configuration a week ago.</p>
        <button onclick="this.parentElement.remove()" style="background: #424242; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          Close
        </button>
      `;
      document.body.appendChild(popup);
    }

    function checkPowerSupply() {
      showFeedback('Power supply is stable and within specifications!', '#37474F');
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #37474F; margin-bottom: 20px;">Power Supply Analysis</h3>
        <ul style="text-align: left; margin-bottom: 20px;">
          <li style="margin-bottom: 10px;">Controller voltage: 24.1 VDC (nominal 24 VDC)</li>
          <li style="margin-bottom: 10px;">Voltage stability: Excellent (0.1V)</li>
          <li style="margin-bottom: 10px;">No power fluctuations detected</li>
          <li style="margin-bottom: 10px;">Power quality: Within specifications</li>
        </ul>
        <p style="margin-bottom: 20px;">Electrical power is not the cause of the temperature issue.</p>
        <button onclick="this.parentElement.remove()" style="background: #37474F; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          Close
        </button>
      `;
      document.body.appendChild(popup);
    }

    function testControlValve() {
      showFeedback('Control valve responding properly to commands!', '#455A64');
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #455A64; margin-bottom: 20px;">Control Valve Test</h3>
        <ul style="text-align: left; margin-bottom: 20px;">
          <li style="margin-bottom: 10px;">Valve responds to manual commands: </li>
          <li style="margin-bottom: 10px;">Position feedback matches commanded position: </li>
          <li style="margin-bottom: 10px;">No mechanical binding or sticking: </li>
          <li style="margin-bottom: 10px;">Actuator operation: Normal</li>
        </ul>
        <p style="margin-bottom: 20px;">The control valve is functioning properly and not causing the temperature issue.</p>
        <button onclick="this.parentElement.remove()" style="background: #455A64; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          Close
        </button>
      `;
      document.body.appendChild(popup);
    }

    function checkInsulation() {
      showFeedback('Tank insulation is intact with no heat loss issues!', '#3E2723');
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #333; color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1000;
        max-width: 500px; text-align: center;
      `;
      popup.innerHTML = `
        <h3 style="color: #3E2723; margin-bottom: 20px;">Tank Insulation Inspection</h3>
        <ul style="text-align: left; margin-bottom: 20px;">
          <li style="margin-bottom: 10px;">Insulation integrity: Excellent</li>
          <li style="margin-bottom: 10px;">No visible damage or missing sections</li>
          <li style="margin-bottom: 10px;">Thermal imaging shows no unexpected heat loss</li>
          <li style="margin-bottom: 10px;">Insulation thickness: Within specifications</li>
        </ul>
        <p style="margin-bottom: 20px;">Tank insulation is not contributing to the temperature control issue.</p>
        <button onclick="this.parentElement.remove()" style="background: #3E2723; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
          Close
        </button>
      `;
      document.body.appendChild(popup);
    }

    // Learning Journey Functions
    let learningState = {
      currentPhase: 1,
      score: 0,
      maxScore: 100,
      scenario: null
    };

    function initializeLearningJourney(scenario) {
      learningState.scenario = scenario;
      learningState.currentPhase = 1;
      learningState.score = 0;
      
      showLearningPhase(1);
    }

    function showLearningPhase(phaseNumber) {
      const phase = learningState.scenario.learning_scenarios[phaseNumber - 1];
      if (!phase) return;
      
      const content = document.getElementById('learning-content');
      content.innerHTML = `
        <div style="background: #333; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #9C27B0; margin-bottom: 15px;">${phase.title}</h3>
          <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.6;">${phase.description}</p>
          
          <div style="margin-bottom: 20px;">
            <h4 style="color: #FFFFFF; margin-bottom: 15px;">Learning Tasks:</h4>
            <ul style="color: #FFFFFF; line-height: 1.6;">
              ${phase.tasks.map(task => `<li style="margin-bottom: 8px;">${task}</li>`).join('')}
            </ul>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="color: #FFFFFF; margin-bottom: 15px;">What did you learn from this phase?</h4>
            <textarea id="phase-insights" placeholder="Describe what you discovered and learned in this phase..." style="width: 100%; height: 80px; padding: 12px; border: 1px solid #555; border-radius: 6px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
          </div>
          
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <button onclick="submitLearningPhase(${phaseNumber})" style="background: #9C27B0; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">
              <i class="fas fa-check"></i> Complete Phase
            </button>
            ${phaseNumber > 1 ? `<button onclick="showLearningPhase(${phaseNumber - 1})" style="background: #666; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">Previous</button>` : ''}
          </div>
        </div>
      `;
      
      // Update progress
      const progress = (phaseNumber / learningState.scenario.learning_scenarios.length) * 100;
      document.getElementById('learning-progress').style.width = progress + '%';
      document.getElementById('current-learning-phase').textContent = phaseNumber;
      document.getElementById('learning-score').textContent = learningState.score;
    }

    function submitLearningPhase(phaseNumber) {
      const insights = document.getElementById('phase-insights').value.trim();
      if (!insights) {
        showInlineNotification('Please describe what you learned before proceeding.', 'error');
        return;
      }
      
      const phase = learningState.scenario.learning_scenarios[phaseNumber - 1];
      learningState.score += phase.points;
      
      // Save the response
      localStorage.setItem(`fault_scenario_1_phase_${phaseNumber}`, insights);
      
      if (phaseNumber < learningState.scenario.learning_scenarios.length) {
        showLearningPhase(phaseNumber + 1);
      } else {
        showLearningComplete();
      }
    }

    function showLearningComplete() {
      const content = document.getElementById('learning-content');
      content.innerHTML = `
        <div style="text-align: center; background: #333; padding: 30px; border-radius: 8px;">
          <h3 style="color: #4CAF50; margin-bottom: 20px;"> Learning Journey Complete!</h3>
          <p style="color: #FFFFFF; font-size: 18px; margin-bottom: 20px;">
            Final Score: <span style="color: #4CAF50; font-weight: bold;">${learningState.score}/${learningState.maxScore}</span>
          </p>
          <p style="color: #FFFFFF; margin-bottom: 20px;">
            You've successfully completed the learning journey about operator offset errors!
          </p>
          <div style="background: #1a2f1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4CAF50;">
            <h4 style="color: #4CAF50; margin-bottom: 15px;">Key Takeaways:</h4>
            <ul style="text-align: left; color: #FFFFFF; line-height: 1.6;">
              <li style="margin-bottom: 8px;">Always document temporary adjustments with clear removal instructions</li>
              <li style="margin-bottom: 8px;">Use independent measurements to verify controller readings</li>
              <li style="margin-bottom: 8px;">Look for indirect signs of problems (quality issues, system strain)</li>
              <li style="margin-bottom: 8px;">Remove offsets gradually to prevent system shock</li>
            </ul>
          </div>
          <button onclick="restartLearning()" style="background: #4CAF50; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold;">
            <i class="fas fa-redo"></i> Try Again
          </button>
        </div>
      `;
      
      document.getElementById('learning-progress').style.width = '100%';
      document.getElementById('learning-score').textContent = learningState.score;
    }

    function restartLearning() {
      learningState.currentPhase = 1;
      learningState.score = 0;
      tankData.offset = 5; // Reset to original problem state
      tankData.offsetDiscovered = false;
      tankData.actualTempDiscovered = false;
      showLearningPhase(1);
    }

    // Question Functions
    function submitMultipleChoice(questionId, correctAnswer) {
      const selectedOption = document.querySelector(`input[name="question_${questionId}"]:checked`);
      if (!selectedOption) {
        showInlineNotification('Please select an answer before submitting.', 'error');
        return;
      }
      
      const selectedValue = parseInt(selectedOption.value);
      const isCorrect = selectedValue === correctAnswer;
      
      // Disable all options
      const allOptions = document.querySelectorAll(`input[name="question_${questionId}"]`);
      allOptions.forEach(option => {
        option.disabled = true;
        const label = option.parentElement;
        if (parseInt(option.value) === correctAnswer) {
          label.style.background = '#1a2f1a';
          label.style.border = '2px solid #4CAF50';
        } else if (option.checked && !isCorrect) {
          label.style.background = '#2f1a1a';
          label.style.border = '2px solid #f44336';
        }
      });
      
      // Show explanation
      const explanation = document.getElementById(`explanation_${questionId}`);
      if (explanation) {
        explanation.style.display = 'block';
      }
      
      // Disable submit button
      const submitButton = document.querySelector(`button[onclick="submitMultipleChoice('${questionId}', ${correctAnswer})"]`);
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.style.background = isCorrect ? '#4CAF50' : '#f44336';
        submitButton.textContent = isCorrect ? ' Correct!' : ' Incorrect';
      }
      
      // Save answer
      localStorage.setItem(`fault_scenario_1_question_${questionId}`, selectedValue);
    }

    function submitTextAnswer(questionId) {
      const textarea = document.querySelector(`textarea[data-question="${questionId}"]`);
      const button = document.querySelector(`button[onclick="submitTextAnswer('${questionId}')"]`);
      
      if (textarea && button) {
        const answer = textarea.value.trim();
        if (!answer) {
          showInlineNotification('Please provide an answer before submitting.', 'error');
          return;
        }
        
        // Disable textarea and button
        textarea.disabled = true;
        button.disabled = true;
        button.style.background = '#4CAF50';
        button.textContent = ' Submitted';
        
        // Save answer
        localStorage.setItem(`fault_scenario_1_text_${questionId}`, answer);
      }
    }

    // Submit question function for interactive worksheet
    function submitInteractiveQuestion(questionNum) {
      const textarea = document.querySelector(`textarea[data-question="${questionNum}"]`);
      const button = document.querySelector(`button[onclick*="${questionNum}"]`);
      const questionItem = document.querySelector(`.question-item[data-question="${questionNum}"]`);
      
      if (textarea && button && questionItem) {
        const userAnswer = textarea.value.trim();
        
        if (userAnswer === '') {
          showInlineNotification('Please provide an answer before submitting.', 'error');
          return;
        }
        
        // Disable textarea and button
        textarea.disabled = true;
        button.textContent = 'Submitted';
        button.disabled = true;
        button.style.backgroundColor = '#4CAF50';
        
        // Get correct answer for Worksheet 1
        const correctAnswer = getWorksheet1CorrectAnswer(questionNum);
        
        // Show answer comparison
        const comparison = questionItem.querySelector('.individual-comparison');
        if (comparison) {
          comparison.innerHTML = `
            <div style="background: #1a2f1a; padding: 15px; border-radius: 4px; margin-top: 15px; border-left: 3px solid #4CAF50;">
              <div style="margin-bottom: 15px;">
                <strong style="color: #4CAF50; display: block; margin-bottom: 8px;">You answered:</strong>
                <p style="color: #FFFFFF; margin: 0; padding: 10px; background: #333; border-radius: 4px;">${escapeHtml(userAnswer)}</p>
              </div>
              <div>
                <strong style="color: #4CAF50; display: block; margin-bottom: 8px;">Correct Answer:</strong>
                <p style="color: #FFFFFF; margin: 0; padding: 10px; background: #333; border-radius: 4px;">${escapeHtml(correctAnswer)}</p>
              </div>
            </div>
          `;
          comparison.classList.remove('hidden');
        }
        
        // Save answer with timestamp
        const key = `worksheet1_interactive_answer_${questionNum}`;
        const timestampKey = `${key}_timestamp`;
        localStorage.setItem(key, userAnswer);
        localStorage.setItem(timestampKey, new Date().toISOString());
        
        console.log('Interactive question', questionNum, 'submitted:', userAnswer);
      }
    }
    
    // Get correct answers for Worksheet 1 questions
    function getWorksheet1CorrectAnswer(questionNum) {
      const correctAnswers = {
        1: "To continuously monitor and adjust system parameters using sensor feedback to maintain desired setpoints, ensuring accuracy and stability even when conditions change.",
        2: "Ensure the hand valve is in the fully open position, with the handle aligned with the piping direction, to allow unrestricted flow through the system.",
        3: "The flow sensor detects the reduced flow and sends this information to the PLC, which then increases pump speed and adjusts the control valve to restore the desired flow rate.",
        4: "The system uses sensor feedback - the flow sensor continuously measures actual flow and sends this data to the PLC, which compares it to the setpoint and makes adjustments to maintain control.",
        5: "Key components include: flow sensor (measures actual flow), PLC (processes data and makes control decisions), pump (provides flow), control valve (regulates flow), and HMI (operator interface)."
      };
      
      return correctAnswers[questionNum] || "This question relates to understanding closed-loop control systems and their practical applications in industrial maintenance.";
    }

    // Function to handle multiple choice question submissions
    window.submitMultipleChoiceQuestion = async function(questionId) {
      try {
        // Get the selected answer
        const selectedRadio = document.querySelector(`input[name="question-${questionId}"]:checked`);
        if (!selectedRadio) {
          showInlineNotification('Please select an answer before submitting.', 'warning');
          return;
        }
        
        const selectedAnswer = parseInt(selectedRadio.value);
        
        // Load the correct answer from JSON
        const response = await fetch('dbMaintenanceScenarios.json');
        const data = await response.json();
        
        // Get the current worksheet ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const worksheetId = parseInt(urlParams.get('id'));
        
        const scenario = data.scenarios.find(s => s.id === worksheetId);
        const question = scenario.questions.find(q => q.id === questionId);
        
        if (!question) {
          showInlineNotification('Question not found.', 'error');
          return;
        }
        
        const isCorrect = selectedAnswer === question.correct_answer;
        const correctAnswerText = question.options[question.correct_answer];
        const selectedAnswerText = question.options[selectedAnswer];
        
        // Find the feedback container
        const questionContainer = document.querySelector(`[data-question="${questionId}"]`);
        const feedbackContainer = questionContainer.querySelector('.answer-feedback');
        const feedbackContent = feedbackContainer.querySelector('.feedback-content');
        
        // Create feedback HTML
        feedbackContent.innerHTML = `
          <div style="margin-bottom: 15px;">
            <strong style="color: ${isCorrect ? '#4CAF50' : '#f44336'}; display: block; margin-bottom: 8px;">
              ${isCorrect ? ' Correct!' : ' Incorrect'}
            </strong>
            <div style="margin-bottom: 10px;">
              <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Your Answer:</strong>
              <p style="color: #FFFFFF; margin: 0; padding: 8px; background: #333; border-radius: 4px; border-left: 3px solid ${isCorrect ? '#4CAF50' : '#f44336'};">
                ${selectedAnswerText}
              </p>
            </div>
            ${!isCorrect ? `
              <div>
                <strong style="color: #4CAF50; display: block; margin-bottom: 5px;">Correct Answer:</strong>
                <p style="color: #FFFFFF; margin: 0; padding: 8px; background: #333; border-radius: 4px; border-left: 3px solid #4CAF50;">
                  ${correctAnswerText}
                </p>
              </div>
            ` : ''}
            <div style="margin-top: 15px; padding: 15px; background: #2a2a2a; border-radius: 4px; border-left: 3px solid #2196F3;">
              <strong style="color: #2196F3; display: block; margin-bottom: 8px;">Explanation:</strong>
              <p style="color: #FFFFFF; margin: 0; line-height: 1.5;">${question.explanation}</p>
            </div>
          </div>
        `;
        
        // Show the feedback
        feedbackContainer.classList.remove('hidden');
        feedbackContainer.style.display = 'block';
        
        // Disable the submit button
        const submitBtn = questionContainer.querySelector('.submit-question-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = isCorrect ? ' Correct!' : ' Incorrect';
        submitBtn.style.background = isCorrect ? '#4CAF50' : '#f44336';
        
        // Save answer to localStorage
        const key = `worksheet${worksheetId}_mc_answer_${questionId}`;
        const timestampKey = `${key}_timestamp`;
        localStorage.setItem(key, selectedAnswer.toString());
        localStorage.setItem(timestampKey, new Date().toISOString());
        
        // Show success notification
        showInlineNotification(
          isCorrect ? 'Correct answer! Well done!' : 'Incorrect answer. Check the explanation below.',
          isCorrect ? 'success' : 'warning'
        );
        
        console.log('Multiple choice question', questionId, 'submitted:', selectedAnswer, 'Correct:', isCorrect);
        
      } catch (error) {
        console.error('Error submitting multiple choice question:', error);
        showInlineNotification('Error submitting answer. Please try again.', 'error');
      }
    };

    // Global function for Worksheet 1 questions (called from original popup code)
    window.submitQuestion = function(questionNum) {
      // This will be handled by the original popup code
      console.log('Question submitted:', questionNum);
    };

    // Inline Notification Functions (no focus issues)
    function showInlineNotification(message, type = 'info', duration = 4000) {
        const existingNotification = document.querySelector('.inline-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.className = `inline-notification ${type}`;
        
        notification.innerHTML = `
            <button class="notification-close" onclick="this.parentElement.remove()"></button>
            <div class="notification-message">${message}</div>
        `;
        
        document.body.appendChild(notification);
        
        if (duration > 0) {
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, duration);
        }
    }
    
    // ========================================
    // INDUSTRIAL MAINTENANCE FEATURE FUNCTIONS
    // ========================================
    
    // Update maintenance mode
    function updateMaintenanceMode(mode) {
      simulationData.maintenanceMode = mode;
      console.log('Maintenance mode updated to:', mode);
      
      switch (mode) {
        case 'cold-start':
          // Simulate cold start conditions
          simulationData.processVariable = 15; // Cold temperature
          simulationData.integral = 0; // Reset integral
          simulationData.lastError = 0; // Reset derivative
          showInlineNotification('Cold start mode activated - system starting from low temperature', 'info');
          break;
        case 'maintenance':
          // Simulate maintenance mode with reduced performance
          simulationData.pumpWear = 0.3; // 30% pump wear
          simulationData.valveBlockage = 0.2; // 20% valve blockage
          showInlineNotification('Maintenance mode activated - simulating equipment wear', 'warning');
          break;
        case 'normal':
        default:
          // Reset to normal operation
          simulationData.pumpWear = 0;
          simulationData.valveBlockage = 0;
          simulationData.sensorDrift = 0;
          showInlineNotification('Normal operation mode activated', 'success');
          break;
      }
      
      updateDisturbanceEffects();
    }
    
    // Update disturbance effects on system
    function updateDisturbanceEffects() {
      // Calculate combined disturbance effect
      const totalDisturbance = simulationData.valveBlockage + simulationData.pumpWear + (Math.abs(simulationData.sensorDrift) / 10);
      
      // Update system health based on disturbances
      if (totalDisturbance < 0.1) {
        simulationData.systemHealth = 'Excellent';
      } else if (totalDisturbance < 0.3) {
        simulationData.systemHealth = 'Good';
      } else if (totalDisturbance < 0.5) {
        simulationData.systemHealth = 'Fair';
      } else {
        simulationData.systemHealth = 'Poor';
      }
      
      // Update maintenance due date based on system health
      if (simulationData.systemHealth === 'Excellent') {
        simulationData.maintenanceDue = 30;
      } else if (simulationData.systemHealth === 'Good') {
        simulationData.maintenanceDue = 20;
      } else if (simulationData.systemHealth === 'Fair') {
        simulationData.maintenanceDue = 10;
      } else {
        simulationData.maintenanceDue = 5;
      }
      
      // Update display
      updateEnhancedMetrics();
    }
    
    // Inject disturbance into system
    function injectDisturbance() {
      const valveBlockage = simulationData.valveBlockage;
      const pumpWear = simulationData.pumpWear;
      const sensorDrift = simulationData.sensorDrift;
      
      if (valveBlockage > 0 || pumpWear > 0 || sensorDrift !== 0) {
        // Apply disturbances to system
        simulationData.processVariable += sensorDrift;
        simulationData.output *= (1 - pumpWear);
        
        showInlineNotification(`Disturbance injected: Valve=${valveBlockage*100}%, Pump=${pumpWear*100}%, Sensor=${sensorDrift}C`, 'warning');
        
        // Update system response
        updatePIDSimulation();
        updateFlowLoopSimulation();
      } else {
        showInlineNotification('No disturbances set. Adjust the sliders first.', 'info');
      }
    }
    
    // Clear all disturbances
    function clearDisturbances() {
      simulationData.valveBlockage = 0;
      simulationData.pumpWear = 0;
      simulationData.sensorDrift = 0;
      
      // Reset sliders
      const valveBlockage = document.getElementById('valve-blockage');
      const pumpWear = document.getElementById('pump-wear');
      const sensorDrift = document.getElementById('sensor-drift');
      
      if (valveBlockage) valveBlockage.value = 0;
      if (pumpWear) pumpWear.value = 0;
      if (sensorDrift) sensorDrift.value = 0;
      
      // Update displays
      document.getElementById('valve-blockage-value').textContent = '0%';
      document.getElementById('pump-wear-value').textContent = '0%';
      document.getElementById('sensor-drift-value').textContent = '0C';
      
      updateDisturbanceEffects();
      showInlineNotification('All disturbances cleared', 'success');
    }
    
    // Update flow loop simulation
    function updateFlowLoopSimulation() {
      // Calculate flow based on pump speed, valve position, and disturbances
      const baseFlow = simulationData.flowSetpoint;
      const pumpEfficiency = 1 - simulationData.pumpWear;
      const valveEfficiency = 1 - simulationData.valveBlockage;
      
      simulationData.actualFlow = baseFlow * pumpEfficiency * valveEfficiency;
      
      // Calculate pump speed needed
      simulationData.pumpSpeed = Math.min(100, Math.max(0, (simulationData.actualFlow / baseFlow) * 100));
      
      // Calculate valve position
      simulationData.valvePosition = Math.min(100, Math.max(0, (simulationData.actualFlow / baseFlow) * 80 + 20));
      
      // Calculate pressure drop
      simulationData.pressureDrop = 2.0 + (simulationData.valveBlockage * 3.0);
      
      // Calculate system efficiency
      simulationData.systemEfficiency = Math.round((simulationData.actualFlow / simulationData.flowSetpoint) * 100);
      
      // Update displays
      updateFlowLoopDisplay();
    }
    
    // Update flow loop display
    function updateFlowLoopDisplay() {
      const actualFlow = document.getElementById('actual-flow');
      const pumpSpeed = document.getElementById('pump-speed');
      const valvePosition = document.getElementById('valve-position');
      const pressureDrop = document.getElementById('pressure-drop');
      const systemEfficiency = document.getElementById('system-efficiency');
      
      if (actualFlow) actualFlow.textContent = simulationData.actualFlow.toFixed(1) + ' L/min';
      if (pumpSpeed) pumpSpeed.textContent = simulationData.pumpSpeed.toFixed(0) + '%';
      if (valvePosition) valvePosition.textContent = simulationData.valvePosition.toFixed(0) + '%';
      if (pressureDrop) pressureDrop.textContent = simulationData.pressureDrop.toFixed(1) + ' bar';
      if (systemEfficiency) systemEfficiency.textContent = simulationData.systemEfficiency + '%';
    }
    
    // Start flow loop simulation
    function startFlowLoopSimulation() {
      if (simulationData.flowLoopInterval) {
        clearInterval(simulationData.flowLoopInterval);
      }
      
      simulationData.flowLoopInterval = setInterval(() => {
        updateFlowLoopSimulation();
        updateFlowLoopVisualization();
      }, 100);
    }
    
    // Update flow loop visualization
    function updateFlowLoopVisualization() {
      const canvas = document.getElementById('flow-loop-canvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      
      // Clear canvas
      ctx.fillStyle = '#222';
      ctx.fillRect(0, 0, width, height);
      
      // Draw flow loop diagram
      drawFlowLoopDiagram(ctx, width, height);
    }
    
    // Draw flow loop diagram
    function drawFlowLoopDiagram(ctx, width, height) {
      // Draw pump
      ctx.fillStyle = simulationData.pumpSpeed > 50 ? '#4CAF50' : '#FF5722';
      ctx.fillRect(50, height/2 - 30, 60, 60);
      ctx.fillStyle = '#FFFFFF';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('PUMP', 80, height/2 + 5);
      ctx.fillText(simulationData.pumpSpeed.toFixed(0) + '%', 80, height/2 + 20);
      
      // Draw valve
      ctx.fillStyle = simulationData.valvePosition > 50 ? '#4CAF50' : '#FF9800';
      ctx.fillRect(width - 110, height/2 - 20, 40, 40);
      ctx.fillStyle = '#FFFFFF';
      ctx.font = '10px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('VALVE', width - 90, height/2 + 5);
      ctx.fillText(simulationData.valvePosition.toFixed(0) + '%', width - 90, height/2 + 18);
      
      // Draw flow lines
      ctx.strokeStyle = '#2196F3';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(110, height/2);
      ctx.lineTo(width - 110, height/2);
      ctx.stroke();
      
      // Draw flow direction arrows
      for (let i = 120; i < width - 120; i += 40) {
        ctx.fillStyle = '#2196F3';
        ctx.beginPath();
        ctx.moveTo(i, height/2 - 5);
        ctx.lineTo(i + 10, height/2);
        ctx.lineTo(i, height/2 + 5);
        ctx.fill();
      }
      
      // Draw flow rate display
      ctx.fillStyle = '#FFFFFF';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(simulationData.actualFlow.toFixed(1) + ' L/min', width/2, height - 20);
    }
    
    // Start maintenance scenario
    function startMaintenanceScenario(scenario) {
      console.log('Starting maintenance scenario:', scenario);
      
      switch (scenario) {
        case 'cold-start':
          startColdStartScenario();
          break;
        case 'valve-maintenance':
          startValveMaintenanceScenario();
          break;
        case 'pump-performance':
          startPumpPerformanceScenario();
          break;
        default:
          showInlineNotification('Unknown scenario: ' + scenario, 'error');
      }
    }
    
    // Cold start scenario
    function startColdStartScenario() {
      showInlineNotification('Starting Cold Start Scenario...', 'info');
      
      // Set cold start conditions
      simulationData.maintenanceMode = 'cold-start';
      simulationData.processVariable = 15;
      simulationData.setpoint = 50;
      
      // Update mode selection
      const coldStartRadio = document.querySelector('input[name="maintenance-mode"][value="cold-start"]');
      if (coldStartRadio) coldStartRadio.checked = true;
      
      // Start simulation with cold start parameters
      updatePIDSimulation();
      showInlineNotification('Cold start scenario active - observe system recovery time', 'success');
    }
    
    // Valve maintenance scenario
    function startValveMaintenanceScenario() {
      showInlineNotification('Starting Valve Maintenance Scenario...', 'info');
      
      // Simulate valve wear
      simulationData.valveBlockage = 0.4; // 40% blockage
      simulationData.maintenanceMode = 'maintenance';
      
      // Update valve blockage slider
      const valveBlockage = document.getElementById('valve-blockage');
      if (valveBlockage) {
        valveBlockage.value = 40;
        document.getElementById('valve-blockage-value').textContent = '40%';
      }
      
      updateDisturbanceEffects();
      showInlineNotification('Valve maintenance scenario active - observe performance degradation', 'warning');
    }
    
    // Pump performance scenario
    function startPumpPerformanceScenario() {
      showInlineNotification('Starting Pump Performance Scenario...', 'info');
      
      // Simulate pump wear over time
      let wearLevel = 0;
      const wearInterval = setInterval(() => {
        wearLevel += 0.01;
        simulationData.pumpWear = Math.min(0.5, wearLevel);
        
        // Update pump wear slider
        const pumpWear = document.getElementById('pump-wear');
        if (pumpWear) {
          pumpWear.value = simulationData.pumpWear * 100;
          document.getElementById('pump-wear-value').textContent = (simulationData.pumpWear * 100).toFixed(0) + '%';
        }
        
        updateDisturbanceEffects();
        
        if (simulationData.pumpWear >= 0.5) {
          clearInterval(wearInterval);
          showInlineNotification('Pump performance scenario complete - significant wear detected', 'warning');
        }
      }, 1000);
      
      showInlineNotification('Pump performance scenario active - monitoring wear progression', 'info');
    }
    
    // Update enhanced performance metrics
    function updateEnhancedMetrics() {
      // Update system health
      const systemHealth = document.getElementById('system-health');
      if (systemHealth) {
        systemHealth.textContent = simulationData.systemHealth;
        systemHealth.style.color = simulationData.systemHealth === 'Excellent' ? '#4CAF50' : 
                                  simulationData.systemHealth === 'Good' ? '#8BC34A' :
                                  simulationData.systemHealth === 'Fair' ? '#FF9800' : '#F44336';
      }
      
      // Update maintenance due
      const maintenanceDue = document.getElementById('maintenance-due');
      if (maintenanceDue) {
        maintenanceDue.textContent = simulationData.maintenanceDue + ' days';
        maintenanceDue.style.color = simulationData.maintenanceDue > 20 ? '#4CAF50' : 
                                    simulationData.maintenanceDue > 10 ? '#FF9800' : '#F44336';
      }
      
      // Update assessment metrics
      updateAssessmentMetrics();
    }
    
    // Update assessment metrics
    function updateAssessmentMetrics() {
      // Calculate PID performance based on error
      const error = Math.abs(simulationData.setpoint - simulationData.processVariable);
      if (error < 1) {
        simulationData.pidPerformance = 'Optimal';
      } else if (error < 3) {
        simulationData.pidPerformance = 'Good';
      } else if (error < 5) {
        simulationData.pidPerformance = 'Fair';
      } else {
        simulationData.pidPerformance = 'Poor';
      }
      
      // Calculate system stability
      const totalDisturbance = simulationData.valveBlockage + simulationData.pumpWear + (Math.abs(simulationData.sensorDrift) / 10);
      if (totalDisturbance < 0.1) {
        simulationData.systemStability = 'Stable';
      } else if (totalDisturbance < 0.3) {
        simulationData.systemStability = 'Moderate';
      } else {
        simulationData.systemStability = 'Unstable';
      }
      
      // Calculate response quality
      const responseTime = simulationData.riseTime;
      if (responseTime < 2) {
        simulationData.responseQuality = 'Excellent';
      } else if (responseTime < 5) {
        simulationData.responseQuality = 'Good';
      } else if (responseTime < 10) {
        simulationData.responseQuality = 'Fair';
      } else {
        simulationData.responseQuality = 'Poor';
      }
      
      // Calculate fault tolerance
      const faultTolerance = 1 - totalDisturbance;
      if (faultTolerance > 0.8) {
        simulationData.faultTolerance = 'High';
      } else if (faultTolerance > 0.6) {
        simulationData.faultTolerance = 'Medium';
      } else {
        simulationData.faultTolerance = 'Low';
      }
      
      // Update display
      const pidPerformance = document.getElementById('pid-performance');
      const systemStability = document.getElementById('system-stability');
      const responseQuality = document.getElementById('response-quality');
      const faultToleranceElement = document.getElementById('fault-tolerance');
      
      if (pidPerformance) pidPerformance.textContent = simulationData.pidPerformance;
      if (systemStability) systemStability.textContent = simulationData.systemStability;
      if (responseQuality) responseQuality.textContent = simulationData.responseQuality;
      if (faultToleranceElement) faultToleranceElement.textContent = simulationData.faultTolerance;
    }
  </script>
  <script>
    // Apply user theme from localStorage
    (function() {
      const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
      if (settings.appBackground) document.documentElement.style.setProperty('--background-color', settings.appBackground);
      if (settings.appAccent) document.documentElement.style.setProperty('--accent-color', settings.appAccent);
      
      // Apply theme class
      if (settings.theme) {
        document.body.className = document.body.className.replace(/theme-\w+/g, '');
        document.body.classList.add(`theme-${settings.theme}`);
      }
      
      // Apply font size
      if (settings.fontSize) {
        document.body.className = document.body.className.replace(/font-size-\w+/g, '');
        document.body.classList.add(`font-size-${settings.fontSize}`);
      }
    })();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('service-worker.js');
      });
    }
  </script>
      <script>
      // Disable problematic service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for (let registration of registrations) {
            registration.unregister();
          }
        });
      }
    </script>
    <script src="image-fallback.js"></script>
    <script src="error-handler.js"></script>
    <script src="emergency-stop-simulation.js"></script>
  <script src="status-led-simulation.js"></script>
  <script src="plc-simulation.js"></script>
  <script src="hmi-simulation.js"></script>
  <script src="pump-simulation.js"></script>
  <script src="valve-simulation.js"></script>
  <script src="float-switch-simulation.js"></script>
  <script src="maintenance-procedures.js"></script>
  <script src="industrial-maintenance-scenario.js"></script>
</body>
</html> 