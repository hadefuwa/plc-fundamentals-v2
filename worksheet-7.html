<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matrix TSL - Proximity Switch</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="assets/icons/matrix-icon.ico">    <script src="worksheet-core.js"></script>
<script src="worksheet-tracking.js"></script>
  <script defer src="shared-navigation.js"></script>
  <script defer src="pwa-install.js"></script>

</head>
<body>


  <div class="worksheet-box">
    <!-- Integrated Worksheet Header -->
    <div class="worksheet-header">
      <div class="worksheet-header-content">
        <div class="worksheet-header-left">
          <button class="worksheet-nav-btn worksheet-back-btn" onclick="window.location.href='worksheet-6.html'">
            <i class="fas fa-arrow-left"></i>
            <span>Previous Worksheet</span>
          </button>
        </div>
        <div class="worksheet-header-center">
          <h1 class="worksheet-title">Worksheet 7 - Proximity Switch</h1>
        </div>
        <div class="worksheet-header-right">
          <button class="worksheet-nav-btn worksheet-next-btn" onclick="window.location.href='worksheet-8.html'">
            <span>Next Worksheet</span>
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="worksheet-section introduction-section">
      <h2 class="section-header"><i class="fas fa-info-circle"></i> 1. Introduction</h2>
      <div class="worksheet-content">
        <div class="introduction-content-wrapper">
          <div class="introduction-text">
            <p>A proximity switch detects an object's presence without contact, making it ideal for automation, positioning and safety systems. Maintenance engineers should know how they work to troubleshoot misalignments or faults, otherwise false triggers can cause machine stoppages or safety hazards. We use inductive sensors to detect metal objects.</p>
          </div>
          <div class="introduction-image">
            <div class="system-diagram">
              <img src="assets/maintenance/valve.png" alt="Valve System Maintenance">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Over To You Section -->
    <div class="worksheet-section over-to-you-section">
      <h2 class="section-header"><i class="fas fa-hands-helping"></i> 2. Over To You</h2>
      <div class="worksheet-content">
        <p><strong>Follow these steps to use the inductive proximity sensor:</strong></p>

        <div class="steps-container">
          <div class="step-card" data-step="1">
            <div class="step-number">1</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Open Worksheet 7</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Navigate to Worksheet 7 on the HMI. Locate the proximity sensor (I6) on your training rig. Ensure it is not triggered (LED off on sensor and HMI).</p>
            </div>
          </div>

          <div class="step-card" data-step="2">
            <div class="step-number">2</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Start and Lock</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Press Raise to lift the press from 0 mm to 15000 mm. Press Lock to begin the locking sequence. A fault will appear because the system did not detect the locking pins as engaged.</p>
            </div>
          </div>

          <div class="step-card" data-step="3">
            <div class="step-number">3</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Use Metal Target</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Reset, repeat the locking step, and this time place a metal object in front of the proximity sensor to simulate detection of the locking pins.</p>
            </div>
          </div>

          <div class="step-card" data-step="4">
            <div class="step-number">4</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Observe Result</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Observe what happens to the red locking pins at the top of the press when the sensor is triggered.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- So What Section -->
    <div class="worksheet-section so-what-section">
      <h2 class="section-header"><i class="fas fa-lightbulb"></i> 3. So What?</h2>
      <div class="so-what-content">
        <div class="explanation-card">
          <div class="card-header">
            <i class="fas fa-cogs"></i>
            <h3>Why this matters</h3>
          </div>
          <div class="card-content">
            <p>Proximity switches detect the presence of metal objects without physical contact, making them crucial for safety and reliability. In the forging press example, the sensor confirms that locking pins are engaged. If not detected, the system faults and stops to prevent unsafe movement.</p>
          </div>
        </div>
      </div>

    </div>

    <!-- Key Takeaways Section -->
    <div class="worksheet-section key-takeaways-section">
      <h2 class="section-header"><i class="fas fa-list-check"></i> Key Takeaways</h2>
      <ul>
        <li>Inductive sensors detect metal only; capacitive and photoelectric serve other materials/methods.</li>
        <li>Used for guards, access points, and position checks in safety interlocks.</li>
        <li>Misalignment and wiring faults cause false signals—verify with a metal target during tests.</li>
        <li>Correct mounting and regular checks ensure reliable operation.</li>
      </ul>
    </div>

    <div class="worksheet-section questions-section">
      <h2 class="section-header"><i class="fas fa-question-circle"></i> Questions & Answers</h2>
      <div class="questions-content">
        <div class="question-item" data-question="1">
          <h4>Question 1: What is the main function of a valve in an industrial system?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-1" value="A" class="option-radio">
              <span class="option-text">A) To control the flow of fluids by opening, closing, or partially restricting the passage through the system</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="B" class="option-radio">
              <span class="option-text">B) To measure the pressure of the fluid</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="C" class="option-radio">
              <span class="option-text">C) To generate power for the system</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="D" class="option-radio">
              <span class="option-text">D) To filter the fluid</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(1)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> A) To control the flow of fluids by opening, closing, or partially restricting the passage through the system.
          </div>
        </div>
        
        <div class="question-item" data-question="2">
          <h4>Question 2: How is the valve position controlled in this system?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-2" value="A" class="option-radio">
              <span class="option-text">A) By using Pulse Width Modulation (PWM) to vary voltage, which proportionally adjusts how open or closed the valve is</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="B" class="option-radio">
              <span class="option-text">B) By manually turning a handle</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="C" class="option-radio">
              <span class="option-text">C) By changing the fluid temperature</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="D" class="option-radio">
              <span class="option-text">D) By adjusting the pump speed</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(2)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> D) By adjusting the pump speed.
          </div>
        </div>
        
        <div class="question-item" data-question="3">
          <h4>Question 3: What is meant by the term "deadband" in valve control?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-3" value="A" class="option-radio">
              <span class="option-text">A) Deadband refers to the range (typically 0–10% demand) where the valve remains shut and doesn't begin opening until demand exceeds this threshold</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="B" class="option-radio">
              <span class="option-text">B) Deadband is the maximum opening of the valve</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="C" class="option-radio">
              <span class="option-text">C) Deadband is the minimum flow rate</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="D" class="option-radio">
              <span class="option-text">D) Deadband is the valve's response time</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(3)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> B) Deadband is the maximum opening of the valve.
          </div>
        </div>
        
        <div class="question-item" data-question="4">
          <h4>Question 4: What should you do to check if a valve is active during operation?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-4" value="A" class="option-radio">
              <span class="option-text">A) Carefully feel for warmth on the valve's electrical connector, it typically gets warm when active (never check for leaks by hand)</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-4" value="B" class="option-radio">
              <span class="option-text">B) Touch the valve body directly</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-4" value="C" class="option-radio">
              <span class="option-text">C) Listen for noise from the valve</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-4" value="D" class="option-radio">
              <span class="option-text">D) Check the valve's color</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(4)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> C) Listen for noise from the valve.
          </div>
        </div>
        
        <div class="question-item" data-question="5">
          <h4>Question 5: Why is it important to observe valve behaviour during an Emergency Stop?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-5" value="A" class="option-radio">
              <span class="option-text">A) To ensure the valve fails to the correct position (open or closed) for safety, in this system, it should go fully closed</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-5" value="B" class="option-radio">
              <span class="option-text">B) To see if the valve makes noise</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-5" value="C" class="option-radio">
              <span class="option-text">C) To check if the valve changes color</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-5" value="D" class="option-radio">
              <span class="option-text">D) To measure the valve's temperature</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(5)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> B) To see if the valve makes noise.
          </div>
        </div>
      </div>
    </div>

    <!-- Simulation Section -->
    <div class="simulation-section">
      <h2 class="section-header"><i class="fas fa-cogs"></i> 3. Interactive Valve System Maintenance</h2>
      
      <!-- On/Off Valve Simulation -->
      <div class="simulation-subsection">
        <h3><i class="fas fa-toggle-on"></i> On/Off Valve Control</h3>
        <div class="valve-simulation-container" style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; margin: 20px 0;">
          <!-- Valve Control Panel -->
          <div class="valve-control-panel" style="background: #2a2a2a; padding: 20px; border-radius: 12px; border: 1px solid #333;">
            <h4 style="color: #2196F3; margin-top: 0;">Valve Controls</h4>
            <div style="margin: 20px 0;">
              <button id="start-onoff-pump" class="control-btn" style="background: #4CAF50; color: white; border: none; padding: 15px 30px; border-radius: 5px; width: 100%; font-size: 16px; margin-bottom: 10px;">Start Pump</button>
              <button id="stop-onoff-pump" class="control-btn" style="background: #FF5722; color: white; border: none; padding: 15px 30px; border-radius: 5px; width: 100%; font-size: 16px; margin-bottom: 20px;">Stop Pump</button>
              <button id="toggle-valve" class="control-btn" style="background: #2196F3; color: white; border: none; padding: 15px 30px; border-radius: 5px; width: 100%; font-size: 16px;">Open Valve</button>
            </div>
            <div class="valve-status" style="margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 5px;">
              <p style="margin: 0; color: #aaa;">Pump: <span id="pump-state" style="color: #FF5722;">Stopped</span></p>
              <p style="margin: 10px 0; color: #aaa;">Valve: <span id="valve-state" style="color: #FF5722;">Closed</span></p>
              <p style="margin: 0; color: #aaa;">Flow Rate: <span id="flow-rate" style="color: #4CAF50;">0 L/min</span></p>
            </div>
          </div>
          <!-- Flow Rate Chart -->
          <div style="background: #2a2a2a; padding: 20px; border-radius: 12px; border: 1px solid #333;">
            <canvas id="onoff-valve-chart" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Proportional Valve Simulation -->
      <div class="simulation-subsection" style="margin-top: 40px;">
        <h3><i class="fas fa-sliders"></i> Proportional Valve Control</h3>
        <div class="valve-simulation-container" style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; margin: 20px 0;">
          <!-- Valve Control Panel -->
          <div class="valve-control-panel" style="background: #2a2a2a; padding: 20px; border-radius: 12px; border: 1px solid #333;">
            <h4 style="color: #4CAF50; margin-top: 0;">Valve Position Control</h4>
            <div style="margin: 20px 0;">
              <button id="start-prop-pump" class="control-btn" style="background: #4CAF50; color: white; border: none; padding: 15px 30px; border-radius: 5px; width: 100%; font-size: 16px; margin-bottom: 10px;">Start Pump</button>
              <button id="stop-prop-pump" class="control-btn" style="background: #FF5722; color: white; border: none; padding: 15px 30px; border-radius: 5px; width: 100%; font-size: 16px; margin-bottom: 20px;">Stop Pump</button>
              <label style="color: #aaa; display: block; margin-bottom: 10px;">Valve Opening (%)</label>
              <input type="range" id="valve-position" min="0" max="100" value="0" 
                     style="width: 100%; height: 10px; border-radius: 5px; -webkit-appearance: none; background: linear-gradient(to right, #4CAF50 0%, #4CAF50 0%, #333 0%, #333 100%); cursor: pointer;">
              <style>
                #valve-position::-webkit-slider-thumb {
                  -webkit-appearance: none;
                  appearance: none;
                  width: 20px;
                  height: 20px;
                  border-radius: 50%;
                  background: #4CAF50;
                  border: 2px solid #fff;
                  cursor: pointer;
                  box-shadow: 0 0 5px rgba(0,0,0,0.3);
                }
                #valve-position::-moz-range-thumb {
                  width: 20px;
                  height: 20px;
                  border-radius: 50%;
                  background: #4CAF50;
                  border: 2px solid #fff;
                  cursor: pointer;
                  box-shadow: 0 0 5px rgba(0,0,0,0.3);
                }
                #valve-position:focus {
                  outline: none;
                }
              </style>
              <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                <span style="color: #666;">0%</span>
                <span id="position-value" style="color: #4CAF50;">0%</span>
                <span style="color: #666;">100%</span>
              </div>
            </div>
            <div class="valve-status" style="margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 5px;">
              <p style="margin: 0; color: #aaa;">Pump: <span id="prop-pump-state" style="color: #FF5722;">Stopped</span></p>
              <p style="margin: 10px 0; color: #aaa;">Position: <span id="prop-valve-state" style="color: #4CAF50;">0%</span></p>
              <p style="margin: 0; color: #aaa;">Flow Rate: <span id="prop-flow-rate" style="color: #4CAF50;">0 L/min</span></p>
            </div>
          </div>
          <!-- Flow Rate Chart -->
          <div style="background: #2a2a2a; padding: 20px; border-radius: 12px; border: 1px solid #333;">
            <canvas id="prop-valve-chart" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Valve Sequencing Simulation -->
      <div class="simulation-subsection" style="margin-top: 40px;">
        <h3><i class="fas fa-list-ol"></i> Valve Sequencing</h3>
        <div class="sequence-simulation-container" style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; margin: 20px 0;">
          <!-- Sequence Control Panel -->
          <div class="sequence-control-panel" style="background: #2a2a2a; padding: 20px; border-radius: 12px; border: 1px solid #333;">
            <h4 style="color: #9C27B0; margin-top: 0;">Cylinder Control Sequence</h4>
            <div style="margin: 20px 0;">
              <button id="start-sequence" class="control-btn" style="background: #9C27B0; color: white; border: none; padding: 15px 30px; border-radius: 5px; width: 100%; font-size: 16px; margin-bottom: 10px;">Start Sequence</button>
              <button id="reset-sequence" class="control-btn" style="background: #666; color: white; border: none; padding: 15px 30px; border-radius: 5px; width: 100%; font-size: 16px;">Reset</button>
            </div>
            <div class="sequence-status" style="margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 5px;">
              <p style="margin: 0; color: #aaa;">Current Step: <span id="sequence-step" style="color: #9C27B0;">Ready</span></p>
              <p style="margin: 10px 0 0 0; color: #aaa;">Cylinder Position: <span id="cylinder-position" style="color: #9C27B0;">0%</span></p>
            </div>
            <!-- Valve States -->
            <div style="margin-top: 20px;">
              <h5 style="color: #aaa; margin: 0 0 10px 0;">Valve States:</h5>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <div class="valve-indicator" style="padding: 10px; background: #1a1a1a; border-radius: 5px; text-align: center;">
                  <span style="color: #aaa;">V1: </span>
                  <span id="v1-state" style="color: #FF5722;">Closed</span>
                </div>
                <div class="valve-indicator" style="padding: 10px; background: #1a1a1a; border-radius: 5px; text-align: center;">
                  <span style="color: #aaa;">V2: </span>
                  <span id="v2-state" style="color: #FF5722;">Closed</span>
                </div>
                <div class="valve-indicator" style="padding: 10px; background: #1a1a1a; border-radius: 5px; text-align: center;">
                  <span style="color: #aaa;">V3: </span>
                  <span id="v3-state" style="color: #FF5722;">Closed</span>
                </div>
                <div class="valve-indicator" style="padding: 10px; background: #1a1a1a; border-radius: 5px; text-align: center;">
                  <span style="color: #aaa;">V4: </span>
                  <span id="v4-state" style="color: #FF5722;">Closed</span>
                </div>
              </div>
            </div>
          </div>
          <!-- Cylinder Position Chart -->
          <div style="background: #2a2a2a; padding: 20px; border-radius: 12px; border: 1px solid #333;">
            <canvas id="sequence-chart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </div>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="valve-simulation.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const initFunc = 'initializeValveSimulation';
      setTimeout(() => {
        if (typeof window[initFunc] === 'function') {
          console.log('Initializing', initFunc);
          window[initFunc]();
        } else {
          document.querySelector('.simulation-loading').innerHTML = '<p>Simulation ready - Valve System Maintenance</p>';
        }
      }, 1000);
      loadSavedAnswers();
    });
    
        function submitAnswer(questionNumber) {
          const answerInput = document.querySelector(`[data-question="${questionNumber}"]`);
          if (!answerInput) return;
          
          const selectedOption = document.querySelector(`input[name="question-${questionNumber}"]:checked`);
          if (!selectedOption) {
            alert('Please select an answer before submitting.');
            return;
          }
          
          const answer = selectedOption.value;
          
          // Save with enhanced tracking
          worksheetTracker.saveAnswer(7, questionNumber, answer, 'maintenance');
          
          // Define correct answers for worksheet 7
          const correctAnswers = {
                "1": "A",
                "2": "D",
                "3": "B",
                "4": "C",
                "5": "B"
          };
          
          // Apply visual feedback
          const allOptions = answerInput.querySelectorAll('.option-label');
          const correctAnswer = correctAnswers[questionNumber];
          
          allOptions.forEach(option => {
            const radio = option.querySelector('.option-radio');
            const optionValue = radio.value;
            
            if (optionValue === correctAnswer) {
              option.classList.add('correct');
            } else if (optionValue === answer && answer !== correctAnswer) {
              option.classList.add('incorrect');
            }
          });
          
          // Mark question as submitted to disable further interaction
          answerInput.classList.add('submitted');
          
          // Show feedback on button
          const submitBtn = answerInput.querySelector('.submit-question-btn');
          if (submitBtn) {
            const originalText = submitBtn.textContent;
            submitBtn.textContent = answer === correctAnswer ? 'Correct!' : 'Incorrect!';
            submitBtn.style.background = answer === correctAnswer ? '#4CAF50' : '#f44336';
            
            // Add incorrect class for enhanced styling
            if (answer !== correctAnswer) {
              submitBtn.classList.add('incorrect');
            }
            
            setTimeout(() => {
              submitBtn.textContent = originalText;
              submitBtn.style.background = '#4CAF50';
              submitBtn.classList.remove('incorrect');
            }, 2000);
          }
          
          // Show correct answer if available
          const correctAnswerDiv = answerInput.querySelector('.correct-answer');
          if (correctAnswerDiv) {
            correctAnswerDiv.style.display = 'block';
          }
        }
    function loadSavedAnswers() {
      // This function is now handled by the tracking system
    }
  </script>
  
  <!-- Bottom Navigation -->
  <div class="worksheet-bottom-nav">
    <div class="worksheet-header-content">
      <div class="worksheet-header-left">
        <button class="worksheet-nav-btn worksheet-back-btn" onclick="window.location.href='worksheet-6.html'">
          <i class="fas fa-arrow-left"></i>
          <span>Previous Worksheet</span>
        </button>
      </div>
       <div class="worksheet-header-center">
       <h1 class="worksheet-title">Worksheet 7 - Proximity Switch</h1>
      </div>
      <div class="worksheet-header-right">
        <button class="worksheet-nav-btn worksheet-next-btn" onclick="window.location.href='worksheet-8.html'">
          <span>Next Worksheet</span>
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
  
<script>

// Enhanced answer handling functions
function submitAnswer(questionNumber) {
  const answerInput = document.querySelector(`[data-question="${questionNumber}"]`);
  if (!answerInput) return;
  
  const selectedOption = document.querySelector(`input[name="question-${questionNumber}"]:checked`);
  if (!selectedOption) {
    alert('Please select an answer before submitting.');
    return;
  }
  
  const answer = selectedOption.value;
  
  // Save with enhanced tracking if available
  if (typeof worksheetTracker !== 'undefined') {
    const worksheetId = getUrlParameter('id') || getWorksheetIdFromUrl();
    const path = window.location.pathname;
    const isFaultScenario = path.includes('fault-scenario');
    const type = getUrlParameter('type') || (isFaultScenario ? 'fault' : 'maintenance');
    worksheetTracker.saveAnswer(worksheetId, questionNumber, answer, type);
  } else {
    saveAnswer(questionNumber, answer);
  }
  
  // Get correct answer from the correct-answer div
  const correctAnswerDiv = answerInput.querySelector('.correct-answer');
  let correctAnswerText = '';
  if (correctAnswerDiv) {
    const strongElement = correctAnswerDiv.querySelector('strong');
    if (strongElement) {
      correctAnswerText = strongElement.nextSibling.textContent.trim();
    }
  }
  
  // Determine if answer is correct (extract letter from correct answer)
  const correctLetter = correctAnswerText.match(/^[A-D]/);
  const isCorrect = correctLetter && answer === correctLetter;
  
  // Style the selected option
  const allOptions = answerInput.querySelectorAll('.option-label');
  allOptions.forEach(option => {
    option.classList.remove('correct', 'incorrect');
  });
  
  if (isCorrect) {
    selectedOption.closest('.option-label').classList.add('correct');
  } else {
    selectedOption.closest('.option-label').classList.add('incorrect');
    // Also mark the correct option as correct
    const correctOption = answerInput.querySelector(`input[name="question-${questionNumber}"][value="${correctLetter}"]`);
    if (correctOption) {
      correctOption.closest('.option-label').classList.add('correct');
    }
  }
  
  const submitBtn = answerInput.querySelector('.submit-question-btn');
  if (submitBtn) {
    submitBtn.textContent = isCorrect ? 'Correct!' : 'Incorrect';
    submitBtn.style.background = isCorrect ? '#4CAF50' : '#f44336';
    setTimeout(() => {
      submitBtn.textContent = 'Submit Answer';
      submitBtn.style.background = '#4CAF50';
    }, 2000);
  }
  
  // Show correct answer
  if (correctAnswerDiv) {
    correctAnswerDiv.style.display = 'block';
  }
}


// Enhanced step tracking functions
function initializeStepTracking() {
  console.log('Initializing step tracking...');
  
  // Wait a bit to ensure DOM is ready
  setTimeout(() => {
    const stepCards = document.querySelectorAll('.step-card');
    console.log('Found', stepCards.length, 'step cards');
    
    stepCards.forEach((card, index) => {
      const checkbox = card.querySelector('.step-complete-checkbox');
      const stepNumber = card.getAttribute('data-step') || (index + 1);
      
      console.log('Setting up card', stepNumber, 'with checkbox:', !!checkbox);
      
      if (checkbox) {
        // Load saved state
        const savedState = localStorage.getItem(`step-${stepNumber}`);
        if (savedState === 'true') {
          checkbox.checked = true;
          card.classList.add('step-completed');
        }
        
        // Make the entire card clickable
        card.style.cursor = 'pointer';
        
        // Add click handler to the entire card
        card.addEventListener('click', function(e) {
          console.log('Card clicked:', stepNumber);
          
          // Don't toggle if clicking directly on the checkbox
          if (e.target === checkbox || e.target.closest('.step-checkbox')) {
            return;
          }
          
          // Toggle the checkbox
          checkbox.checked = !checkbox.checked;
          
          // Trigger change event
          const changeEvent = new Event('change', { bubbles: true });
          checkbox.dispatchEvent(changeEvent);
          
          console.log('Checkbox toggled to:', checkbox.checked);
        });
        
        // Add change handler to checkbox
        checkbox.addEventListener('change', function() {
          console.log('Checkbox changed:', stepNumber, 'checked:', checkbox.checked);
          
          if (checkbox.checked) {
            card.classList.add('step-completed');
            localStorage.setItem(`step-${stepNumber}`, 'true');
          } else {
            card.classList.remove('step-completed');
            localStorage.setItem(`step-${stepNumber}`, 'false');
          }
        });
        
        // Also make the checkbox itself clickable
        checkbox.addEventListener('click', function(e) {
          e.stopPropagation(); // Prevent card click when clicking checkbox
        });
      }
    });
  }, 100);
}

// Initialize when page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeStepTracking);
} else {
  // DOM is already loaded
  initializeStepTracking();
}

// Also try again after a short delay to ensure everything is ready
setTimeout(initializeStepTracking, 500);


</script>
</body>
</html> 